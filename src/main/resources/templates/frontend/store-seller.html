<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>賣家管理中心 | PetGuardian</title>
    <link rel="stylesheet" th:href="@{/css/frontend/style.css}">
    <link rel="stylesheet" th:href="@{/css/frontend/components.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/frontend/store-seller.css}">
</head>

<body>
<header id="main-header" class="header"></header>

<div class="container" style="margin-top: 2rem;">
    <div class="d-flex justify-between align-center mb-2">
        <h2>賣家管理中心</h2>
    </div>



    <div class="d-flex" style="gap: 1.5rem; align-items: flex-start;">
        <!-- 側邊欄 -->
        <div class="seller-sidebar" style="flex: 0 0 250px;">
            <h3 style="margin-bottom: 1rem;">功能選單</h3>
            <nav>
                <a href="/seller/dashboard" class="seller-menu-item"
                   th:classappend="${currentView == 'overview' ? 'active' : ''}">
                    <i class="fas fa-chart-pie"></i> 營運概況
                </a>
                <a href="/seller/products" class="seller-menu-item"
                   th:classappend="${currentView == 'products' ? 'active' : ''}">
                    <i class="fas fa-box-open"></i> 商品管理
                </a>
                <a href="/seller/orders" class="seller-menu-item"
                   th:classappend="${currentView == 'orders' ? 'active' : ''}">
                    <i class="fas fa-clipboard-list"></i> 訂單管理
                </a>
                <a href="/store" class="seller-menu-item"
                   style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                    <i class="fas fa-shopping-bag"></i> 返回商城
                </a>
            </nav>
        </div>

        <!-- 主要內容區 -->
        <div style="flex: 1;">

            <!-- 成功訊息 -->
            <div th:if="${successMessage}" class="alert"
                 style="background: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
            </div>

            <!-- 錯誤訊息 -->
            <div th:if="${error}" class="alert"
                 style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
            </div>

            <!-- ========== 營運概況 ========== -->
            <div th:if="${currentView == 'overview'}">
                <h3 class="mb-2">營運概況</h3>
                <div class="d-flex gap-md mb-4" style="flex-wrap: wrap;">
                    <!-- 商品總數 -->
                    <div class="stat-card" style="flex: 1; min-width: 180px;" onclick="location.href='/seller/products'">
                        <div class="stat-number" style="color: var(--primary-color);" th:text="${totalProducts}">0</div>
                        <p style="color: #868e96; font-weight:500;">商品總數</p>
                    </div>

                    <!-- 上架中 -->
                    <div class="stat-card" style="flex: 1; min-width: 180px;" onclick="location.href='/seller/products'">
                        <div class="stat-number" style="color: #51cf66;" th:text="${activeProducts}">0</div>
                        <p style="color: #868e96; font-weight:500;">上架中</p>
                    </div>

                    <!-- 訂單總數 -->
                    <div class="stat-card" style="flex: 1; min-width: 180px;" onclick="location.href='/seller/orders'">
                        <div class="stat-number" style="color: #495057;" th:text="${totalOrders}">0</div>
                        <p style="color: #868e96; font-weight:500;">訂單總數</p>
                    </div>

                    <!-- 待出貨 -->
                    <div class="stat-card" style="flex: 1; min-width: 180px;" onclick="location.href='/seller/orders'">
                        <div class="stat-number" style="color: #fa5252;" th:text="${pendingOrders}">0</div>
                        <p style="color: #868e96; font-weight:500;">待出貨</p>
                    </div>

                    <!-- ✨ 平均評分 (總星星/總評論) -->
                    <div class="stat-card" style="flex: 1; min-width: 180px;" onclick="toggleReviewsList()">
                        <div class="stat-number" style="color: #f59e0b;">
                            <span th:text="${totalRatingScore}">0</span>
                            <span style="font-size: 0.5em; color: #999;"> / </span>
                            <span th:text="${totalReviews}">0</span>
                        </div>
                        <p style="color: #868e96; font-weight:500;">
                            <i class="fas fa-star" style="color: #ffc107;"></i> 平均評分
                            <span style="font-size: 0.8em; display: block; margin-top: 4px;">
                                (<span th:text="${averageRating}">0.0</span>/5.0)
                            </span>
                        </p>
                    </div>

                    <!-- ✨ 總評論數 -->
                    <div class="stat-card" style="flex: 1; min-width: 180px;" onclick="toggleReviewsList()">
                        <div class="stat-number" style="color: #8b5cf6;" th:text="${totalReviews}">0</div>
                        <p style="color: #868e96; font-weight:500;">
                            <i class="fas fa-comment"></i> 總評論數
                        </p>
                    </div>

                    <!-- ✨ 錢包餘額 -->
                    <div class="stat-card" style="flex: 1; min-width: 180px;">
                        <div class="stat-number" style="color: #339af0;">
                            $<span th:text="${#numbers.formatInteger(walletBalance, 0, 'COMMA')}">0</span>
                        </div>
                        <p style="color: #868e96; font-weight:500;">
                            <i class="fas fa-wallet"></i> 錢包餘額
                        </p>
                    </div>
                </div>

                <!-- ✨ 所有評論列表 (可展開/收合) -->
                <div id="reviewsList" class="card" style="margin-top: 2rem; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0;">
                            <i class="fas fa-star" style="color: #ffc107;"></i> 買家評價
                        </h4>
                        <button onclick="toggleReviewsList()"
                                style="background: none; border: none; color: #999; cursor: pointer; font-size: 1.2rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div th:if="${#lists.isEmpty(allReviews)}"
                         style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-comment-slash" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>目前還沒有評論</p>
                    </div>

                    <div th:if="${!#lists.isEmpty(allReviews)}"
                         style="max-height: 500px; overflow-y: auto;">

                        <div th:each="reviewData : ${allReviews}"
                             style="padding: 1.5rem; border-bottom: 1px solid #f0f0f0;">

                            <!-- 評論標題 -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div>
                                    <strong th:text="${reviewData.buyerName}">買家名稱</strong>
                                    <span style="color: #999; margin-left: 8px; font-size: 0.9rem;">
                                        訂單 #<span th:text="${reviewData.review.orderId}">1</span>
                                    </span>
                                </div>
                                <span style="color: #999; font-size: 0.85rem;"
                                      th:text="${#temporals.format(reviewData.review.reviewTime, 'yyyy-MM-dd HH:mm')}">
                                    2024-01-01 10:00
                                </span>
                            </div>

                            <!-- 評分星星 -->
                            <div style="margin-bottom: 0.75rem;">
                                <span style="color: #ffc107; font-size: 1.1rem;">
                                    <th:block th:each="i : ${#numbers.sequence(1, reviewData.review.rating)}">★</th:block>
                                    <th:block th:each="i : ${#numbers.sequence(1, 5 - reviewData.review.rating)}">☆</th:block>
                                </span>
                                <span style="color: #666; margin-left: 8px; font-size: 0.9rem;">
                                    (<span th:text="${reviewData.review.rating}">5</span>/5)
                                </span>
                            </div>

                            <!-- 評論內容 -->
                            <p style="margin: 0; color: #555; line-height: 1.6;"
                               th:text="${reviewData.review.reviewContent ?: '(買家未留下文字評價)'}">
                                評論內容
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 商品管理 ========== -->
            <div th:if="${currentView == 'products'}">
                <div class="d-flex justify-between align-center mb-2">
                    <h3 class="mb-0">商品管理</h3>
                    <button class="btn btn-primary" onclick="openProductModal()"
                            style="white-space: nowrap; padding: 10px 20px;">
                        <i class="fas fa-plus"></i> 上架新商品
                    </button>
                </div>

                <div class="card" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
                        <thead>
                        <tr>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: left; white-space: nowrap;">商品編號</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: left; white-space: nowrap;">商品類別</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: left;">商品名稱</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: right; white-space: nowrap;">單價</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: center; white-space: nowrap;">庫存</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: center; white-space: nowrap;">狀態</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: center; white-space: nowrap;">上架時間</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: center; white-space: nowrap; min-width: 120px;">操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="product : ${products}">
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0;" th:text="${product.proId}">1</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0;" th:text="${product.proType.proTypeName}">貓貓用品</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0;" th:text="${product.proName}">商品名稱</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: right; font-weight: 600; color: var(--primary-color);"
                                th:text="'$' + ${#numbers.formatInteger(product.proPrice, 0, 'COMMA')}">$1000</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: center;" th:text="${product.stockQuantity}">10</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: center;">
                                <span th:if="${product.proState == 1}" class="badge badge-success">上架中</span>
                                <span th:if="${product.proState == 0}" class="badge badge-secondary">已下架</span>
                            </td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: center;"
                                th:text="${#temporals.format(product.launchedTime, 'yyyy-MM-dd')}">2024-01-01</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: center;">
                                <div style="display: flex; gap: 6px; justify-content: center;">
                                    <button class="btn btn-sm btn-outline"
                                            th:data-id="${product.proId}"
                                            th:data-name="${product.proName}"
                                            th:data-type="${product.proType.proTypeId}"
                                            th:data-price="${product.proPrice}"
                                            th:data-desc="${product.proDescription}"
                                            th:data-stock="${product.stockQuantity}"
                                            th:data-state="${product.proState}"
                                            onclick="editProduct(this)"
                                            title="編輯">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <form th:action="@{/seller/product/delete}" method="post" style="display: inline;"
                                          onsubmit="return confirm('確定刪除？');">
                                        <input type="hidden" name="proId" th:value="${product.proId}">
                                        <button type="submit" class="btn btn-sm btn-outline" style="color: #dc3545;" title="刪除">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ========== 訂單管理 ========== -->
            <div th:if="${currentView == 'orders'}">
                <h3 class="mb-2">訂單管理</h3>

                <div class="card" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
                        <thead>
                        <tr>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: left;">訂單編號</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: left;">買家</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: right;">總金額</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: center;">下單時間</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: center;">狀態</th>
                            <th style="padding: 14px 12px; border-bottom: 2px solid #f0f0f0; text-align: center; ">操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="order : ${orders}">
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0;" th:text="'#' + ${order.orderId}">訂單編號</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0;" th:text="${order.receiverName}">買家</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: right; font-weight: 600; color: var(--primary-color);"
                                th:text="'$' + ${#numbers.formatInteger(order.orderTotal, 0, 'COMMA')}">總金額</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: center;"
                                th:text="${#temporals.format(order.orderTime, 'yyyy-MM-dd HH:mm')}">2024-01-01 10:00</td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0; text-align: center;">
                                <span th:if="${order.orderStatus == 0}" class="badge badge-primary">已付款</span>
                                <span th:if="${order.orderStatus == 1}" class="badge badge-accent">已出貨</span>
                                <span th:if="${order.orderStatus == 2}" class="badge badge-success">已完成</span>
                                <span th:if="${order.orderStatus == 3}" class="badge badge-secondary">已取消</span>
                                <span th:if="${order.orderStatus == 4}" class="badge badge-warning">申請退貨中</span>
                                <span th:if="${order.orderStatus == 5}" class="badge" style="background: #6c757d; color: white;">退貨完成</span>
                            </td>
                            <td style="padding: 14px 12px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">

                                    <!-- ✨ 已付款狀態：已出貨、查看訂單、取消、聊天 -->
                                    <th:block th:if="${order.orderStatus == 0}">
                                        <form th:action="@{/seller/order/ship}" method="post" style="display: inline;">
                                            <input type="hidden" name="orderId" th:value="${order.orderId}">
                                            <button type="submit" class="btn btn-sm btn-primary"
                                                    onclick="return confirm('確認已安排出貨?')" title="已出貨">
                                                <i class="fas fa-shipping-fast"></i>
                                            </button>
                                        </form>

                                        <a th:href="@{/seller/order/{id}(id=${order.orderId})}"
                                           class="btn btn-sm btn-outline" title="查看訂單">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>

                                        <form th:action="@{/seller/order/cancel}" method="post" style="display: inline;">
                                            <input type="hidden" name="orderId" th:value="${order.orderId}">
                                            <button type="submit" class="btn btn-sm btn-outline" style="color: #dc3545;"
                                                    onclick="return confirm('確定要取消訂單並退款給買家?')" title="取消訂單">
                                                <i class="fas fa-times-circle"></i>
                                            </button>
                                        </form>

                                        <a th:href="@{/chat(userId=${order.buyerMemId})}"
                                           class="btn btn-sm btn-outline" style="position: relative;" title="聊天">
                                            <i class="fas fa-comment-dots"></i>
                                            <span style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 2px solid white;"></span>
                                        </a>
                                    </th:block>

                                    <!-- ✨ 已完成狀態：查看訂單、查看評價、聊天 -->
                                    <th:block th:if="${order.orderStatus == 2}">
                                        <a th:href="@{/seller/order/{id}(id=${order.orderId})}"
                                           class="btn btn-sm btn-outline" title="查看訂單">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>

                                        <button th:if="${order.hasReview}"
                                                class="btn btn-sm btn-outline" style="color: #ffc107;"
                                                th:onclick="'showReviewModal(' + ${order.orderId} + ')'" title="查看評價">
                                            <i class="fas fa-star"></i>
                                        </button>

                                        <a th:href="@{/chat(userId=${order.buyerMemId})}"
                                           class="btn btn-sm btn-outline" style="position: relative;" title="聊天">
                                            <i class="fas fa-comment-dots"></i>
                                        </a>
                                    </th:block>

                                    <!-- ✨ 其他狀態：只顯示查看訂單和聊天 -->
                                    <th:block th:if="${order.orderStatus != 0 && order.orderStatus != 2}">
                                        <a th:href="@{/seller/order/{id}(id=${order.orderId})}"
                                           class="btn btn-sm btn-outline" title="查看訂單">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>

                                        <a th:href="@{/chat(userId=${order.buyerMemId})}"
                                           class="btn btn-sm btn-outline" style="position: relative;" title="聊天">
                                            <i class="fas fa-comment-dots"></i>
                                        </a>
                                    </th:block>

                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- 商品 Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">新增商品</h3>
        <form th:action="@{/seller/product/save}" method="post">
            <input type="hidden" id="proId" name="proId">

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">商品名稱</label>
                <input type="text" id="proName" name="proName"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;" required>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">商品類別</label>
                <select id="proTypeId" name="proTypeId"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <option th:each="type : ${proTypes}" th:value="${type.proTypeId}"
                            th:text="${type.proTypeName}">類別</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">價格</label>
                <input type="number" id="proPrice" name="proPrice"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;" required>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">商品描述</label>
                <textarea id="proDescription" name="proDescription" rows="4"
                          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;"></textarea>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">庫存</label>
                <input type="number" id="stockQuantity" name="stockQuantity"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;" required>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">狀態</label>
                <select id="proState" name="proState"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <option value="1">上架</option>
                    <option value="0">下架</option>
                </select>
            </div>

            <div style="text-align: right; margin-top: 10px;">
                <button type="button" class="btn btn-outline" onclick="closeProductModal()">取消</button>
                <button type="submit" class="btn btn-primary">儲存</button>
            </div>
        </form>
    </div>
</div>

<!-- ✨ 評價 Modal -->
<div id="reviewModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0;">買家評價</h3>
            <button onclick="closeReviewModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">
                &times;
            </button>
        </div>

        <div id="reviewContent">
            <!-- 透過 JavaScript 動態載入 -->
        </div>
    </div>
</div>

<footer id="main-footer" style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
<script th:src="@{/js/frontend/main.js}"></script>
<script th:src="@{/js/frontend/seller/seller.js}"></script>
</body>
</html>