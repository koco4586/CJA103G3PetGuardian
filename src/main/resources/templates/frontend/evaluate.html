<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>

    <link rel="stylesheet" th:href="@{/css/frontend/style.css}">
    <link rel="stylesheet" th:href="@{/css/frontend/components.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/frontend/dashboard.css}">

    <style>
        .dynamic-eval-wrapper {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0 20px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fffef2;
            /* å¾®é»ƒè‰²èƒŒæ™¯ */
            border-radius: 15px;
            border: 1px solid transparent;
            /* é è¨­é‚Šæ¡†é€æ˜ */
            width: 100%;
            box-sizing: border-box;
        }

        .dynamic-eval-wrapper.active {
            max-height: 800px;
            /* å±•é–‹é«˜åº¦ */
            opacity: 1;
            margin-top: 15px;
            padding: 20px;
            border: 1px solid #ffeaa7;
            box-shadow: 0 4px 15px rgba(255, 234, 167, 0.3);
        }

        /* æ¨™ç±¤æŒ‰éˆ•æ¨£å¼ */
        .eval-tag {
            display: inline-block;
            padding: 6px 14px;
            margin: 5px;
            background: #fff;
            border: 1px solid #ffeaa7;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #7d5a00;
            transition: all 0.2s;
        }

        .eval-tag.selected {
            background: #ffeaa7;
            font-weight: bold;
        }

        /* ç‹—ç‹—è…³å°é€å‡ºæŒ‰éˆ• */
        .submit-paw-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            float: right;
            transition: transform 0.1s, background 0.2s;
        }

        .submit-paw-btn:active {
            transform: scale(0.92);
            /* é»æ“Šæ™‚çš„æ˜é¡¯ä¸‹å£“æ„Ÿ */
        }

        .submit-paw-btn:hover {
            background: #e67e22;
        }

        /* 3. æ˜Ÿæ˜Ÿçš„éŸ¿æ‡‰å¼å°ºå¯¸ */
        .dynamic-stars {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            /* éš¨é é¢ç¸®æ”¾çš„åŸºç¤ */
            color: #ddd;
            cursor: pointer;
            flex-wrap: wrap;
            /* é é¢å¤ªçª„æ™‚è‡ªå‹•æ›è¡Œ */
        }

        @media (max-width : 768px) {
            .dynamic-stars {
                font-size: 1.2rem;
            }

            /* æ‰‹æ©Ÿç‰ˆè‡ªå‹•ç¸®å°æ˜Ÿæ˜Ÿ */
        }

        .star-btn {
            transition: color 0.2s, transform 0.1s;
        }

        .star-btn:active {
            transform: scale(0.9);
            /* é»æ“Šæ™‚çš„å°å›é¥‹ */
        }

        .rating-text {
            font-size: 0.9rem;
            color: #666;
            margin-left: 0.5rem;
            white-space: nowrap;
            /* é¿å…æ–‡å­—æ–·è¡Œ */
        }

        .report-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: #666;
            cursor: pointer;
            user-select: none;
        }

        .report-btn i {
            font-size: 0.8rem;
        }

        .report-btn:hover {
            color: #c0392b;
        }

        .history-list.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        /* æª¢èˆ‰è¼¸å…¥æ¡†æ¨£å¼ */
        .dynamic-report-wrapper {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0 20px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fff5f5;
            /* å¾®ç´…è‰²èƒŒæ™¯ */
            border-radius: 15px;
            border: 1px solid transparent;
            width: 100%;
            box-sizing: border-box;
        }

        .dynamic-report-wrapper.active {
            max-height: 800px;
            opacity: 1;
            margin-top: 15px;
            padding: 20px;
            border: 1px solid #ffcdd2;
            box-shadow: 0 4px 15px rgba(255, 205, 210, 0.3);
        }

        /* æª¢èˆ‰æ¨™ç±¤æ¨£å¼ */
        .report-tag {
            display: inline-block;
            padding: 6px 14px;
            margin: 5px;
            background: #fff;
            border: 1px solid #ffcdd2;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #c62828;
            transition: all 0.2s;
        }

        .report-tag.selected {
            background: #ffcdd2;
            font-weight: bold;
        }

        /* ç´™é£›æ©Ÿé€å‡ºæŒ‰éˆ• */
        .submit-report-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            float: right;
            transition: transform 0.1s, background 0.2s;
        }

        .submit-report-btn:active {
            transform: scale(0.92);
        }

        .submit-report-btn:hover {
            background: #ff5252;
        }
    </style>
</head>

<body>

    <header id="main-header" class="header"></header>


    <h2 class="section-title">
        <i class="fas fa-star-half-alt"></i> æ­·å²è©•åƒ¹
    </h2>

    <div id="reviewList" class="review-list">
        <div id="noReviewMsg" th:if="${#lists.isEmpty(reviewGroups)}"
            style="text-align: center; padding: 40px; border: 1px dashed #ccc; margin-bottom: 20px; border-radius: 12px; background: #fff;">
            <i class="fas fa-comment-slash" style="font-size: 2rem; color: #ddd;"></i>
            <p style="color: #999;">æš«ç„¡è©•åƒ¹ç´€éŒ„</p>
        </div>

        <div class="history-wrapper">
            <button class="toggle-history">æŸ¥çœ‹å…¨éƒ¨ (10)</button>
            <div class="history-list collapsed">
                <!-- è©•è«–åˆ—è¡¨ -->
            </div>
        </div>
        <div class="order-review-card" th:each="order : ${reviewGroups}"
            th:if="${order != null and order.bookingOrderId != null}"
            style="border: 1px solid #eee; padding: 25px; margin-bottom: 30px; border-radius: 15px; background: #fff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); position: relative;">

            <input type="hidden" class="order-id" th:value="${order.bookingOrderId}"> <input type="hidden"
                class="receiver-id" th:value="${isSitter ? order.memberId : order.sitterId}">

            <div class="order-header"
                style="display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 15px; color: #888; font-size: 0.85rem;">
                <span> <i class="fas fa-receipt"></i> <span th:text="${isSitter ? 'æ”¶åˆ°æœƒå“¡çš„è©•åƒ¹' : 'å‰›å‰›é€å‡ºçš„è©•åƒ¹'}"></span> / è¨‚å–®
                    #<span th:text="${order.bookingOrderId}"></span>
                </span>
                <div class="more-options">
                    <i class="fas fa-ellipsis-h opt-btn"></i>

                </div>
            </div>

            <div class="member-eval-container"
                style="border: 2px solid #2e7d32; padding: 20px; border-radius: 10px; background: #f9fff9; width: 100%; box-sizing: border-box;">
                <input type="hidden" class="evaluate-id" th:value="${order.memberEvaluateId}">
                <div class="eval-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="user-profile">
                        <strong style="font-size: 1.1rem;" th:text="${isSitter ? order.memberName : 'æ‚¨æœ¬äºº'}"></strong>

                        <span class="report-btn">
                            <i class="fas fa-flag"></i> æª¢èˆ‰
                        </span>
                        <span class="avg-stars"
                            style="color: #2e7d32; margin-left: 8px; font-weight: bold; font-size: 0.85rem;">
                            <i class="fas fa-star"></i> <span th:text="${order.memberAvgRating}"></span>
                        </span>
                    </div>
                    <div class="current-rating"
                        style="background: #fff; padding: 4px 10px; border: 1px solid #ddd; border-radius: 20px; font-size: 0.85rem;">
                        çµ¦äºˆæ˜Ÿæ•¸ï¼š<span style="color: #f39c12; font-weight: bold;"><i class="fas fa-star"></i> <span
                                th:text="${order.memberRating}"></span></span>
                    </div>
                </div>

                <div class="content-body" style="margin: 12px 0; font-size: 0.95rem; color: #333; line-height: 1.5;">
                    <p th:text="${order.memberContent}"></p>
                </div>

                <div class="time-stamp" style="text-align: right; color: #888; font-size: 0.75rem;">
                    <i class="far fa-clock"></i> <span th:text="${order.memberCreateTime}"></span>
                </div>


            </div>
        </div>


    </div>




    <script th:inline="javascript">
        /*<![CDATA[*/
        const contextPath = /*[[@{/}]]*/ '';
        /*]]>*/


        // --- å°‡ä½ åŸæœ¬çš„åŠŸèƒ½å°è£æˆé€™å€‹ function ---
        function initStarRating(container) {
            const stars = container.querySelectorAll('.star-btn');
            const ratingText = container.querySelector('.rating-text') || document.getElementById('rating-text');
            let selectedRating = 0;

            stars.forEach(star => {
                // é»æ“Šé‚è¼¯ (ä¿ç•™ä½ åŸæœ¬çš„é»æ“Š/å–æ¶ˆé‚è¼¯)
                star.addEventListener('click', function () {
                    const clickedValue = parseInt(this.getAttribute('data-value'));
                    if (selectedRating === clickedValue) {
                        selectedRating = 0;
                    } else {
                        selectedRating = clickedValue;
                    }
                    updateStars(selectedRating);
                    container.setAttribute('data-rating', selectedRating); // å­˜å…¥åˆ†æ•¸ä¾›é€å‡ºæ™‚è®€å–
                });

                // ç§»å…¥é è¦½ (ä¿ç•™ä½ åŸæœ¬çš„åŠŸèƒ½)
                star.addEventListener('mouseover', function () {
                    updateStars(this.getAttribute('data-value'));
                });
            });


            // ç§»å‡ºæ¢å¾© (ä¿ç•™ä½ åŸæœ¬çš„åŠŸèƒ½)
            container.addEventListener('mouseleave', function () {
                updateStars(selectedRating);
            });

            function updateStars(val) {
                stars.forEach(s => {
                    const v = parseInt(s.getAttribute('data-value'));
                    s.style.color = v <= val ? '#f39c12' : '#ddd';
                });
                if (val > 0) {
                    ratingText.innerText = val + ' é¡†æ˜Ÿ';
                } else {
                    ratingText.innerText = 'è«‹é»æ“Šæ˜Ÿç­‰';
                }
            }
        }


        window.injectEvalBox = function (button, orderId, sitterId) {
            // 1. æ‰¾åˆ°æ•´æ ¼å®¹å™¨ï¼Œç¢ºä¿é»æ“Šå¾Œä¸‹æ–¹çš„æœªçŸ¥ä¿å§†è¡¨æ ¼æœƒå¾€ä¸‹ç§»
            const parentCard = button.closest('order-item') || button.parentElement;

            let evalBox = parentCard.querySelector('.dynamic-eval-wrapper');

            if (evalBox && evalBox.classList.contains('active')) {
                // --- é€™è£¡è™•ç†ã€Œæ”¶åˆã€å‰çš„åˆ¤æ–· ---
                const textarea = evalBox.querySelector('.eval-content');
                if (textarea.value.trim().length > 0) {
                    // å¦‚æœè£¡é¢æœ‰å­—ï¼Œè©¢å•ä½¿ç”¨è€…æ˜¯å¦ç¢ºå®šæ”¶åˆ
                    if (!confirm('æ‚¨çš„è©•åƒ¹å°šæœªé€å‡ºï¼Œç¢ºå®šè¦å…ˆæš«æ™‚æ”¶èµ·ä¾†å—ï¼Ÿ(å…§å®¹å°‡æœƒä¿ç•™)')) {
                        return; // ä½¿ç”¨è€…é»å–æ¶ˆï¼Œä¸åŸ·è¡Œæ”¶åˆ
                    }
                }
                evalBox.classList.remove('active');
                return;
            }
            if (!evalBox) {
                evalBox = document.createElement('div');
                evalBox.className = 'dynamic-eval-wrapper';

                // ç”Ÿæˆå…§å®¹ï¼šåŒ…å«æ˜Ÿæ˜Ÿã€è‡ªå‹•æ¨™ç±¤ã€è¼¸å…¥æ¡†èˆ‡è…³å°æŒ‰éˆ•
                evalBox.innerHTML = `
                    <h4 style="color: #7d5a00; margin-bottom: 15px;">æ‚¨å°ä¿å§†çš„æ»¿æ„åº¦ç‚ºï¼Ÿ</h4>
                    
                    <div class="rating-input dynamic-stars" style="margin-bottom: 15px;">
                        <i class="fas fa-star star-btn" data-value="1"></i>
                        <i class="fas fa-star star-btn" data-value="2"></i>
                        <i class="fas fa-star star-btn" data-value="3"></i>
                        <i class="fas fa-star star-btn" data-value="4"></i>
                        <i class="fas fa-star star-btn" data-value="5"></i>
                        <span class="rating-text" style="font-size: 0.9rem; color: #999; margin-left:10px;">è«‹é»æ“Šæ˜Ÿç­‰</span>
                    </div>

                    <div class="tag-container" style="margin-bottom: 15px;">
                        <span class="eval-tag">æ…‹åº¦å„ªè‰¯</span>
                        <span class="eval-tag">å€¼å¾—ä¿¡è³´</span>
                        <span class="eval-tag">æº–æ™‚ç›¡è²¬</span>
                        <span class="eval-tag">ç´°å¿ƒé«”è²¼</span>
                        <span class="eval-tag">äº’å‹•è‰¯å¥½</span>
                        <span class="eval-tag">å¼·çƒˆæ¨è–¦</span>
                    </div>

                    <textarea class="eval-content" style="width: 100%; height: 80px; border: 1px solid #ffeaa7; border-radius: 8px; padding: 10px; background:#fff;" placeholder="é»æ“Šæ¨™ç±¤æˆ–è¼¸å…¥è©•è«–..."></textarea>
                    
                    <div style="overflow: hidden; margin-top: 15px;">
                        <button class="submit-paw-btn">
                            æäº¤è©•è«– <i class="fas fa-paw"></i>
                        </button>
                    </div>
                `;

                parentCard.appendChild(evalBox);

                // åˆå§‹åŒ–æ˜Ÿæ˜Ÿé‚è¼¯
                initStarRating(evalBox.querySelector('.dynamic-stars'));

                // æ¨™ç±¤é»æ“Šé‚è¼¯ï¼šé»æ“Šå¾Œè‡ªå‹•å¡«å…¥æ–‡å­—æ¡†
                const textarea = evalBox.querySelector('.eval-content');
                evalBox.querySelectorAll('.eval-tag').forEach(tag => {
                    tag.onclick = function () {
                        this.classList.toggle('selected');
                        const selectedTags = Array.from(evalBox.querySelectorAll('.eval-tag.selected'))
                            .map(t => t.innerText).join(', ');
                        textarea.value = selectedTags;
                    };
                });

                // æäº¤å¾Œå‹•ä½œ
                evalBox.querySelector('.submit-paw-btn').onclick = function () {
                    // é€™è£¡åŸ·è¡ŒåŸæœ¬çš„ sendReviewToBackend
                    const rating = evalBox.querySelector('.dynamic-stars').getAttribute('data-rating') || 0;
                    const content = evalBox.querySelector('.eval-content').value;
                    //                     evalBox.classList.remove('active'); // æ¢å¾©åŸç‹€
                    if (rating == 0) return alert('âŒ è«‹å…ˆè©•åˆ†ï¼');
                    if (!content.trim()) return alert('âŒ è«‹è¼¸å…¥å…§å®¹ï¼');

                    sendReviewToBackend(
                        orderId,
                        sitterId,
                        content,
                        0,      // æœƒå“¡è©•ä¿æ¯
                        rating
                    );


                    // window.location.href = '/your-evaluate-page'; // è·³è½‰é é¢


                };
            }
        }



        toggleBtn.onclick = () => {
            historyList.classList.toggle("collapsed");
        }




        // âœ… æ–°å¢é€™å€‹å‡½æ•¸ï¼ˆæ”¾åœ¨ injectEvalBox å¤–é¢ï¼‰
        function sendReviewToBackend(orderId, receiverId, content, roleType, rating) {
            const data = {
                bookingOrderId: orderId,
                receiverId: receiverId,
                content: content,
                roleType: roleType,
                starRating: rating
            };

            let base = typeof contextPath !== 'undefined' ? contextPath : '';
            if (base === '/') base = '';
            fetch(base + '/pet/evaluate/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.text())
                .then(msg => {
                    if (msg === 'success') {
                        let base = typeof contextPath !== 'undefined' ? contextPath : '';
                        if (base === '/') base = '';
                        alert('âœ… è©•åƒ¹å·²é€å‡ºï¼');
                        window.location.href = base + '/pet/evaluate/list#reviewList';
                    } else {
                        alert('âŒ é€å‡ºå¤±æ•—');
                    }
                })
                .catch(err => {
                    console.error('éŒ¯èª¤:', err);
                    alert('âŒ ç™¼ç”ŸéŒ¯èª¤');
                });
        }


        document.addEventListener('click', function (e) {
            if (e.target.closest('.report-btn')) {
                // å–å¾—è¨‚å–® ID
                const card = e.target.closest('.order-review-card');
                if (card) {
                    const orderId = card.querySelector('.order-id').value;
                    // ğŸ”¥ å–å¾—å…·é«”çš„è©•åƒ¹ ID
                    const evalId = e.target.closest('.member-eval-container').querySelector('.evaluate-id').value;
                    // èª¿ç”¨å…§åµŒå¼æª¢èˆ‰è¼¸å…¥æ¡†
                    injectReportBox(e.target.closest('.report-btn'), orderId, evalId);
                }
            }
        });







    </script>

    <footer id="main-footer" style="margin-top: 4rem;"></footer>

    <script th:src="@{/js/frontend/complaint-functions.js}"></script>
    <script th:src="@{/js/frontend/main.js}">
    </script>
</body>

</html>