<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>我的收藏 | PetGuardian</title>
	<link rel="stylesheet" th:href="@{/css/frontend/style.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/components.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/dashboard.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/store.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/booking/dashboard-favorites-sitters.css}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	
</head>

<body>

	<header id="main-header" class="header"></header>

	<!-- Flash Messages -->
	<div th:if="${message}" class="flash-message success">
		<i class="fas fa-check-circle"></i> <span th:text="${message}">成功訊息</span>
	</div>
	<div th:if="${error}" class="flash-message error">
		<i class="fas fa-exclamation-circle"></i> <span th:text="${error}">錯誤訊息</span>
	</div>

	<div class="container dashboard-container">
		<!-- Sidebar (共用元件) -->
		<div th:replace="~{frontend/fragments/dashboard-sidebar :: sidebar(activePage='favorites')}"></div>

		<!-- Main Content -->
		<div class="main-content">
			<div id="favorites">
				<div class="d-flex justify-between align-center mb-2">
					<h2 style="margin: 0;">我的收藏</h2>
					<a th:href="@{/booking/services}" class="btn btn-outline btn-sm">
						<i class="fas fa-search"></i> 找保母
					</a>
				</div>

				<div class="d-flex justify-between align-center mb-2">
					<div class="sub-tabs" style="margin-bottom: 0;">
						<a th:href="@{/dashboard/favorites/sitters}" class="sub-tab active">保母</a>
						<a th:href="@{/dashboard/favorites}" class="sub-tab">二手商品</a>
						<a class="sub-tab" th:href="@{/forumpost/post-collection}">文章</a>
					</div>
				</div>
				<div class="store-grid">
					<div th:each="fav : ${sitterFavorites}" class="store-product-card">

					    <div class="product-image-wrapper">
					        <a th:href="@{/frontend/public/sitter/detail/{id}(id=${fav.sitterId})}">
					           <img th:if="${fav.memImage != null}"
								    th:src="@{${fav.memImage}}" 
								    th:alt="${fav.sitterName}">
								<img th:unless="${fav.memImage != null}"
								    src="/images/member/aed4ec81-2887-41e6-8ed3-cd4cd6aa17f3_petguardianMember01.png" 
								    th:alt="${fav.sitterName}">
					        </a>
					
					        <button class="btn-like active"
					            th:onclick="'handleToggleFavorite(' + ${fav.sitterId} + ', this)'">
					            <i class="fa-solid fa-heart"></i>
					        </button>
					    </div>
						<div class="product-info">
							<h3 th:text="${fav.sitterName}">保母姓名</h3>
							<div class="stock-info">
								<span>
									<!-- 如果有評分 -->
									<th:block th:if="${fav.avgRating != null}">
										<i class="fas fa-star" style="color: #f1c40f;"></i>
										<span th:text="${fav.avgRating}">0.0</span>
										<!-- (<span th:text="${fav.ratingCount}">0</span> 評價) -->
									</th:block>
									<!-- 如果沒有評分 -->
									<th:block th:if="${fav.avgRating == null}">
										<span style="color: #999; font-size: 0.8rem;">暫未有星數</span>
									</th:block>
								</span>
							</div>
							<div class="product-price" style="margin: 0.5rem 0;">
								NT$ <span th:text="${fav.basePrice}">500</span> / 小時
							</div>
							<a th:href="@{/frontend/public/sitter/detail/{id}(id=${fav.sitterId})}" class="btn-buy-now">
								<i class="fas fa-calendar-check"></i>
								立即預約
							</a>
						</div>
					</div>

					<div th:if="${#lists.isEmpty(sitterFavorites)}" class="empty-state">
						<i class="fas fa-heart-broken"></i>
						<p>目前還沒有收藏任何保母喔！</p>
						<a href="/booking/services" class="btn btn-primary mt-2">去逛逛</a>
					</div>
				</div>
			</div>
			<!-- 分頁控制項 -->
			<div class="mt-5" th:if="${totalPages > 1}" 
			     style="display: flex !important; justify-content: center !important; align-items: center !important; width: 100% !important; gap: 10px;">
			    <a th:href="@{/dashboard/favorites/sitters(page=0)}" 
			       class="btn btn-outline btn-sm" th:if="${currentPage > 0}" style="border-radius: 20px;">第一頁</a>
			    <a th:href="@{/dashboard/favorites/sitters(page=${currentPage - 1})}" 
			       class="btn btn-outline btn-sm" th:if="${currentPage > 0}" style="border-radius: 20px;">
			       <i class="fas fa-chevron-left"></i> 上一頁
			    </a>
			    <span class="static-page-box" style="margin: 0;">
			        <th:block th:text="${currentPage + 1}">1</th:block> / <th:block th:text="${totalPages}">2</th:block>
			    </span>
			    <a th:href="@{/dashboard/favorites/sitters(page=${currentPage + 1})}" 
			       class="btn btn-outline btn-sm" th:if="${currentPage < totalPages - 1}" style="border-radius: 20px;">
			       下一頁 <i class="fas fa-chevron-right"></i>
			    </a>
			    <a th:href="@{/dashboard/favorites/sitters(page=${totalPages - 1})}" 
			       class="btn btn-outline btn-sm" th:if="${currentPage < totalPages - 1}" style="border-radius: 20px;">最後一頁</a>
			</div>
		</div>
	</div>
	<footer id="main-footer" style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
	<script th:src="@{/js/frontend/main.js}"></script>
	<script th:inline="javascript">
		if ('scrollRestoration' in history) {
	        history.scrollRestoration = 'manual';
	    }
        document.addEventListener('DOMContentLoaded', function () {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(msg => {
                setTimeout(() => {
                    msg.style.opacity = '0';
                    setTimeout(() => msg.remove(), 300);
                }, 3000);
            });
        });
        
        async function handleToggleFavorite(sitterId, btn) {
            try {
                const response = await fetch(`/booking/toggleFavorite/${sitterId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (response.status === 401) {
                    alert("請先登入才能收藏保母喔！");
                    return;
                }

                if (response.ok) {
                    const result = await response.text(); 
                    const icon = btn.querySelector('i');
                    
                    if (result === 'removed') {
                        // 1. 找到這張保母卡片
                        const card = btn.closest('.store-product-card');
                        
                        if (card) {
                            // 2. 執行淡出動畫
                            card.style.transition = 'all 0.4s ease';
                            card.style.opacity = '0';
                            card.style.transform = 'scale(0.9)';
                            
                            // 3. 不需要重新整理頁面
                            setTimeout(() => {
                                card.remove();
                                
                                // 4.如果卡片刪光了，顯示「目前沒有收藏」的提示
                                const remainingCards = document.querySelectorAll('.store-product-card');
                                if (remainingCards.length === 0) {
                                    location.reload(); 
                                }
                            }, 400);
                        }
                        showFlashMessage("已移除收藏");
                    } else {
                    	icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid');
                        icon.style.color = '#e74c3c';
                        btn.classList.add('active');
                        showFlashMessage("已加入收藏列表");
                    }
                }
            } catch (error) {
                console.error("操作失敗:", error);
                showFlashMessage("系統錯誤，請稍後再試", "error");
            }
        }

        // 補上顯示訊息的輔助函數，避免報錯
        function showFlashMessage(text, type = 'success') {
            const msg = document.createElement('div');
            msg.className = `flash-message ${type}`;
            msg.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> <span>${text}</span>`;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 300);
            }, 2500);
        }
    </script>
</body>

</html>