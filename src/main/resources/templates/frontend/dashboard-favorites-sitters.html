<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>我的收藏 | PetGuardian</title>
	<link rel="stylesheet" th:href="@{/css/frontend/style.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/components.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/dashboard.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/store.css}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
	.flash-message {
		position: fixed;
		top: 90px;
		left: 50%;
		transform: translateX(-50%);
		padding: 0.875rem 1.5rem;
		border-radius: 12px;
		z-index: 9999;
		animation: fadeIn 0.3s ease;
		font-weight: 500;
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
	}
	
	.flash-message.success {
		background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
		color: #155724;
		border: none;
	}
	
	.flash-message.error {
		background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
		color: #721c24;
		border: none;
	}
	
	@keyframes fadeIn {from { opacity:0;
		transform: translateX(-50%) translateY(-10px);
	}
	
	to {
		opacity: 1;
		transform: translateX(-50%) translateY(0);
	}
	
	}
	
	/* Stock Info */
	.stock-info {
		font-size: 0.85rem;
		color: #888;
		margin-top: 0.25rem;
	}
	
	.stock-info span {
		display: inline-flex;
		align-items: center;
		gap: 0.25rem;
	}
	
	/* Product Card Click */
	.store-product-card {
		cursor: pointer;
	}
	
	/* Image Wrapper */
	.product-image-wrapper {
		position: relative;
		width: 100%;
		padding-top: 80%;
		height: 0;
		overflow: hidden;
		background-color: #f8f9fa;
		border-radius: 12px 12px 0 0;
	}
	
	.product-image-wrapper img {
		position: absolute;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    object-fit: contain; 
	    padding: 10px; 
	    transition: transform 0.4s ease;
	    background-color: #ffffff;
	}
	
	.store-product-card:hover .product-image-wrapper img {
		transform: scale(1.08);
	}
	
	/* Favorite Button */
	.btn-like {
		position: absolute;
		top: 10px;
		right: 10px;
		z-index: 10;
		background: rgba(255, 255, 255, 0.9);
		border: none;
		border-radius: 50%;
		width: 34px;
		height: 34px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.25s ease;
		color: #bbb;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}
	
	.btn-like:hover {
		background: white;
		transform: scale(1.15);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	}
	
	.btn-like.active {
		color: #e74c3c;
		background: #fff5f5;
	}
	
	.btn-like.active i {
		color: #e74c3c;
	}
	
	/* Buy Button */
	.btn-buy-now {
		width: 100%;
		padding: 0.8rem 1rem;
		background: linear-gradient(135deg, var(--primary-color) 0%, #c4956a
			100%);
		color: white;
		border: none;
		border-radius: 10px;
		font-size: 0.95rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.3s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		box-shadow: 0 4px 12px rgba(212, 163, 115, 0.3);
		text-decoration: none;
	}
	
	.btn-buy-now:hover {
		transform: translateY(-2px);
		box-shadow: 0 6px 20px rgba(212, 163, 115, 0.4);
	}
	
	.btn-buy-now:disabled {
		background: #d5d5d5;
		cursor: not-allowed;
		box-shadow: none;
	}
	
	/* Sold Out Badge */
	.sold-out-badge {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		background: rgba(0, 0, 0, 0.75);
		color: white;
		padding: 0.6rem 1.75rem;
		border-radius: 8px;
		font-weight: 600;
		font-size: 0.95rem;
		z-index: 5;
		backdrop-filter: blur(4px);
	}
	
	/* Sold Out Card */
	.store-product-card.sold-out {
		opacity: 0.7;
	}
	
	.store-product-card.sold-out .product-image-wrapper img {
		filter: grayscale(30%);
	}
	
	/* Empty State */
	.empty-state {
		grid-column: 1/-1;
		text-align: center;
		padding: 5rem 2rem;
		background: #fafafa;
		border-radius: 20px;
		border: 2px dashed #e5e5e5;
	}
	
	.empty-state i {
		font-size: 4rem;
		color: #ddd;
		margin-bottom: 1.5rem;
	}
	
	.empty-state p {
		color: #999;
		font-size: 1.1rem;
	}
	</style>
</head>

<body>

	<header id="main-header" class="header"></header>

	<!-- Flash Messages -->
	<div th:if="${message}" class="flash-message success">
		<i class="fas fa-check-circle"></i> <span th:text="${message}">成功訊息</span>
	</div>
	<div th:if="${error}" class="flash-message error">
		<i class="fas fa-exclamation-circle"></i> <span th:text="${error}">錯誤訊息</span>
	</div>

	<div class="container dashboard-container">
		<!-- Sidebar (共用元件) -->
		<div
			th:replace="~{frontend/fragments/dashboard-sidebar :: sidebar(activePage='favorites')}"></div>

		<!-- Main Content -->
		<div class="main-content">
			<div id="favorites">
				<div class="d-flex justify-between align-center mb-2">
					<h2 style="margin: 0;">我的收藏</h2>
					<a th:href="@{/booking/services}" class="btn btn-outline btn-sm">
						<i class="fas fa-search"></i> 找保母
					</a>
				</div>

				<div class="d-flex justify-between align-center mb-2">
					<div class="sub-tabs" style="margin-bottom: 0;">
						<a th:href="@{/dashboard/favorites/sitters}" class="sub-tab active">保母</a> 
						<a th:href="@{/dashboard/favorites}" class="sub-tab">二手商品</a>
						<a class="sub-tab" th:href="@{/forumpost/post-collection}">文章</a>
					</div>
				</div>
				<div class="store-grid">
					<div th:each="fav : ${sitterFavorites}" class="store-product-card">
					    <div class="product-image-wrapper">
					        <a th:href="@{/frontend/public/sitter/detail/{id}(id=${fav.sitterId})}">
					            <img th:src="${fav.memImage}"
								     th:alt="${fav.sitterName}"
								     th:attr="onerror='this.src=\'' + @{/images/default-avatar.png} + '\''">
					        </a>
					
					        <button class="btn-like active"
					            th:onclick="'handleToggleFavorite(' + ${fav.sitterId} + ', this)'">
					            <i class="fa-solid fa-heart"></i>
					        </button>
					    </div>
						<div class="product-info">
							<h3 th:text="${fav.sitterName}">保母姓名</h3>
							<div class="stock-info">
								<span>
								    <i class="fas fa-star" style="color: #f1c40f;"></i>
								    <span th:text="${fav.avgRating}">0.0</span> 
								    (<span th:text="${fav.ratingCount}">0</span> 評價)
								</span>
							</div>
							<div class="product-price" style="margin: 0.5rem 0;">
								NT$ <span th:text="${fav.basePrice}">500</span> / 小時
							</div>
							<a
								th:href="@{/frontend/public/sitter/detail/{id}(id=${fav.sitterId})}"
								class="btn-buy-now"> <i class="fas fa-calendar-check"></i>
								立即預約
							</a>
						</div>
					</div>

					<div th:if="${#lists.isEmpty(sitterFavorites)}" class="empty-state">
						<i class="fas fa-heart-broken"></i>
						<p>目前還沒有收藏任何保母喔！</p>
						<a href="/booking/services" class="btn btn-primary mt-2">去逛逛</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<footer id="main-footer"
		style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
	<script th:src="@{/js/frontend/main.js}"></script>
	<script th:inline="javascript">
		if ('scrollRestoration' in history) {
	        history.scrollRestoration = 'manual';
	    }
        document.addEventListener('DOMContentLoaded', function () {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(msg => {
                setTimeout(() => {
                    msg.style.opacity = '0';
                    setTimeout(() => msg.remove(), 300);
                }, 3000);
            });
        });
        
        async function handleToggleFavorite(sitterId, btn) {
            try {
                const response = await fetch(`/booking/toggleFavorite/${sitterId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (response.status === 401) {
                    alert("請先登入才能收藏保母喔！");
                    return;
                }

                if (response.ok) {
                    const result = await response.text(); 
                    const icon = btn.querySelector('i');
                    
                    if (result === 'removed') {
                        // 1. 找到這張保母卡片
                        const card = btn.closest('.store-product-card');
                        
                        if (card) {
                            // 2. 執行淡出動畫
                            card.style.transition = 'all 0.4s ease';
                            card.style.opacity = '0';
                            card.style.transform = 'scale(0.9)';
                            
                            // 3. 不需要重新整理頁面
                            setTimeout(() => {
                                card.remove();
                                
                                // 4.如果卡片刪光了，顯示「目前沒有收藏」的提示
                                const remainingCards = document.querySelectorAll('.store-product-card');
                                if (remainingCards.length === 0) {
                                    location.reload(); 
                                }
                            }, 400);
                        }
                        showFlashMessage("已移除收藏");
                    } else {
                    	icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid');
                        icon.style.color = '#e74c3c';
                        btn.classList.add('active');
                        showFlashMessage("已加入收藏列表");
                    }
                }
            } catch (error) {
                console.error("操作失敗:", error);
                showFlashMessage("系統錯誤，請稍後再試", "error");
            }
        }

        // 補上顯示訊息的輔助函數，避免報錯
        function showFlashMessage(text, type = 'success') {
            const msg = document.createElement('div');
            msg.className = `flash-message ${type}`;
            msg.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> <span>${text}</span>`;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 300);
            }, 2500);
        }
    </script>
</body>

</html>