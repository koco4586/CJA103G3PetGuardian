<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訊息中心 MVP | PetGuardian</title>

    <!-- Base styles -->
    <link rel="stylesheet" th:href="@{/css/frontend/style.css}">
    <link rel="stylesheet" th:href="@{/css/frontend/components.css}">
    <!-- Chat MVP styles -->
    <link rel="stylesheet" th:href="@{/css/frontend/chat/chat-mvp.css}">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Hidden inputs for current user (Thymeleaf) -->
    <input type="hidden" id="currentUserId" th:value="${currentUser.memId}">
    <input type="hidden" id="currentUserName" th:value="${currentUser.memName}">
    <!-- [NEW] Flash Attribute for auto-selecting room -->
    <input type="hidden" id="initialChatroomId" th:value="${activeRoomId}">

    <header id="main-header" class="header"></header>

    <div class="container">
        <!-- Current user badge -->
        <div class="current-user-badge">
            <i class="fas fa-user"></i>
            當前用戶：<strong th:text="${currentUser.memName}">User</strong>
            (ID: <span th:text="${currentUser.memId}">0</span>)
        </div>

        <div class="chat-container">
            <!-- Sidebar: User List -->
            <div class="chat-sidebar">
                <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                    <div style="position: relative;">
                        <input type="text" id="search-contact-input" placeholder="搜尋聯絡人..." class="form-control"
                            style="padding-left: 2rem;" oninput="ChatApp.filterContacts(this.value)">
                        <i class="fas fa-search" style="position: absolute; left: 10px; top: 12px; color: #999;"></i>
                    </div>
                </div>
                <div style="overflow-y: auto;">
                    <!-- Loop through users -->
                    <!-- Loop through My Chatrooms -->
                    <div th:each="room : ${chatrooms}" class="contact-item" th:id="'contact-item-' + ${room.chatroomId}"
                        th:data-chatroom-id="${room.chatroomId}" th:data-partner-name="${room.displayName}"
                        th:data-partner-id="${room.partnerId}"
                        onclick="ChatApp.selectRoom(this.dataset.chatroomId, this.dataset.partnerName, this.dataset.partnerId)">
                        <div class="d-flex justify-between w-100 align-center">
                            <div style="display: flex; align-items: center;">
                                <span class="unread-dot" th:classappend="${room.unread} ? '' : 'app-d-none'"></span>
                                <strong style="font-size: 1rem; color: var(--text-color);"
                                    th:text="${room.displayName}">Room Name</strong>
                            </div>
                        </div>
                        <div class="contact-last-msg" th:text="${room.lastMessage} ?: '點擊開始聊天'">
                            點擊開始聊天
                        </div>
                    </div>

                    <!-- Empty state if no other users -->
                    <!-- Empty state if no chatrooms -->
                    <div th:if="${#lists.isEmpty(chatrooms)}" style="padding: 2rem; text-align: center; color: #999;">
                        <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>目前沒有聊天室</p>
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-main">
                <div class="chat-header">
                    <div class="d-flex align-center gap-sm">
                        <div style="display: flex; flex-direction: row; align-items: center; gap: 0.5rem;">
                            <h4 id="chatHeaderTitle" style="margin: 0;">請選擇聊天對象</h4>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="message-list">
                    <div class="chat-empty-state">
                        <i class="fas fa-comments"></i>
                        <p>從左側選擇一個用戶開始聊天</p>
                    </div>
                </div>

                <!-- Reply Preview Bar -->
                <div id="reply-preview-bar" class="reply-preview-bar">
                    <div class="reply-preview-content">
                        <strong id="reply-to-name">Reply to Users</strong>
                        <span id="reply-to-text">Message content...</span>
                    </div>
                    <button type="button" class="reply-close-btn" onclick="ChatApp.cancelReply()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="chat-input-form" class="chat-input" style="display: none;"
                    onsubmit="event.preventDefault(); ChatApp.sendMessage();">
                    <input type="text" id="msg-input" class="form-control" placeholder="輸入訊息..."
                        style="border: none; background: #f9f9f9; flex: 1;" onkeypress="ChatApp.handleKeyPress(event)"
                        oninput="ChatApp.updateSendButton()">
                    <button type="submit" id="send-btn" class="btn-send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3>檢舉訊息</h3>
            <div style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
                請選擇檢舉原因：
            </div>
            <select id="reportReasonType" class="form-control" style="margin-bottom: 1rem;">
                <option value="0">騷擾</option>
                <option value="1">垃圾訊息</option>
                <option value="2">不當內容 (色情/暴力)</option>
                <option value="3">詐騙</option>
                <option value="4">其他</option>
            </select>
            <textarea id="reportReasonText" class="form-control" rows="3" placeholder="請填寫詳細說明..."
                style="margin-bottom: 1rem;"></textarea>
            <div class="modal-buttons">
                <button onclick="ChatApp.closeReportModal()" class="btn ghost">取消</button>
                <button onclick="ChatApp.submitReport()" class="btn"
                    style="background-color: #e74c3c; color: white;">送出檢舉</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <ul id="contextMenu" class="context-menu" style="display:none;">
        <li id="ctx-report-btn" onclick="ChatApp.openReportModal()">
            <i class="fas fa-flag"></i> 檢舉此訊息
        </li>
    </ul>

    <!-- SockJS and STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Main JS -->
    <script th:src="@{/js/frontend/main.js}"></script>
    <!-- Chat MVP JS -->
    <script th:src="@{/js/frontend/chat/chat-mvp.js}"></script>
</body>

</html>