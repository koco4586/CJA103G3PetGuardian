<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>預約服務 | PetGuardian</title>
<!-- 使用前台統一樣式 -->
<link rel="stylesheet" th:href="@{/css/frontend/style.css}">
<link rel="stylesheet" th:href="@{/css/frontend/components.css}">
<link rel="stylesheet" th:href="@{/css/frontend/booking/services.css}">
<link
	href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
	<header id="main-header" class="header"></header>

	<main class="container"
		style="padding-top: 2rem; padding-bottom: 5rem;">
		<!-- 搜尋區域 -->
		<div class="filter-section">
			<h2 class="mb-2" style="font-weight: 700; color: #333;">找尋您的完美寵物保母</h2>
			<div class="d-flex gap-lg"
				style="flex-wrap: wrap; align-items: flex-end;">
				<div class="form-group mb-0" style="flex: 2; min-width: 250px;">
					<label class="form-label">搜尋地區</label>
					<div class="d-flex gap-sm">
						<div style="flex: 1; position: relative;">
							<i class="fa-solid fa-city"
								style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #888;"></i>
							<select class="form-control" id="citySelect"
								style="padding-left: 2.8rem; height: 48px;">
								<option value="">請先選擇縣市</option>
								<option th:each="city : ${availableCities}" th:value="${city}"
									th:text="${city}">台北市</option>
							</select>
						</div>
						<!-- 行政區選單 -->
						<div style="flex: 1; position: relative;">
							<i class="fa-solid fa-location-dot"
								style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #888;"></i>
							<select class="form-control" id="districtSelect"
								style="padding-left: 2.8rem; height: 48px;">
								<option value="">選擇行政區</option>
							</select>
						</div>
					</div>
				</div>
				<div style="flex: 0.5; min-width: 120px;">
					<button class="btn btn-primary"
						style="height: 48px; width: 100%; border-radius: 0.8rem; margin: 0;"
						onclick="searchSitters()">
						<i class="fa-solid fa-magnifying-glass mr-xs"></i> 搜尋
					</button>
				</div>
			</div>
		</div>

		<!-- 列表區域 -->
		<div class="d-flex justify-between align-center mb-2">
			<h3 style="font-weight: 700;">精選保母</h3>
			<span style="color: #666; font-size: 0.9rem;"
				th:text="'共找到 ' + ${sitters.size()} + ' 位保母'">共找到 0 位保母</span>
		</div>

		<div class="sitter-grid" id="sitter-list">
			<!-- 動態迴圈渲染保母 -->
			<div class="card-premium" th:each="sitter : ${sitters}"
				th:if="${currentMemId == null or sitter.sitter.memId != currentMemId}">
				<div class="img-container">
					<a
						th:href="@{/frontend/public/sitter/detail/{id}(id=${sitter.sitter.sitterId})}">
						<img
						th:src="${sitter.memImage != null ? sitter.memImage : '/images/default-avatar.png'}"
						alt="保母照片" class="sitter-img">
					</a>
					<!--       <div class="price-badge">
                        $500 <span style="font-size: 0.7rem; font-weight: 400;">/小時</span>
                    </div>-->
					<button class="btn-like"
						th:classappend="${sitter.isFavorited ? 'active' : ''}"
						th:onclick="'handleToggleFavorite(' + ${sitter.sitter.sitterId} + ', this)'"
						style="position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.8); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer;">
						<i class="fa-heart"
							th:classappend="${sitter.isFavorited ? 'fa-solid text-danger' : 'fa-regular'}"></i>
					</button>
				</div>
				<div class="content" style="padding: 1.5rem;">
					<div class="d-flex justify-between align-center mb-1">
						<h4 th:text="${sitter.sitter.sitterName}"
							style="margin: 0; font-size: 1.2rem; font-weight: 700;">保母姓名
						</h4>
						<div style="color: #ffb800; font-size: 0.9rem;">
							<i class="fa-solid fa-star"></i> <span
								th:text="${sitter.sitter.sitterRatingCount != null && sitter.sitter.sitterRatingCount > 0} ? ${#numbers.formatDecimal(sitter.sitter.sitterStarCount * 1.0 / sitter.sitter.sitterRatingCount, 1, 1)} : '5.0'">5.0</span>
						</div>
					</div>
					<div class="d-flex gap-xs mb-2"
						style="flex-wrap: wrap; align-items: center; min-height: 50px;">
						<i class="fas fa-map-marker-alt"
							style="color: #4f46e5; font-size: 0.9rem; margin-right: 4px;"></i>
						<span class="category-tag"
							style="background: #eef2ff; color: #4338ca; font-weight: 700;"
							th:text="${sitter.servicesJson}">台北市</span> <span
							th:each="sa : ${sitter.sitter.serviceAreas}" class="category-tag"
							th:text="${sa.area.district}"> 行政區 </span> <span
							th:if="${#lists.isEmpty(sitter.sitter.serviceAreas)}"
							class="category-tag" style="background: #fdf2f2; color: #991b1b;">全區服務</span>
					</div>
					<button class="btn btn-primary btn-booking-trigger"
						style="width: 100%; border-radius: 3rem;"
						th:data-name="${sitter.sitter.sitterName}"
						th:data-id="${sitter.sitter.sitterId}"
						th:data-services="${sitter.servicesJson}">立即預約</button>
				</div>
			</div>
		</div>
	</main>
	<div
		class="pagination-container mt-4 d-flex justify-content-center gap-2"
		th:if="${totalPages > 1}">
		<a th:if="${currentPage > 0}"
			th:href="@{/booking/services(page=${currentPage - 1})}"
			class="btn btn-outline">上一頁</a> <span class="page-info"
			th:text="${currentPage + 1} + ' / ' + ${totalPages}">1 / 5</span> <a
			th:if="${currentPage + 1 < totalPages}"
			th:href="@{/booking/services(page=${currentPage + 1})}"
			class="btn btn-outline">下一頁</a>
	</div>

	<!-- 預約 Modal -->
	<div id="bookingModal"
		style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center;">
		<div
			style="background: white; padding: 2.5rem; border-radius: 2rem; width: 95%; max-width: 450px; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
			<button onclick="closeModal()"
				style="position: absolute; right: 1.5rem; top: 1.5rem; background: #f0f0f0; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer;">&times;</button>
			<h3 style="font-weight: 700; font-size: 1.5rem;">
				預約 <span id="sitterName" style="color: var(--primary-color);"></span>
			</h3>

			<form id="realBookingForm" class="mt-2">
				<input type="hidden" id="modalSitterId">
				<div class="form-group">
					<label class="form-label">選擇小毛孩</label> <select
						class="form-control" id="petId">
						<option th:if="${#lists.isEmpty(myPets)}" value="">請先至會員中心新增寵物</option>

						<option th:each="pet : ${myPets}" th:value="${pet.petId}"
							th:text="${pet.petName} + ' (' + ${pet.petTypeName} + ')'">
						</option>
					</select>
				</div>
				<div class="form-group">
					<label class="form-label">服務項目</label> <select class="form-control"
						id="serviceItemId">
					</select>
				</div>
				 <div class="form-group">
                    <label class="form-label">開始時間</label> <input type="datetime-local" id="startTime"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">結束時間</label> <input type="datetime-local" id="endTime"
                        class="form-control">
                </div>
				<div class="form-group">
					<label class="form-label">特別需求</label>
					<textarea class="form-control" id="bookingNotes" rows="2"
						placeholder="有什麼想告訴保母的嗎？"></textarea>
				</div>
				<button type="button" class="btn btn-primary"
					style="width: 100%; border-radius: 3rem; margin-top: 1rem; height: 50px; font-size: 1.1rem;"
					onclick="submitBooking()">確認送出</button>
			</form>
		</div>
	</div>

	<script th:src="@{/js/frontend/main.js}"></script>

	<script>
        // 1. 確保關鍵函數在最外層全域作用域，保證隨時可被呼叫
        async function openBookingModal(name, id) {
            console.log("正在開啟預約彈窗 (Async):", name, id);
            const modal = document.getElementById('bookingModal');
            const sitterNameSpan = document.getElementById('sitterName');
            const sitterIdInput = document.getElementById('modalSitterId');
            const startInput = document.getElementById('startTime');
            const endInput = document.getElementById('endTime');
            const serviceSelect = document.getElementById('serviceItemId');

            if (!modal || !sitterNameSpan || !sitterIdInput) {
                console.error("找不到服務");
                return;
            }

            sitterNameSpan.innerText = name;
            sitterIdInput.value = id;
            
            serviceSelect.innerHTML = '<option>正在載入服務...</option>';
            serviceSelect.disabled = true;
            
            try {
            	// 發送請求去後端 API 抓取服務資料
                const response = await fetch(`/booking/api/sitter/${id}/services`);
                if (!response.ok) throw new Error("資料讀取失敗");
                
                const services = await response.json();
                
                //  載入完成，重置選單
                serviceSelect.innerHTML = '';
                serviceSelect.disabled = false; 

                if (services.length === 0) {
                    let opt = document.createElement('option');
                    opt.text = "此保母暫無服務項目";
                    serviceSelect.add(opt);
            } else {
                services.forEach(svc => {
                    let opt = document.createElement('option');
                    opt.value = svc.id;
                    opt.text = svc.name;
                    serviceSelect.add(opt);
                });
            }
            } catch (error) {
                console.error("載入服務失敗:", error);
                serviceSelect.innerHTML = '<option>載入失敗，請重試</option>';
                serviceSelect.disabled = false;
            }

            // 自動設定時間限制 
            const now = new Date();
            const minDate = new Date(now.getTime());
            const maxDate = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000);

            function formatDT(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                const h = String(date.getHours()).padStart(2, '0');
                const min = String(date.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${d}T${h}:${min}`;
            }

            const minStr = formatDT(minDate);
            const maxStr = formatDT(maxDate);

            if (startInput) {
                startInput.min = minStr;
                startInput.max = maxStr;
                startInput.value = minStr; // 預設帶入最早可選時間
            }
            if (endInput) {
                endInput.min = minStr;
                endInput.max = maxStr;
            }

            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('bookingModal');
            if (modal) modal.style.display = 'none';
        }

        // 2. 監聽器初始化
        document.addEventListener('DOMContentLoaded', function () {
            console.log("預約系統已完全就緒");
            const modal = document.getElementById('bookingModal');

            // 使用事件委派監聽點擊， closest 確保點擊按鈕內部也能觸發
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.btn-booking-trigger');
                if (btn) {
                    const name = btn.getAttribute('data-name');
                    const id = btn.getAttribute('data-id');
                    openBookingModal(name, id);
                }
            });

            // 點擊背景關閉
            window.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
        });

        // 3. 提交邏輯
        async function submitBooking() {
            const petId = document.getElementById('petId').value;
            if (!petId) {
                alert("目前尚無寵物資料，請先新增寵物！");
                return;
            }

            const startVal = document.getElementById('startTime').value;
            const endVal = document.getElementById('endTime').value;

            if (!startVal || !endVal) {
                alert("請填寫時間！");
                return;
            }

            if (new Date(startVal) >= new Date(endVal)) {
                alert("結束時間需晚於開始時間！");
                return;
            }

            const formData = new URLSearchParams();
            formData.append('sitterId', document.getElementById('modalSitterId').value);
            formData.append('petId', petId);
            formData.append('serviceItemId', document.getElementById('serviceItemId').value);
            formData.append('startTime', startVal);
            formData.append('endTime', endVal);
            formData.append('bookingNotes', document.getElementById('bookingNotes').value);

            try {
                const response = await fetch('/booking/submit', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert("預約成功！");
                    window.location.href = "/booking/memberOrders";
                } else {
                    const msg = await response.text();
                    alert("預約失敗：" + msg);
                }
            } catch (err) {
                console.error(err);
                alert("發生系統錯誤");
            }
        }

        document.getElementById('citySelect').addEventListener('change', function () {
            const city = this.value;
            const districtSelect = document.getElementById('districtSelect');
            if (city) {
                fetch(`/sitter/profile/districts?city=${encodeURIComponent(city)}`)
                    .then(response => response.json())
                    .then(districts => {
                        districtSelect.innerHTML = '<option value="">請選擇行政區</option>';
                        districts.forEach(area => {
                            const option = document.createElement('option');
                            // 我們將 value 設為行政區名稱，方便後端直接過濾
                            option.value = area.district; 
                            option.text = area.district;
                            districtSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('載入地區失敗:', error);
                        districtSelect.innerHTML = '<option value="">載入失敗</option>';
                    });
            } else {
                districtSelect.innerHTML = '<option value="">請先選擇縣市</option>';
            }
        });
        /* --- 修改：執行搜尋 --- */
        function searchSitters() {
            const district = document.getElementById('districtSelect').value;
            // 如果沒有選行政區，則導向全部列表
            if (!district) {
                window.location.href = "/booking/services";
                return;
            }
            window.location.href = `/booking/search?area=${encodeURIComponent(district)}`;
        }
        
        async function handleToggleFavorite(sitterId, btn) {
        	const icon = btn.querySelector('i');
            try {
                const response = await fetch(`/booking/toggleFavorite/${sitterId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.text();
                    
                    if (result === "NOT_LOGGED_IN") {
                        alert("請先登入才能收藏保母喔！");
                        return; 
                    }
                    if (result === "added") {
                        // 變為已收藏狀態 (紅色實心)
                        icon.classList.remove('fa-regular');
                        icon.classList.add('fa-solid', 'text-danger');
                        btn.classList.add('active');
                        showFlashMessage("已加入收藏列表");
                    } else {
                        // 變為未收藏狀態 (灰色空心)
                        icon.classList.remove('fa-solid', 'text-danger');
                        icon.classList.add('fa-regular');
                        btn.classList.remove('active');
                        showFlashMessage("已從收藏移除");
                    }
                }
            } catch (error) {
                console.error("收藏操作失敗:", error);
            }
        }
        
        // 收藏頁面的提示訊息功能
        function showFlashMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'flash-message success';
            msg.innerHTML = `<i class="fas fa-check-circle"></i> <span>${text}</span>`;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 300);
            }, 2000);
        }
    </script>
	<footer id="main-footer"
		style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
</body>

</html>