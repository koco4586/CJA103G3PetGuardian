<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>保母預約紀錄 | PetGuardian</title>
<link rel="stylesheet" th:href="@{/css/frontend/style.css}">
<link rel="stylesheet" th:href="@{/css/frontend/components.css}">
<link rel="stylesheet"
	th:href="@{/css/frontend/booking/dashboard-bookings.css}">
<link
	href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>

<body>
	<header id="main-header" class="header"></header>

	<div class="container dashboard-layout">
		<!-- 側邊欄 -->
		<aside class="dashboard-sidebar">
			<div class="text-center mb-3">
				<div
					style="width: 80px; height: 80px; background: #e0f2f1; color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2rem;">
					<i class="fas fa-user-circle"></i>
				</div>
				<h4 th:text="${memName}" style="font-weight: 700; margin: 0;">會員姓名</h4>
				<p style="color: #999; font-size: 0.85rem;">優質寵物主人</p>
			</div>

			<nav>
				<a href="/member/profile" class="menu-link"><i
					class="fas fa-user"></i> 個人資料</a> <a href="/member/pets"
					class="menu-link"><i class="fas fa-paw"></i> 我的寵物</a> <a
					th:href="@{/booking/memberOrders}" class="menu-link active"><i
					class="fas fa-calendar-check"></i> 保母預約紀錄</a> <a href="#"
					class="menu-link"><i class="fas fa-heart"></i> 收藏列表</a>
				<div
					style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
					<a th:href="@{/front/loginpage}" class="menu-link"
						style="color: #ef4444;"> <i class="fas fa-sign-out-alt"></i>
						登出
					</a>
				</div>
			</nav>
		</aside>

		<!-- 主要內容 -->
		<main class="dashboard-content">
			<h2 class="mb-3" style="font-weight: 700;">會員預約列表</h2>

			<div class="filter-tabs-container">
				<div class="filter-tabs-wrapper">
					<div class="filter-group">
						<a th:href="@{/booking/memberOrders}" class="tab-btn"
							th:classappend="${currentStatus == null} ? 'active' : ''">全部</a>

						<a th:href="@{/booking/memberOrders(status=0)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 0} ? 'active' : ''">即將到來</a>

						<a th:href="@{/booking/memberOrders(status=1)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 1} ? 'active' : ''">進行中</a>

						<a th:href="@{/booking/memberOrders(status=2)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 2} ? 'active' : ''">服務完成</a>

						<a th:href="@{/booking/memberOrders(status=3)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 3} ? 'active' : ''">已取消</a>
					</div>

					<a href="/booking/services" class="btn btn-primary btn-sm"
						style="border-radius: 2rem;">+ 新增預約</a>
				</div>
			</div>

			<!-- 動態資料迴圈 -->
			<div class="booking-list">
				<div th:each="order : ${bookingList}" class="booking-card">
					<div class="d-flex align-center gap-lg">
						<div>
							<div class="d-flex align-center gap-sm mb-xs">
								<h4 th:text="${order.sitterName}">保母姓名</h4>
								<span th:if="${order.orderStatus == 0}"
									class="badge-pill status-upcoming">即將到來</span> <span
									th:if="${order.orderStatus == 1}"
									class="badge-pill status-ongoing">進行中</span> <span
									th:if="${order.orderStatus == 2}"
									class="badge-pill status-completed">服務完成</span> <span
									th:if="${order.orderStatus == 3}"
									class="badge-pill status-cancelled">已取消</span> <span
									th:if="${order.orderStatus == 5}"
									class="badge-pill status-completed">已結案</span>
							</div>
							<div style="color: #666; font-size: 0.9rem;">
								<i class="far fa-clock"></i> <span
									th:text="${#temporals.format(order.startTime, 'yyyy-MM-dd HH:mm')} + ' ~ ' + ${#temporals.format(order.endTime, 'HH:mm')}">
								</span>
							</div>
						</div>
					</div>

					<div class="d-flex align-center gap-lg">
						<div class="text-right" style="min-width: 100px;">
							<div style="font-weight: 700; color: #ea580c; font-size: 1.2rem;"
								th:text="'$' + ${order.reservationFee}"></div>
							<div style="font-size: 0.75rem; color: #bbb;"
								th:text="'ID: #BK-' + ${order.bookingOrderId}"></div>
						</div>

						<div class="d-flex gap-sm">
							<th:block
								th:with="isPast=${order.startTime.isBefore(#temporals.createNow())}">
								<th:block
									th:if="${(order.orderStatus == 0 or order.orderStatus == 1) and !isPast}">
									<button class="btn btn-primary btn-sm">聯絡保母</button>
									<button type="button" th:data-id="${order.bookingOrderId}"
										th:data-start="${#temporals.format(order.startTime, 'yyyy-MM-dd HH:mm')}"
										onclick="openCancelModal(this)" class="btn btn-danger">
										取消預約</button>
								</th:block>

								<th:block
									th:if="${order.orderStatus == 2 or order.orderStatus == 5 or ((order.orderStatus == 0 or order.orderStatus == 1) and isPast)}">
									<!--  	<button class="btn btn-outline btn-sm">查看照顧紀錄</button>     -->
									<button class="btn btn-outline btn-sm">評價保母</button>
								</th:block>

								<th:block th:if="${order.orderStatus == 3}">
									<div style="text-align: right;">
										<div
											th:if="${order.cancelReason != null and !#strings.isEmpty(order.cancelReason)}">
											<span
												style="color: #ef4444; font-size: 0.85rem; font-weight: 700; display: block; margin-bottom: 4px;">
												<i class="fas fa-exclamation-circle"></i> 保母已婉拒
											</span>
											<div
												style="color: #666; font-size: 0.8rem; background: #fff5f5; padding: 4px 10px; border-radius: 6px; border: 1px solid #ffe3e3; display: inline-block;">
												原因：<span th:text="${order.cancelReason}">理由載入中...</span>
											</div>
										</div>

										<div
											th:unless="${order.cancelReason != null and !#strings.isEmpty(order.cancelReason)}">
											<span
												style="color: #bbb; font-size: 0.9rem; font-weight: 500;">訂單已結束</span>
										</div>
									</div>
								</th:block>
						</div>
					</div>
				</div>

				<div th:if="${#lists.isEmpty(bookingList)}"
					style="text-align: center; padding: 5rem 0; background: white; border-radius: 2rem; border: 1px dashed #ddd;">
					<p style="color: #999;">目前沒有進行中的預約</p>
				</div>
			</div>
		</main>
	</div>
	<div id="cancelBookingModal"
		style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
		<div
			style="background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 450px; position: relative;">
			<button onclick="closeCancelModal()"
				style="position: absolute; right: 1.5rem; top: 1.5rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
			<h3 class="mb-2">取消預約</h3>
			<div id="refundInfoBox" class="mb-3 p-3"
				style="background: #f8f9fa; border-radius: 8px;"></div>
			<div class="d-flex gap-md">
				<button class="btn btn-outline"
					style="flex: 1; border-radius: 2rem;" onclick="closeCancelModal()">暫不取消</button>
				<button class="btn btn-primary" id="confirmCancelBtn"
					style="flex: 1; background: #fa5252; border-color: #fa5252; border-radius: 2rem;">確認取消並退款</button>
			</div>
		</div>
	</div>
	<footer id="main-footer"
		style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
	<script th:src="@{/js/frontend/main.js}"></script>
	<script>
		let currentCancelId = null;

		function openCancelModal(btn) {
			const orderId = btn.getAttribute('data-id');
			const startDateStr = btn.getAttribute('data-start');

			currentCancelId = orderId;
			const infoBox = document.getElementById('refundInfoBox');

			// 計算退費邏輯
			const today = new Date();
			const bookingDate = new Date(startDateStr);
			const diffTime = bookingDate - today;
			const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

			if (diffDays >= 7) {
				infoBox.innerHTML = `
                <p style="color:#2f9e44; font-weight:600; margin:0;">符合全額退費條件</p>
                <p style="font-size:0.85rem; color:#666; margin:0.5rem 0 0 0;">預約編號：#BK-${orderId}<br>距離服務還有 ${diffDays} 天，取消將退還 100% 預約金。</p>`;
			} else if (diffDays > 0) {
				infoBox.innerHTML = `
                <p style="color:#ea580c; font-weight:600; margin:0;">酌收手續費 (退還 50%)</p>
                <p style="font-size:0.85rem; color:#666; margin:0.5rem 0 0 0;">預約編號：#BK-${orderId}<br>距離服務僅剩 ${diffDays} 天，取消將退還 50% 預約金。</p>`;
			} else {
				infoBox.innerHTML = `
                <p style="color:#fa5252; font-weight:600; margin:0;">不可退費</p>
                <p style="font-size:0.85rem; color:#666; margin:0.5rem 0 0 0;">預約編號：#BK-${orderId}<br>服務已開始或即將開始，目前取消不予退費。</p>`;
			}

			document.getElementById('cancelBookingModal').style.display = 'flex';

			// 綁定按鈕點擊事件 (確保只綁定一次)
			document.getElementById('confirmCancelBtn').onclick = function () {
				handleRefund(currentCancelId);
			};
		}

		function closeCancelModal() {
			document.getElementById('cancelBookingModal').style.display = 'none';
		}

		async function handleRefund(orderId) {
			try {
				const response = await fetch(`/booking/refund/${orderId}`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' }
				});

				if (response.ok) {
					alert("取消成功！系統已自動處理退款審核。");
					window.location.reload();
				} else {
					const errorMsg = await response.text();
					alert("取消失敗：");
				}
			} catch (error) {
				console.error("Error:", error);
				alert("系統錯誤，請稍後再試。");
			}
			closeCancelModal();
		}
	</script>
</body>

</html>