<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>保母預約紀錄 | PetGuardian</title>
	<link rel="stylesheet" th:href="@{/css/frontend/style.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/components.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/dashboard.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/booking/dashboard-bookings.css}">
	<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" th:href="@{/css/frontend/evaluate-styles.css}">
	<style>
		/* 分頁按鈕樣式 */
		.pagination-container button {
			padding: 8px 16px;
			border: 1px solid #ddd;
			background: white;
			color: #333;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.2s;
			font-size: 0.9rem;
		}

		.pagination-container button:hover:not(:disabled) {
			background: #ffc107;
			color: white;
			border-color: #ffc107;
		}

		.pagination-container button.active {
			background: #ffc107;
			color: white;
			border-color: #ffc107;
			font-weight: bold;
		}

		.pagination-container button:disabled {
			background: #f5f5f5;
			color: #ccc;
			cursor: not-allowed;
		}

		/* 檢舉輸入框樣式 */
		.dynamic-report-wrapper {
			overflow: hidden;
			max-height: 0;
			opacity: 0;
			margin-top: 0;
			padding: 0 20px;
			transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
			background: #fff5f5;
			border-radius: 15px;
			border: 1px solid transparent;
			width: 100%;
			box-sizing: border-box;
		}

		.dynamic-report-wrapper.active {
			max-height: 800px;
			opacity: 1;
			margin-top: 15px;
			padding: 20px;
			border: 1px solid #ffcdd2;
			box-shadow: 0 4px 15px rgba(255, 205, 210, 0.3);
		}

		.report-tag {
			display: inline-block;
			padding: 6px 14px;
			margin: 5px;
			background: #fff;
			border: 1px solid #ffcdd2;
			border-radius: 20px;
			cursor: pointer;
			font-size: 0.9rem;
			color: #c62828;
			transition: all 0.2s;
		}

		.report-tag.selected {
			background: #ffcdd2;
			font-weight: bold;
		}

		.submit-report-btn {
			background: #ff6b6b;
			color: white;
			border: none;
			padding: 10px 25px;
			border-radius: 50px;
			cursor: pointer;
			font-weight: bold;
			display: flex;
			align-items: center;
			gap: 8px;
			float: right;
			transition: transform 0.1s, background 0.2s;
		}

		.submit-report-btn:active {
			transform: scale(0.92);
		}

		.submit-report-btn:hover {
			background: #ff5252;
		}
	</style>

</head>

<body>
	<header id="main-header" class="header"></header>

	<div class="container dashboard-container">
		<!-- 側邊欄 -->
		<div th:replace="~{frontend/fragments/dashboard-sidebar :: sidebar(activePage='bookings')}"></div>

		<!-- 主要內容 -->
		<div class="main-content">
			<h2 class="mb-3" style="font-weight: 700;">會員預約列表</h2>

			<div class="filter-tabs-container">
				<div class="filter-tabs-wrapper">
					<div class="filter-group">
						<a th:href="@{/booking/memberOrders}" class="tab-btn"
							th:classappend="${currentStatus == null} ? 'active' : ''">全部</a>

						<a th:href="@{/booking/memberOrders(status=0)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 0} ? 'active' : ''">即將到來</a>

						<a th:href="@{/booking/memberOrders(status=1)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 1} ? 'active' : ''">進行中</a>

						<a th:href="@{/booking/memberOrders(status=2)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 2} ? 'active' : ''">服務完成</a>


						<a th:href="@{/booking/memberOrders(status=3)}" class="tab-btn"
							th:classappend="${currentStatus != null && currentStatus == 3} ? 'active' : ''">已取消</a>

						<!-- 評價標籤：保母或會員本人可見 -->
						<a th:if="${session.roleId == 0 or session.memId == memId}" href="#" class="tab-btn"
							id="reviewsTab" onclick="event.preventDefault(); showMemberReviews();">評價</a>
					</div>

					<a href="/booking/services" class="btn btn-primary btn-sm" style="border-radius: 2rem;">+ 新增預約</a>
				</div>
			</div>

			<!-- 動態資料迴圈 -->
			<div class="booking-list">
				<div th:each="order : ${bookingList}" class="booking-card">
					<div class="d-flex align-center gap-lg">
						<div>
							<div class="d-flex align-center gap-sm mb-xs">
								<h4 th:text="${order.sitterName}">保母姓名</h4>
								<span th:if="${order.orderStatus == 0}" class="badge-pill status-upcoming">即將到來</span>
								<span th:if="${order.orderStatus == 1}" class="badge-pill status-ongoing">進行中</span>
								<span th:if="${order.orderStatus == 2}" class="badge-pill status-completed">服務完成</span>
								<span th:if="${order.orderStatus == 3}" class="badge-pill status-cancelled">已取消</span>
								<span th:if="${order.orderStatus == 5}" class="badge-pill status-completed">已結案</span>
							</div>
							<div style="color: #666; font-size: 0.9rem;">
								<i class="far fa-clock"></i> <span
									th:text="${#temporals.format(order.startTime, 'yyyy-MM-dd HH:mm')}"></span>
							</div>
						</div>
					</div>

					<div class="d-flex align-center gap-lg">
						<div class="text-right" style="min-width: 100px;">
							<div style="font-weight: 700; color: #ea580c; font-size: 1.2rem;"
								th:text="'$' + ${order.reservationFee}"></div>
							<div style="font-size: 0.75rem; color: #bbb;"
								th:text="'ID: #BK-' + ${order.bookingOrderId}"></div>
						</div>

						<div class="d-flex gap-sm">
							<th:block th:with="isPast=${order.startTime.isBefore(#temporals.createNow())}">
								<th:block th:if="${order.orderStatus == 0 or order.orderStatus == 1}">
									<form th:action="@{/chat/connect/booking}" method="post" style="display:inline;">
										<input type="hidden" name="targetUserId" th:value="${order.sitterMemId}" />
										<input type="hidden" name="chatroomType" value="0" />
										<button type="submit" class="btn btn-primary btn-sm">聯絡保母</button>
									</form>
								</th:block>
								<th:block th:if="${(order.orderStatus == 0 or order.orderStatus == 1) and !isPast}">
									<button type="button" th:data-id="${order.bookingOrderId}"
										th:data-start="${#temporals.format(order.startTime, 'yyyy-MM-dd HH:mm')}"
										onclick="openCancelModal(this)" class="btn btn-danger">
										取消預約</button>
								</th:block>

								<th:block
									th:if="${order.orderStatus == 2 or order.orderStatus == 5 or ((order.orderStatus == 0 or order.orderStatus == 1) and isPast)}">
									<!-- <button class="btn btn-outline btn-sm">查看照顧紀錄</button> -->
<<<<<<< HEAD
									<button class="btn btn-outline btn-sm"
										th:onclick="injectEvalBox(this, [[${order.bookingOrderId}]], [[${order.sitterId}]])">評價保母</button>
=======
									<button class="btn btn-outline btn-sm">評價保母</button>
>>>>>>> master
								</th:block>

								<th:block th:if="${order.orderStatus == 3}">
									<span style="color: #ccc; font-size: 0.9rem; margin-right: 1rem;">訂單已結束</span>
								</th:block>
							</th:block>
						</div>
					</div>
				</div>

				<div th:if="${#lists.isEmpty(bookingList)}"
					style="text-align: center; padding: 5rem 0; background: white; border-radius: 2rem; border: 1px dashed #ddd;">
					<p style="color: #999;">目前沒有進行中的預約</p>
				</div>
			</div>
		</div>
	</div>
	<div id="cancelBookingModal"
		style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
		<div
			style="background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 450px; position: relative;">
			<button onclick="closeCancelModal()"
				style="position: absolute; right: 1.5rem; top: 1.5rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
			<h3 class="mb-2">取消預約</h3>
			<div id="refundInfoBox" class="mb-3 p-3" style="background: #f8f9fa; border-radius: 8px;"></div>
			<div class="d-flex gap-md">
				<button class="btn btn-outline" style="flex: 1; border-radius: 2rem;"
					onclick="closeCancelModal()">暫不取消</button>
				<button class="btn btn-primary" id="confirmCancelBtn"
					style="flex: 1; background: #fa5252; border-color: #fa5252; border-radius: 2rem;">確認取消並退款</button>
			</div>
		</div>
	</div>
	<footer id="main-footer" style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
	<script th:src="@{/js/frontend/main.js}"></script>
	<script th:src="@{/js/frontend/evaluate-functions.js}"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/
		const contextPath = /*[[@{/}]]*/ '';
		/*]]>*/

		let currentCancelId = null;

		function openCancelModal(btn) {
			const orderId = btn.getAttribute('data-id');
			const startDateStr = btn.getAttribute('data-start');

			currentCancelId = orderId;
			const infoBox = document.getElementById('refundInfoBox');

			// 計算退費邏輯
			const today = new Date();
			const bookingDate = new Date(startDateStr);
			const diffTime = bookingDate - today;
			const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

			if (diffDays >= 7) {
				infoBox.innerHTML = `
                <p style="color:#2f9e44; font-weight:600; margin:0;">符合全額退費條件</p>
                <p style="font-size:0.85rem; color:#666; margin:0.5rem 0 0 0;">預約編號：#BK-${orderId}<br>距離服務還有 ${diffDays} 天，取消將退還 100% 預約金。</p>`;
			} else if (diffDays > 0) {
				infoBox.innerHTML = `
                <p style="color:#ea580c; font-weight:600; margin:0;">酌收手續費 (退還 50%)</p>
                <p style="font-size:0.85rem; color:#666; margin:0.5rem 0 0 0;">預約編號：#BK-${orderId}<br>距離服務僅剩 ${diffDays} 天，取消將退還 50% 預約金。</p>`;
			} else {
				infoBox.innerHTML = `
                <p style="color:#fa5252; font-weight:600; margin:0;">不可退費</p>
                <p style="font-size:0.85rem; color:#666; margin:0.5rem 0 0 0;">預約編號：#BK-${orderId}<br>服務已開始或即將開始，目前取消不予退費。</p>`;
			}

			document.getElementById('cancelBookingModal').style.display = 'flex';

			// 綁定按鈕點擊事件 (確保只綁定一次)
			document.getElementById('confirmCancelBtn').onclick = function () {
				handleRefund(currentCancelId);
			};
		}

		function closeCancelModal() {
			document.getElementById('cancelBookingModal').style.display = 'none';
		}

		async function handleRefund(orderId) {
			const base = typeof contextPath !== 'undefined' ? contextPath : '';
			try {
				const response = await fetch(base + `/booking/refund/${orderId}`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' }
				});

				if (response.ok) {
					alert("取消成功！系統已自動處理退款審核。");
					window.location.reload();
				} else {
					const errorMsg = await response.text();
					alert("取消失敗：");
				}
			} catch (error) {
				console.error("Error:", error);
				alert("系統錯誤，請稍後再試。");
			}
			closeCancelModal();
		}

		// 顯示會員歷史評價
		async function showMemberReviews() {
			// 從 Thymeleaf Model 或 Session 取得名字，處理引號與空值
			let memName = /*[[${memName}]]*/ '';
			if (!memName || memName === '""' || memName === "''") {
				memName = /*[[${session.memName}]]*/ '會員';
			}
			if (!memName || memName === '""' || memName === "''") {
				memName = '會員';
			}

			const memId = Number(/*[[${session.memId}]]*/) || 0;
			const reviewsTab = document.getElementById('reviewsTab');
			const bookingListContainer = document.querySelector('.booking-list');

			// 移除所有標籤的 active 狀態
			document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
			// 設定評價標籤為 active
			reviewsTab.classList.add('active');

			try {
				const response = await fetch(`/pet/evaluate/member/${memId}`);
				const reviews = await response.json();

				// 清空訂單列表區域
				bookingListContainer.innerHTML = '';

				// 建立評價顯示區域（含收放功能）
				let reviewsHTML = `
					<div style="background: white; border-radius: 1.5rem; padding: 2rem; margin-bottom: 1.5rem;">
						<h3 style="cursor: pointer; user-select: none; margin-bottom: 1.5rem; color: #333;"
							onclick="toggleHistoryReviews('memberReviewsList', 'memberToggleIcon')">
							<i class="fas fa-comments"></i> ${memName} 的歷史評價
							<span style="color: #999; font-size: 0.9rem; margin-left: 10px;">(共 ${reviews.length} 筆)</span>
							<i id="memberToggleIcon" class="fas fa-chevron-down" 
								style="float: right; transition: transform 0.3s;"></i>
						</h3>
						<div id="memberReviewsList" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease;">
							<div id="memberReviewsContainer" class="reviews-container"></div>
							<!-- 分頁按鈕 -->
							<div id="memberReviewsPagination" class="pagination-container" 
								style="text-align: center; margin-top: 1.5rem; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;"></div>
						</div>
					</div>
				`;

				bookingListContainer.innerHTML = reviewsHTML;

				// 如果沒有評價
				if (reviews.length === 0) {
					document.getElementById('memberReviewsContainer').innerHTML = `
						<div style="text-align: center; padding: 3rem; color: #999;">
							<i class="far fa-comment-dots fa-3x" style="margin-bottom: 1rem; display: block;"></i>
							<p>目前尚無評價紀錄</p>
						</div>
					`;
					// 預設展開（沒有評價時）
					document.getElementById('memberReviewsList').style.maxHeight = '300px';
					return;
				}

				// 使用分頁功能（每頁 10 筆）
				initPagination(
					reviews,
					10,
					'memberReviewsContainer',
					'memberReviewsPagination',
					function (review) {
						const stars = renderStars(review.starRating || 0);
						const reviewDate = new Date(review.createTime).toLocaleDateString('zh-TW');
						// 優先顯示名字，如果沒有則顯示 ID
						const reviewerName = review.senderName || `保母 ID: ${review.senderId}`;
						return `
							<div class="review-card" style="
								border: none;
								border-bottom: 1px solid #eee; 
								padding: 1.5rem 1.2rem; 
								margin-bottom: 0.5rem;
							">
								<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
									<div style="display: flex; align-items: center; gap: 10px;">
										<strong style="font-size: 1.1rem; color: #2c3e50;">${reviewerName}</strong>
										<button class="btn btn-sm btn-outline-danger" 
											style="padding: 2px 8px; font-size: 0.8rem; margin-left: 10px;"
											onclick="reportReview(this, ${review.bookingOrderId})">
											<i class="fas fa-flag"></i> 檢舉
										</button>
									</div>
									<div style="color: #ffc107;">
										${stars}
									</div>
								</div>
								<p style="margin: 0.5rem 0; color: #666;">${review.content || ''}</p>
								<small style="color: #999;">${reviewDate}</small>
							</div>
						`;
					}
				);

				// 預設展開
				setTimeout(() => {
					const container = document.getElementById('memberReviewsList');
					container.style.maxHeight = container.scrollHeight + 'px';
					document.getElementById('memberToggleIcon').style.transform = 'rotate(180deg)';
				}, 100);

			} catch (error) {
				console.error('載入評價失敗:', error);
				alert('❗ 載入評價失敗，請稍後再試');
			}
		}

		// 註：檢舉功能已改用 complaint-functions.js 的 injectReportBox()

		// 渲染星星評分
		function renderStars(rating) {
			let stars = '';
			for (let i = 1; i <= 5; i++) {
				if (i <= rating) {
					stars += '<i class="fas fa-star"></i>';
				} else {
					stars += '<i class="far fa-star" style="color: #ddd;"></i>';
				}
			}
			return stars;
		}

	</script>

	<script src="/js/frontend/complaint-functions.js"></script>

</body>

</html>