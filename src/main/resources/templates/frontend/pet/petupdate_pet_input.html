<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
<title>ä¿®æ”¹å¯µç‰©è³‡æ–™</title>

<style>
  body {
    background-image: url("/images/pet/images1.jpg");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    font-family: Arial, sans-serif;
  }

  table {
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    background-color: rgba(255,255,255,0.9);
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    margin-bottom: 20px;
  }

  th, td {
    padding: 12px;
    border: 1px solid #ddd;
    vertical-align: middle;
  }

  th { background-color: #f8f9fa; }

  .submit_wrap {
    text-align: center;
    margin-top: 20px;
  }

  .submit_wrap input {
    padding: 10px 30px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  #successOverlay {
    display: none; /* åˆå§‹åŒ–éš±è— */
}
/* é–ƒçˆæ•ˆæœçš„å¹³æ»‘éæ¸¡ */
#countdownText {
    transition: opacity 0.2s ease-in-out;
}

#preview_img {
    max-width: 200px;
    border: 1px solid #ccc;
    cursor: pointer;
    display: block;    /* è®Šæˆå€å¡Šå…ƒç´  */
    margin: 10px auto; /* å·¦å³è‡ªå‹•é‚Šè·é”æˆæ°´å¹³ç½®ä¸­ */
}
</style>
</head>

<body>



<table id="table-1">
  <tr>
    <td><h3>ä¿®æ”¹å¯µç‰©è³‡æ–™</h3></td>
    <td>
      <h4>
        <a th:href="@{/pet/select_page}">å›é¦–é </a>
      </h4>
    </td>
  </tr>
</table>

<!-- éŒ¯èª¤è¨Šæ¯ -->
<div th:if="${errorMsgs != null}">
  <ul>
    <li th:each="msg : ${errorMsgs}"
        th:text="${msg}"
        style="color:red"></li>
  </ul>
</div>

<form th:action="@{/pet/update}"
      method="post"
      enctype="multipart/form-data">

<table>
  <tr>
    <td>å¯µç‰©ç·¨è™Ÿ:</td>
    <td th:text="${pet.petId}"></td>
  </tr>

  <tr>
    <td>æœƒå“¡ç·¨è™Ÿ:</td>
    <td>
<!--       /*/<input type="text"/*/ -->
<!--             /*/ name="memId"/*/ -->
<!--             /*/ th:value="${pet.memId}/*/" -->
<!--             /*/ readonly/*/ -->
<!--             /*/ style="background-color:#eee;"/*/ > -->
    </td>
  </tr>

  <tr>
    <td>å¯µç‰©é¡å‹:</td>
    <td>
      <select name="typeId">
        <option value="1" th:selected="${pet.typeId == 1}">è²“</option>
        <option value="2" th:selected="${pet.typeId == 2}">ç‹—</option>
      </select>
    </td>
  </tr>

  <tr>
    <td>å¯µç‰©å°ºå¯¸:</td>
    <td>
      <select name="sizeId">
        <option value="1" th:selected="${pet.sizeId == 1}">å°å‹</option>
        <option value="2" th:selected="${pet.sizeId == 2}">ä¸­å‹</option>
        <option value="3" th:selected="${pet.sizeId == 3}">å¤§å‹</option>
      </select>
    </td>
  </tr>

  <tr>
    <td>å¯µç‰©å§“å:</td>
    <td>
      <input type="text" name="petName"
             th:value="${pet.petName}" required/>
    </td>
  </tr>

  <tr>
    <td>å¯µç‰©æ€§åˆ¥:</td>
    <td>
      <select name="petGender">
        <option value="0" th:selected="${pet.petGender == 0}">æ¯</option>
        <option value="1" th:selected="${pet.petGender == 1}">å…¬</option>
      </select>
    </td>
  </tr>

  <tr>
    <td>å¯µç‰©å¹´é½¡:</td>
    <td>
      <input type="text" name="petAge"
             th:value="${pet.petAge}" />
    </td>
  </tr>

  <tr>
    <td>å¯µç‰©å‚™è¨»:</td>
    <td>
      <textarea name="petDescription"
                rows="4" cols="45"
                th:text="${pet.petDescription}"></textarea>
    </td>
  </tr>

  <tr>
  <td>å¯µç‰©åœ–ç‰‡:</td>
  <td>
    <div style="margin-bottom: 10px;">
      <img id="preview_img"
       style="max-width: 200px; border: 1px solid #ccc; cursor: pointer;" 
           th:src="@{/pet/img/{id}(id=${pet.petId})}"
           title="é»æ“Šæ›´æ›åœ–ç‰‡"
           onclick="document.getElementById('petImage').click();">
    </div>

    <input type="file" name="upFiles" id="petImage" accept="image/*" style="display: none;">
    <button type="button" onclick="document.getElementById('petImage').click();">é¸æ“‡åœ–ç‰‡</button>
    <button type="button" id="deleteImageBtn" style="background-color: #ff4d4d; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 2px 8px;">
      åˆªé™¤åœ–ç‰‡
    </button>
  </td>
</tr>
</table>

<input type="hidden" name="memId" th:value="${pet.memId}">
<input type="hidden" name="petId" th:value="${pet.petId}">


<div class="submit_wrap">
  <input type="submit" value="é€å‡ºä¿®æ”¹">
</div>

</form>

<div id="successOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; color:white; text-align:center; flex-direction:column; justify-content:center; align-items:center;">
    <h2 style="color: #4CAF50; margin-bottom: 10px;">æ›´æ–°ç¢ºèª</h2>
    
    <div id="previewContainer" style="margin: 20px auto; border: 3px solid #555; background: #222; min-width: 300px; min-height: 200px; display: flex; align-items:center; justify-content:center;">
        <img id="finalPreview" style="max-width: 450px; max-height: 350px; display: none;">
        <div id="noImageText" style="display: none; padding: 40px; color: #aaa;">(æ­¤å¯µç‰©ç›®å‰ç„¡åœ–ç‰‡)</div>
    </div>

    <p style="font-size: 20px;">ç³»çµ±å°‡åœ¨ <span id="countdownText" style="font-size: 36px; font-weight: bold; color: yellow;">10</span> ç§’å¾Œè‡ªå‹•å„²å­˜ä¸¦è·³è½‰</p>
    
    <div style="margin-top: 20px;">
        <button type="button" onclick="finalizeSubmitNow()" style="padding: 12px 25px; font-size: 18px; cursor: pointer; background:#4CAF50; color:white; border:none; border-radius:5px; margin-right: 15px;">ç«‹å³æ›´æ–°</button>
        <button type="button" onclick="cancelSubmission()" style="padding: 12px 25px; font-size: 18px; cursor: pointer; background:#666; color:white; border:none; border-radius:5px;">è¿”å›ä¿®æ”¹</button>
    </div>
</div>

<!-- <div th:unless="${session.memId == pet.memId}" style="text-align: center; margin-top: 50px;"> -->
<!--     <div style="background: white; display: inline-block; padding: 20px; border-radius: 10px;"> -->
<!--         <h2 style="color: red;">æŠ±æ­‰ï¼æ‚¨ä¸æ˜¯æ­¤å¯µç‰©çš„ä¸»äººï¼Œç„¡æ³•é€²è¡Œä¿®æ”¹ã€‚</h2> -->
<!--         <p>è«‹ç¢ºèªæ‚¨çš„ç™»å…¥å¸³è™Ÿæ˜¯å¦æ­£ç¢ºã€‚</p> -->
<!--         <a th:href="@{/pet/all}">è¿”å›å¯µç‰©åˆ—è¡¨</a> -->
<!--     </div> -->
<!-- </div> -->

<script th:inline="javascript">
    /* 1. åˆå§‹åŒ–è³‡æ–™ï¼šé€é Thymeleaf å–å¾—åŸå§‹æ•¸å€¼ä¾› JS æ¯”å°è®Šå‹• */
    
    
    const oriData = {
        name: /*[[${pet.petName}]]*/ '',
        age: /*[[${pet.petAge}]]*/ '',
        gender: /*[[${pet.petGender}]]*/ ''
    };
    const hasOldImage = /*[[${pet.petId != null}]]*/ false; 

    const fileInput = document.getElementById("petImage");
    const previewImg = document.getElementById("preview_img");
    const updateForm = document.querySelector('form');
    let isDeleted = false; // è¿½è¹¤ä½¿ç”¨è€…æ˜¯å¦é»æ“Šäº†åˆªé™¤æŒ‰éˆ•

    window.onload = function() {
    	updateForm.dataset.submitting = 'false';
        const savedData = JSON.parse(sessionStorage.getItem("pending_data"));
        if (savedData) {
            // å›å¡«æ–‡å­—æ¬„ä½
            document.querySelector('input[name="petName"]').value = savedData.petName;
            document.querySelector('input[name="petAge"]').value = savedData.petAge;
            document.querySelector('select[name="petGender"]').value = savedData.petGender;
            document.querySelector('textarea[name="petDescription"]').value = savedData.petDescription;
            document.querySelector('select[name="typeId"]').value = savedData.typeId;
            document.querySelector('select[name="sizeId"]').value = savedData.sizeId;
            
            // è™•ç†åœ–ç‰‡å›å¡«ï¼šå¦‚æœæ˜¯åˆªé™¤ç‹€æ…‹ï¼Œå°±éš±è—åœ–ç‰‡ï¼›å¦‚æœæœ‰æš«å­˜åœ–ï¼Œå°±é¡¯ç¤ºæš«å­˜åœ–
            if (savedData.deleteImage === "true") {
                isDeleted = true;
                previewImg.src = "";
                previewImg.style.display = 'none';
            } else if (savedData.img_base64 && savedData.img_base64.startsWith("data:image")) {
                previewImg.src = savedData.img_base64;
                previewImg.style.display = 'block';
            }
        }
    };
    
 // 1. åœ–ç‰‡é è¦½åŠŸèƒ½
    fileInput.onchange = function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                isDeleted = false;
            };
            reader.readAsDataURL(file);
        }
    };
    
    // 2. ç›£è½åˆªé™¤æŒ‰éˆ• (å‡è¨­ä½ æœ‰ä¸€å€‹ id="deleteImageBtn" çš„æŒ‰éˆ•)
    const deleteBtn = document.getElementById("deleteImageBtn");
    if (deleteBtn) {
        deleteBtn.onclick = function() {
            if (confirm("ç¢ºå®šè¦ç§»é™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ")) {
                isDeleted = true;
                if (previewImg) {
                    previewImg.src = "";
                    previewImg.alt = "å·²åˆªé™¤åœ–ç‰‡";
                }
                fileInput.value = ""; // æ¸…ç©ºæª”æ¡ˆé¸æ“‡å™¨
            }
        };
    }

 // 3. ç›£è½è¡¨å–®é€å‡º (æ ¸å¿ƒé‚è¼¯ä¿®æ­£)
    updateForm.addEventListener('submit', function(e) {
    	e.preventDefault(); // å…ˆæ””æˆªæ‰€æœ‰é€å‡º
        if (this.dataset.submitting === 'true') return;
        
     // ğŸ”´ 1. å–å¾—å§“åæ¬„ä½ä¸¦æª¢æŸ¥
        const nameInput = document.querySelector('input[name="petName"]');
        if (!nameInput.value.trim()) {
            alert("è«‹è¼¸å…¥å¯µç‰©å§“åï¼"); // æˆ–è€…ç”¨è‡ªå®šç¾©çš„è­¦å‘Šæ¨£å¼
            nameInput.focus();
            return; // æ””æˆªï¼Œä¸å¾€ä¸‹åŸ·è¡Œ
        }

        this.dataset.submitting = 'true';
        if (isDeleted) {
            submitWithDelete(this);
            return;
        }

        const hasNewFile = fileInput.files.length > 0;

        if (!hasNewFile) {
            // --- éœ€æ±‚ï¼šæŒ‰ç¢ºèªç›´æ¥ä¿ç•™åŸåœ–é€å‡ºï¼ŒæŒ‰å–æ¶ˆç•™åœ¨åŸé é¢ ---
            const msg = "æ‚¨å°šæœªé¸æ“‡æ–°åœ–ç‰‡ï¼Œæ˜¯å¦ä¿ç•™åŸåœ–ä¸¦é€å‡ºä¿®æ”¹ï¼Ÿ";
            if (confirm(msg)) {
                // ä½¿ç”¨è€…æŒ‰ã€Œç¢ºå®šã€ï¼šæª¢æŸ¥è³‡æ–™æ˜¯å¦æœ‰è®Šï¼Œæœ‰è®Šå°±å°å­—ï¼Œæ²’è®Šå°±ç›´é€
                processCanvasOrSubmit(this);
            } else {
                // ä½¿ç”¨è€…æŒ‰ã€Œå–æ¶ˆã€ï¼šç•™åœ¨åŸé é¢
                console.log("ç•™åœ¨åŸé é¢");
            }
        } else {
            // æœ‰æ–°åœ–ï¼Œç›´æ¥è·‘ç¹ªåœ–æµç¨‹
            processCanvasOrSubmit(this);
            
        }
    });

        

    function submitWithDelete(form) {
        // å–å¾—ç•¶å‰è¼¸å…¥çš„å€¼ï¼Œç¢ºä¿ç¢ºèªé é¢é¡¯ç¤ºçš„æ˜¯æœ€æ–°çš„æ–‡å­—
        const currentName = document.querySelector('input[name="petName"]').value;
        const currentAge = document.querySelector('input[name="petAge"]').value;
        const currentGender = document.querySelector('select[name="petGender"]').value;

        const pendingData = {
            petId: document.querySelector('input[name="petId"]').value,
            memId: document.querySelector('input[name="memId"]').value,
            petName: currentName,
            petAge: currentAge,
            petGender: currentGender,
            typeId: document.querySelector('select[name="typeId"]').value,  // ğŸ”´ ç¢ºä¿åç¨±å°æ‡‰ VO
            sizeId: document.querySelector('select[name="sizeId"]').value,  // ğŸ”´ ç¢ºä¿åç¨±å°æ‡‰ VO
            petDescription: document.querySelector('textarea[name="petDescription"]').value,
            deleteImage: isDeleted ? "true" : "false",
            img_base64: "",       
            fromPage: window.location.href
        };

        saveAndRedirect(pendingData); 
    }
   
        
        
  // ä¿®æ”¹ï¼šåŸæœ¬çš„æ ¸å¿ƒåŠŸèƒ½
     function processCanvasOrSubmit(formElement) {
    const currentName = document.querySelector('input[name="petName"]').value;
    const currentAge = document.querySelector('input[name="petAge"]').value;
    const currentGender = document.querySelector('select[name="petGender"]').value;

    const hasChanged = currentName !== oriData.name || currentAge != oriData.age || currentGender != oriData.gender;
    const hasImageNow = previewImg && previewImg.src && !isDeleted && previewImg.style.display !== 'none';
    const isNewFile = fileInput.files.length > 0;

    const pendingData = {
        petId: document.querySelector('input[name="petId"]').value,
        memId: document.querySelector('input[name="memId"]').value,
        petName: currentName,
        petAge: currentAge,
        petGender: currentGender, // é€™è£¡é…åˆä½  confirm é é¢çš„è®Šæ•¸å
        typeId: document.querySelector('select[name="typeId"]').value,
        sizeId: document.querySelector('select[name="sizeId"]').value,
        petDescription: document.querySelector('textarea[name="petDescription"]').value,
        deleteImage: isDeleted ? "true" : "false",
        img_base64: "",
        fromPage: window.location.href
    };
   

    if (hasImageNow && (hasChanged || isNewFile)) {
        // ã€æƒ…å¢ƒï¼šæœ‰åœ–ä¸”è³‡æ–™è®Šæ›´ã€‘ -> ç¹ªè£½ç•«å¸ƒ
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = function() {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);

            const fontSize = Math.max(Math.floor(canvas.width / 20), 24);
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.fillStyle = "red";
            ctx.strokeStyle = "white";
            ctx.lineWidth = fontSize / 10;

            const textLines = [
                "åç¨±ï¼š" + currentName,
                "å¹´é½¡ï¼š" + currentAge,
                "æ€§åˆ¥ï¼š" + (currentGender == "1" ? "å…¬" : "æ¯")
            ];

            let yPos = fontSize + 20;
            
            const lineSpacing = fontSize * 1.5;

            const lineHeight = 60; // æ¯è¡Œé–“éš” 60 åƒç´ 

            textLines.forEach(line => {
                ctx.strokeText(line, 30, yPos);
                ctx.fillText(line, 30, yPos);
                yPos += lineSpacing; // é€™è£¡æ§åˆ¶è¡Œé–“è·
            });

            pendingData.img_base64 = canvas.toDataURL("image/jpeg", 0.8);
            saveAndRedirect(pendingData); // ğŸ”´ å‘¼å«è·³è½‰
        };
        img.src = previewImg.src;
    } else {
        // ã€æƒ…å¢ƒï¼šæ²’åœ– æˆ– æ²’æ”¹è³‡æ–™ã€‘ -> ç›´æ¥å¸¶åœ– URL æˆ–ç©ºå€¼
        pendingData.img_base64 = hasImageNow ? previewImg.src : "";
        saveAndRedirect(pendingData); // ğŸ”´ å‘¼å«è·³è½‰
    }
}

// ğŸ”´ å¿…é ˆå®šç¾©åœ¨æœ€å¤–å±¤ (Global Scope)
function saveAndRedirect(data) {
    sessionStorage.setItem("pending_data", JSON.stringify(data));
    window.location.href = "/pet/confirm";
}


</script>


<footer id="main-footer" style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
 <script th:src="@{/js/frontend/main.js}"></script>
</body>
</html>