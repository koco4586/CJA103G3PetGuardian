<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Full Image Page</title>

    <link rel="stylesheet" th:href="@{/css/frontend/style.css}">
    <link rel="stylesheet" th:href="@{/css/frontend/components.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/frontend/dashboard.css}">
    <style>
        /* é‡é»å°±åœ¨é€™è£¡ */
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
        }

        body {
            background-image: url("/images/pet/dc.jpg");
            background-size: cover;
            /* å¡«æ»¿ */
            background-position: center;
            /* ç½®ä¸­ */
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            /* æ”¹ç”¨ min-height ç¢ºä¿èƒŒæ™¯å»¶ä¼¸ */
            display: flex;
            /* ä½¿ç”¨ flex è®“å…§å®¹å±…ä¸­ */
            flex-direction: column;
        }

        .info {
            position: relative;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.95);
            /* ç¨å¾®èª¿é«˜ä¸é€æ˜åº¦å¢åŠ è¾¨è­˜åº¦ */
            margin: 120px auto 50px;
            /* å¢åŠ ä¸Šæ–¹é‚Šè· (120px)ï¼Œé¿é–‹é€šç”¨å°è¦½åˆ— */
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            /* è¡Œå‹•å„ªå…ˆ */
            max-width: 900px;
            /* ç¨å¾®æ”¾å¯¬ï¼Œè®“å·¦å³å…©æ¬„å¼æ’ç‰ˆæ›´é¬†æ•£ */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            /* é‡è¦ï¼šé˜²æ­¢ padding æ’é–‹å¯¬åº¦ */
        }

        /* 3. ä¿®å¾©å…§å®¹ç‰©æ’åˆ— (å·¦åœ–å³å­—) */
        .content_block {
            display: flex;
            flex-wrap: wrap;
            /* è¢å¹•å¤ªå°æ™‚è‡ªå‹•æ›è¡Œ */
            gap: 30px;
            justify-content: center;
        }

        .left_block,
        .right_block {
            flex: 1;
            min-width: 300px;
            /* ç¢ºä¿å°è¢å¹•æ™‚ä¸æœƒç¸®å¤ªçª„ */
        }

        /* 4. çµ±ä¸€è¡¨å–®æ¬„ä½æ¨£å¼ï¼Œå°é½Šçµ„å“¡é¢¨æ ¼ */
        .block {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            /* æ¨™ç±¤åœ¨ä¸Šï¼Œè¼¸å…¥æ¡†åœ¨ä¸‹ */
        }

        .block label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .block input[type="text"],
        .block input[type="number"],
        .block select,
        .block textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* 5. ç¢ºä¿é è¦½åœ–ä¸æœƒæ’ç ´å®¹å™¨ */
        .drop_zone {
            width: 100%;
            max-width: 400px;
            height: auto;
            min-height: 250px;
            margin: 0 auto;
            overflow: hidden;
            /* éš±è—æº¢å‡ºéƒ¨åˆ† */
        }

        .preview_img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
            /* ä¿æŒæ¯”ä¾‹ */
        }

        #p_file {
            display: none !important;
        }

        /* è®“å‚™è¨»å¯¬åº¦èˆ‡é è¦½åœ–ä¸€è‡´ */
        .left_block .block {
            width: 100%;
            max-width: 400px;
            /* è·Ÿé è¦½åœ–æœ€å¤§å¯¬åº¦ä¸€è‡´ */
        }
    </style>
</head>

<body>

    <header id="main-header" class="header"></header>

    <article class="info">
        <form action="#" method="#" id="the_form">
            <div class="content_block">

                <div class="left_block">
                    <button type="button" class="select-btn">é¸æ“‡åœ–ç‰‡</button>
                    <input type="file" id="p_file">
                    <div id="preview" class="drop_zone">

                        <!-- ä¸Šé¢ç›´æ¥åœ¨oneå¾Œé¢åŠ ä¸Šonä¹Ÿå¯ä»¥ -->
                        <span class="text">é è¦½åœ–</span>
                    </div>

                    <div class="block" style="margin-top: 20px;">
                        <label>å¯µç‰©å‚™è¨»ï¼š</label><br>
                        <textarea id="p_desc" rows="5"
                            style="width: 100%; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                    </div>
                </div>

                <div class="right_block">

                    <div class="block">
                        <label>å¯µç‰©åç¨±ï¼š</label> <input type="text" id="p_name" autocomplete="off">
                    </div>

                    <div class="block">
                        <label>å¯µç‰©ç¨®é¡ï¼š</label> <select id="p_type">
                            <option value="1">è²“</option>
                            <option value="2">ç‹—</option>
                        </select>
                    </div>

                    <div class="block">
                        <label>å¯µç‰©æ€§åˆ¥ï¼š</label> <select id="p_Gender">
                            <option value="0">æ¯</option>
                            <option value="1">å…¬</option>
                        </select>
                    </div>

                    <div class="block">
                        <label>å¯µç‰©å¹´é½¡ï¼š</label> <input type="text" id="p_age" autocomplete="off">
                    </div>

                    <div class="block">
                        <label>å¯µç‰©å°ºå¯¸ï¼š</label> <select id="p_size">
                            <option value="1">å°å‹</option>
                            <option value="2">ä¸­å‹</option>
                            <option value="3">å¤§å‹</option>
                        </select>
                    </div>



                    <div class="block">
                        <label>ç¶“åº¦ï¼š</label><input type="text" id="lng" readonly> <label>ç·¯åº¦ï¼š</label><input type="text"
                            id="lat" readonly>
                    </div>

                </div>

            </div>

            <footer class="footer">
                <div class="action_block">
                    <div class="left_block">
                        <button type="button" id="btn_fullscreen">é€²å…¥å…¨è¢å¹•æ¨¡å¼</button>
                    </div>

                    <div class="right_block">
                        <button type="reset">æ¸…ç©ºè³‡æ–™</button>
                        <button type="submit" id="btn_submit">é€å‡ºè³‡æ–™</button>
                        <button type="button" id="btn_home"
                            style="background-color: #6c757d; color: white;">å›åˆ°é¦–é </button>
                    </div>
                </div>
                <p>
                    æ˜¯å¦æœ‰æ”¯æ´å…¨è¢å¹•æ¨¡å¼ï¼š<span id="fullscreen_enable"></span>
                </p>
                <p>
                    æ˜¯å¦æœ‰æ”¯æ´åœ°ç†è³‡è¨Šå®šä½ï¼š<span id="geolocation_enable"></span>
                </p>
            </footer>
        </form>
    </article>

    <script>

        // --- å®£å‘Š DOM å…ƒç´  ---
        var the_html = document.documentElement;
        var the_form_el = document.getElementById("the_form");
        var p_name_el = document.getElementById("p_name");
        var p_type_el = document.getElementById("p_type"); // æ–°å¢
        var p_Gender_el = document.getElementById("p_Gender");
        var p_age_el = document.getElementById("p_age");
        var p_size_el = document.getElementById("p_size"); // æ–°å¢
        var p_desc_el = document.getElementById("p_desc"); // æ–°å¢
        var lng_el = document.getElementById("lng");
        var lat_el = document.getElementById("lat");
        var btn_fullscreen_el = document.getElementById("btn_fullscreen");
        var fullscreen_enable_el = document.getElementById("fullscreen_enable");
        var geolocation_enable_el = document.getElementById("geolocation_enable");
        var preview_el = document.getElementById("preview");
        var p_file_el = document.getElementById("p_file");


        var original_base64_temp = "";


        // --- åˆå§‹åŒ–é è¦½åœ–å€åŸŸçš„ HTML ---
        var preview_default_html = '<span class="text">é è¦½åœ–</span>';


        // è™•ç†è®€å–æª”æ¡ˆä¸¦é¡¯ç¤ºé è¦½åœ–çš„å‡½å¼
        var handleFiles = function (files) {
            if (files && files.length > 0) {
                var file = files[0];
                if (file.type.indexOf("image") !== -1) {
                    var reader = new FileReader();
                    reader.addEventListener("load", function (e) {
                        // éœ€æ±‚ 1 & 3ï¼šå‘ˆç¾é è¦½åœ–ä¸¦åŠ ä¸Š preview_img class

                        var img = new Image();
                        img.src = e.target.result;

                        img.onload = function () {
                            var canvas = document.createElement("canvas");
                            var ctx = canvas.getContext("2d");

                            // --- ğŸ“ ç­‰æ¯”ä¾‹ç¸®æ”¾é‚è¼¯ ---
                            var maxWidth = 600; // è¨­å®šæœ€å¤§å¯¬åº¦
                            var scale = 1;      // é è¨­æ¯”ä¾‹ç‚º 1

                            if (img.width > maxWidth) {
                                scale = maxWidth / img.width;
                            }

                            // æ ¹æ“šæ¯”ä¾‹è¨­å®šç•«å¸ƒå¯¬é«˜
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;

                            // --- ğŸ¨ ç¹ªè£½ä¸¦å£“ç¸® ---
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            // è¼¸å‡ºç‚º JPEGï¼Œ0.6 ä»£è¡¨å“è³ªï¼Œç¢ºä¿ä½æ–¼ 64KB
                            var compressedBase64 = canvas.toDataURL("image/jpeg", 0.6);

                            // æ›´æ–°è®Šæ•¸èˆ‡é è¦½
                            original_base64_temp = compressedBase64;
                            preview_el.innerHTML = '<img src="' + compressedBase64 + '" class="preview_img">';
                        };


                    });
                    reader.readAsDataURL(file);
                }
            } else {
                // éœ€æ±‚ 2ï¼šå¦‚æœæŒ‰å–æ¶ˆï¼ˆfilesé•·åº¦ç‚º0ï¼‰ï¼Œå›åˆ°åŸä»‹é¢
                preview_el.innerHTML = preview_default_html;
                original_base64_temp = "";
            }
        };



        //reset æŒ‰éˆ•æŒ‰ä¸‹å»çš„æ™‚å€™è§¸ç™¼
        //form

        the_form_el.addEventListener("reset", function () {

            preview_el.innerHTML = preview_default_html;
            // æ¸…ç©ºè³‡æ–™æ™‚ï¼Œå°‡é è¦½åœ–å›åˆ°åŸä»‹é¢
            sessionStorage.removeItem("pending_data");
            setTimeout(function () {
                check_geolocation_enabled_el();
            }, 0);
        });



        var btn_home_el = document.getElementById("btn_home");

        // 2. ç¶å®šé»æ“Šäº‹ä»¶
        btn_home_el.addEventListener("click", function () {
            // è©¢å•ä½¿ç”¨è€…ï¼Œé¿å…èª¤é»å°è‡´è³‡æ–™æ¶ˆå¤±
            if (confirm("ç¢ºå®šè¦é›¢é–‹ä¸¦å›åˆ°é¦–é å—ï¼Ÿæœªå„²å­˜çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚")) {
                // æ¸…é™¤é€™ä¸€æ¬¡çš„æš«å­˜è³‡æ–™ï¼ˆé¸é¸ï¼šå¦‚æœä½ å¸Œæœ›å›é¦–é å¾Œä¸‹æ¬¡é€²ä¾†æ˜¯ä¹¾æ·¨çš„ï¼‰
                sessionStorage.removeItem("pending_data");

                window.location.href = "/pet/dashboard"; // é€™è£¡å¡«å…¥ä½ é¦–é çš„ç¶²å€ï¼Œä¾‹å¦‚ "/" æˆ– "/index"
            }
        });




        // å†æ¬¡æŠ“å–ç¶“ç·¯åº¦æ”¾å›æ¬„ä½

        /* // ã€åŠŸèƒ½ï¼šæ¸…ç©ºå¾Œä¸è¦é‡æ–°æŠ“å–ï¼Œè®“æ¬„ä½ä¿æŒæ¸…ç©ºã€‘ (è‹¥æƒ³æ›æˆé€™åŠŸèƒ½ï¼Œè«‹å–æ¶ˆè¨»è§£ä¸‹é¢ï¼Œä¸¦è¨»è§£æ‰ä¸Šé¢çš„ setTimeout)
    // lng_el.value = "";
    // lat_el.value = "";
    */

        document.addEventListener("DOMContentLoaded", function () {
            var select_btn_el = document.querySelector(".select-btn");
            var p_file_el = document.getElementById("p_file");

            if (select_btn_el && p_file_el) {
                select_btn_el.addEventListener("click", function () {
                    p_file_el.click(); // æ‰‹å‹•é»æ“Šéš±è—çš„ input file
                });
            }
        });

        // é»æ“Š ã€Œé è¦½åœ–ã€ å€åŸŸï¼Œè·³å‡ºé¸åœ–çš„å½ˆçª—
        preview_el.addEventListener("click", function () {
            p_file_el.click(); // è§¸ç™¼éš±è—çš„ input file
        });

        // æª”æ¡ˆé¸å–è®Šæ›´æ™‚

        p_file_el.addEventListener("change", function () {
            handleFiles(this.files);
        });


        // ä»¥ä¸‹ä¸‰æ­¥åœ¨æ­¥é©Ÿä¸€ä¸éœ€è¦
        // check_geolocation_enabled();
        //preview_el.innerHTML = '<span class="text">é è¦½åœ–</span>';


        //============================fullscreen
        //åˆ¤æ–·æœ‰ç„¡æ”¯æ´å…¨è¢å¹•
        var check_fullscreen_enabled = function () {
            //console.log(document.fullscreenEnabled);
            if (document.fullscreenEnabled) {
                fullscreen_enable_el.innerHTML = "æ˜¯";
            } else {
                fullscreen_enable_el.innerHTML = "å¦";
            }
        };

        //fullscreen
        btn_fullscreen_el.addEventListener("click", function () {
            //console.log(document.fullscreenElement );
            if (document.fullscreenElement) {//é€€å‡ºå…¨è¢å¹•
                document.exitFullscreen();
                this.innerHTML = "é€²å…¥å…¨è¢å¹•æ¨¡å¼";

            } else {
                the_html.requestFullscreen();
                this.innerHTML = "é€€å‡ºå…¨è¢å¹•æ¨¡å¼";
            }
        });

        document.addEventListener("fullscreenchange", function (e) {
            //console.log(document.fullscreenElement)
            if (!document.fullscreenElement) {
                btn_fullscreen_el.innerHTML = "é€²å…¥å…¨è¢å¹•æ¨¡å¼";
            }
        });

        // ======================== geolocation =========================

        // åˆ¤æ–·æœ‰ç„¡åœ°ç†è³‡è¨Šå®šä½
        var check_geolocation_enabled_el = function () {
            if (navigator.geolocation) {
                geolocation_enable_el.innerHTML = "æ˜¯";

                // å–å¾— geolocation
                navigator.geolocation.getCurrentPosition(function (position) {
                    // console.log(position);
                    // console.log("æŠ“åˆ°æ–°åº§æ¨™äº†ï¼", position.coords.longitude);
                    lng_el.value = position.coords.longitude;
                    lat_el.value = position.coords.latitude;

                    // lng_el.disabled = false;
                    // lat_el.disabled = false;
                }, function (error) {
                    lng_el.disabled = true;
                    lat_el.disabled = true;
                    console.warn("å®šä½å¤±æ•—åŸå› ä»£ç¢¼: " + error.code + " è¨Šæ¯: " + error.message);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                });
            } else {
                geolocation_enable_el.innerHTML = "å¦";
            }
        };



        // ========================== Drag and Drop ==========================

        // ç•¶æª”æ¡ˆæ‹–æ›³é€²å…¥å€åŸŸ
        preview_el.addEventListener("dragenter", function (e) {
            e.preventDefault();
            // éœ€æ±‚ 1ï¼šåŠ ä¸Š -on class
            this.classList.add("-on");
        });

        // ç•¶æª”æ¡ˆåœ¨å€åŸŸä¸Šæ–¹ç§»å‹•
        preview_el.addEventListener("dragover", function (e) {
            e.preventDefault(); // å¿…é ˆå‘¼å«ï¼Œæ‰èƒ½è§¸ç™¼ drop äº‹ä»¶
        });

        // ç•¶æª”æ¡ˆé›¢é–‹å€åŸŸ
        preview_el.addEventListener("dragleave", function (e) {
            e.preventDefault();
            // éœ€æ±‚ 1ï¼šç§»é™¤ -on class
            this.classList.remove("-on");
        });

        // ç•¶æª”æ¡ˆæ”¾ä¸‹æ™‚
        preview_el.addEventListener("drop", function (e) {
            e.preventDefault(); // éœ€æ±‚ï¼šå…è¨±å–å¾—æª”æ¡ˆ
            // ç§»é™¤ -on class
            this.classList.remove("-on");
            //å¿…é ˆåŠ ä¸Še.é‚£æ®µï¼Œæ‰ä¸æœƒç›´æ¥é–‹å•Ÿåœ–æª”
            // å–å¾— FileList ç‰©ä»¶ä¸¦å°å‡º
            var files = e.dataTransfer.files;
            // console.log(files);
            handleFiles(files);
        });

        the_form_el.addEventListener("submit", function (e) {
            e.preventDefault(); // æ””æˆªè·³è½‰

            // --- ğŸ”´ æ–°å¢ï¼šå¯µç‰©åç¨±éç©ºé©—è­‰ ---
            if (p_name_el.value.trim() === "") {
                alert("è«‹è¼¸å…¥åå­—ï¼");
                p_name_el.focus();
                return;
            }

            if (!original_base64_temp || original_base64_temp.trim() === "") {
                alert("è«‹ä¸Šå‚³åœ–ç‰‡ï¼");
                return;
            }

            // å–å¾—åœ–ç‰‡ Base64 (å¾é è¦½åœ–çš„ src æ‹¿)


            // 6. è½‰å­˜ Base64 ä¸¦è·³è½‰

            const form_data = {
                petImage: original_base64_temp,
                original_base64: original_base64_temp,

                petName: p_name_el.value,          // â† æ”¹å
                typeId: p_type_el.value,          // â† æ–°å¢
                petGender: p_Gender_el.value,            // â† æ”¹å
                petAge: p_age_el.value,            // â† æ”¹å
                sizeId: p_size_el.value,          // â† æ–°å¢
                petDescription: p_desc_el.value,          // â† æ–°å¢
                lng: lng_el.value,                 // â† æ”¹ç”¨é€™æ¨£æ¯”è¼ƒæ¸…æ¥š
                lat: lat_el.value
            };

            sessionStorage.setItem("pending_data", JSON.stringify(form_data));
            location.href = "/pet/confirm";
        });
        lng_el.disabled = false;
        lat_el.disabled = false;

        // =================== session è£¡çš„è³‡æ–™å›å¯«åˆ°è¡¨å–®ä¸­ ===================
        var recovery_data = function () {
            // æª¢æŸ¥ referrerï¼Œå¦‚æœä¸æ˜¯å¾ confirm é é¢å›ä¾†çš„ï¼Œå°±æ¸…é™¤æš«å­˜ (è§£æ±ºæ®˜ç•™å•é¡Œ)
            const referrer = document.referrer;
            if (!referrer.includes("/pet/confirm")) {
                console.log("ğŸ§¹ éå¾ç¢ºèªé é¢è¿”å›ï¼Œæ¸…é™¤æš«å­˜è³‡æ–™");
                sessionStorage.removeItem("pending_data");
                original_base64_temp = "";
                return;
            }

            // 1. æ”¹è®€å– pending_data (èˆ‡é€å‡ºæ™‚çš„ Key ä¸€è‡´)
            var savedData = sessionStorage.getItem("pending_data");

            // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å°±ç›´æ¥çµæŸ
            if (savedData === null || savedData === "null") {
                return;
            }

            var data = JSON.parse(savedData);

            // 2. å›å¡«æ–‡å­—æ¬„ä½ (ä½¿ç”¨ data ç‰©ä»¶ä¸­çš„å±¬æ€§åç¨±)
            if (p_name_el) p_name_el.value = data.petName || "";
            if (p_type_el) p_type_el.value = data.typeId || "";
            if (p_Gender_el) p_Gender_el.value = data.petGender || "0";
            if (p_age_el) p_age_el.value = data.petAge || "";
            if (p_size_el) p_size_el.value = data.sizeId || "1";
            if (p_desc_el) p_desc_el.value = data.petDescription || "";
            if (lng_el) lng_el.value = data.lng || "";
            if (lat_el) lat_el.value = data.lat || "";

            // 3. åœ–ç‰‡éƒ¨åˆ†
            if (data.original_base64) {
                original_base64_temp = data.original_base64;
                if (original_base64_temp.length > 100) {
                    preview_el.innerHTML = '<img src="' + original_base64_temp + '" class="preview_img">';
                } else {
                    preview_el.innerHTML = preview_default_html;
                }
            }
        };




        // ========================== å‡½å¼è§¸ç™¼ ==========================
        // reset_p_count_value();
        check_fullscreen_enabled();
        check_geolocation_enabled_el();
        recovery_data();





    </script>


    <footer id="main-footer" style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
    <script th:src="@{/js/frontend/main.js}"></script>


</body>

</html>