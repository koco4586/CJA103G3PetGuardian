<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Full Image Page</title>

<style>
/* é‡é»å°±åœ¨é€™è£¡ */
html, body {
	width: 100%;
	height: 100%;
	margin: 0;
}

body {
	background-image: url("/images/pet/dc.jpg");
	background-size: cover; /* å¡«æ»¿ */
	background-position: center; /* ç½®ä¸­ */
	background-repeat: no-repeat;
	background-attachment: fixed;
}

/* åŠŸèƒ½å±¤ï¼ˆä¹‹å¾Œç”¨ï¼‰ */
.content {
	position: absolute;
	inset: 0;
	display: flex;
	align-items: center;
	justify-content: center;
	color: white;
	font-size: 2rem;
	text-shadow: 0 2px 10px black;
}

.info {
	position: relative;
	z-index: 10;
	background-color: rgba(255, 255, 255, 0.9); /* ç™½è‰²åŠé€æ˜ */
	margin: 50px auto;
	padding: 20px;
	border-radius: 10px;
	max-width: 800px; /* é™åˆ¶å¯¬åº¦ï¼Œä¸è¦è®“å®ƒè·ŸèƒŒæ™¯ä¸€æ¨£å¤§ */
	box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* ç¢ºä¿é è¦½åœ–å€åŸŸæœ‰æ˜é¡¯çš„å¤–æ¡† */
.drop_zone {
    min-width: 200px;
    min-height: 200px;
    width: fit-content;    /* é—œéµï¼šå¯¬åº¦éš¨å…§å®¹æ’é–‹ */
    height: fit-content;   /* é—œéµï¼šé«˜åº¦éš¨å…§å®¹æ’é–‹ */
    border: 2px dashed #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background-color: #f9f9f9;
    padding: 10px;         /* ç•™ä¸€é»é‚Šè·æ¯”è¼ƒç¾è§€ */
}

/* è®“åœ–ç‰‡é¡¯ç¤ºåŸå§‹æ¯”ä¾‹ï¼Œä¸å¼·è¿«å¡«æ»¿ */
.preview_img {
    display: block;
    max-width: 400px;      /* å»ºè­°è¨­å®šä¸€å€‹æœ€å¤§å¯¬åº¦ï¼Œé¿å…åŸåœ–å¤ªå¤§ä½¿é é¢è®Šå½¢ */
    height: auto;
}
#p_file { display: none; }

#btn_home {
    padding: 12px 30px;
    font-size: 1.1rem;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    margin-right: 10px;
    background-color: #007bff; /* è—è‰² */
    color: white;
    transition: 0.3s;
}

#btn_home:hover {
    background-color: #0056b3; /* æ»‘é¼ ç§»ä¸Šå»è®Šæ·±è— */
}
</style>
</head>
<body>

<header id="main-header" class="header"></header>

	<article class="info">
		<form action="#" method="#" id="the_form">
			<div class="content_block">

				<div class="left_block">
				<button type="button" class="select-btn">é¸æ“‡åœ–ç‰‡</button>
					<input type="file" id="p_file">
					<div id="preview" class="drop_zone">
					
						<!-- ä¸Šé¢ç›´æ¥åœ¨oneå¾Œé¢åŠ ä¸Šonä¹Ÿå¯ä»¥ -->
						<span class="text">é è¦½åœ–</span>
					</div>
				</div>

				<div class="right_block">

					<div class="block">
						<label>å¯µç‰©åç¨±ï¼š</label> <input type="text" id="p_name"
							autocomplete="off">
					</div>

					<div class="block">
						<label>å¯µç‰©ç¨®é¡ï¼š</label> <input type="text" id="p_type"
							placeholder="è²“ æˆ– ç‹—">
					</div>

					<div class="block">
						<label>å¯µç‰©æ€§åˆ¥ï¼š</label> <input type="text" id="p_Gender"
							autocomplete="off">
					</div>

					<div class="block">
						<label>å¯µç‰©å¹´é½¡ï¼š</label> <input type="text" id="p_age"
							autocomplete="off">
					</div>

					<div class="block">
						<label>å¯µç‰©å°ºå¯¸ï¼š</label> <select id="p_size">
							<option value="1">å°å‹</option>
							<option value="2">ä¸­å‹</option>
							<option value="3">å¤§å‹</option>
						</select>
					</div>

					<div class="block">
						<label>å¯µç‰©å‚™è¨»ï¼š</label><br>
						<textarea id="p_desc" rows="3"></textarea>
					</div>

					<div class="block">
						<label>ç¶“åº¦ï¼š</label><input type="text" id="lng" readonly> <label>ç·¯åº¦ï¼š</label><input
							type="text" id="lat" readonly>
					</div>

				</div>

			</div>

			<footer class="footer">
				<div class="action_block">
					<div class="left_block">
						<button type="button" id="btn_fullscreen">é€²å…¥å…¨è¢å¹•æ¨¡å¼</button>
					</div>

					<div class="right_block">
						<button type="reset">æ¸…ç©ºè³‡æ–™</button>
						<button type="submit" id="btn_submit">é€å‡ºè³‡æ–™</button>
						<button type="button" id="btn_home" style="background-color: #6c757d; color: white;">å›åˆ°é¦–é </button>
					</div>
				</div>
				<p>
					æ˜¯å¦æœ‰æ”¯æ´å…¨è¢å¹•æ¨¡å¼ï¼š<span id="fullscreen_enable"></span>
				</p>
				<p>
					æ˜¯å¦æœ‰æ”¯æ´åœ°ç†è³‡è¨Šå®šä½ï¼š<span id="geolocation_enable"></span>
				</p>
			</footer>
		</form>
	</article>

	<script>

  // --- å®£å‘Š DOM å…ƒç´  ---
  var the_html = document.documentElement;
  var the_form_el = document.getElementById("the_form");
  var p_name_el = document.getElementById("p_name");
  var p_type_el = document.getElementById("p_type"); // æ–°å¢
  var p_Gender_el = document.getElementById("p_Gender");
  var p_age_el = document.getElementById("p_age");
  var p_size_el = document.getElementById("p_size"); // æ–°å¢
  var p_desc_el = document.getElementById("p_desc"); // æ–°å¢
  var lng_el = document.getElementById("lng");
  var lat_el = document.getElementById("lat");
  var btn_fullscreen_el = document.getElementById("btn_fullscreen");
  var fullscreen_enable_el = document.getElementById("fullscreen_enable");
  var geolocation_enable_el = document.getElementById("geolocation_enable");
  var preview_el = document.getElementById("preview");
  var p_file_el = document.getElementById("p_file");
  var canvas = document.createElement("canvas");
  var ctx = canvas.getContext("2d");
  var original_base64_temp = "";


// --- åˆå§‹åŒ–é è¦½åœ–å€åŸŸçš„ HTML ---
    var preview_default_html = '<span class="text">é è¦½åœ–</span>';
   

    // è™•ç†è®€å–æª”æ¡ˆä¸¦é¡¯ç¤ºé è¦½åœ–çš„å‡½å¼
    var handleFiles = function(files) {
      if (files && files.length > 0) {
        var file = files[0];
        if (file.type.indexOf("image") !== -1) {
          var reader = new FileReader();
          reader.addEventListener("load", function(e) {
            // éœ€æ±‚ 1 & 3ï¼šå‘ˆç¾é è¦½åœ–ä¸¦åŠ ä¸Š preview_img class
            
            original_base64_temp = e.target.result;
            preview_el.innerHTML = '<img src="' + e.target.result + '" class="preview_img">';
          });
          reader.readAsDataURL(file);
        }
      } else {
        // éœ€æ±‚ 2ï¼šå¦‚æœæŒ‰å–æ¶ˆï¼ˆfilesé•·åº¦ç‚º0ï¼‰ï¼Œå›åˆ°åŸä»‹é¢
        preview_el.innerHTML = preview_default_html;
        original_base64_temp = "";
      }
    };

    
    
    //reset æŒ‰éˆ•æŒ‰ä¸‹å»çš„æ™‚å€™è§¸ç™¼
    //form

    the_form_el.addEventListener("reset", function(){

  preview_el.innerHTML = preview_default_html;
      // æ¸…ç©ºè³‡æ–™æ™‚ï¼Œå°‡é è¦½åœ–å›åˆ°åŸä»‹é¢
      sessionStorage.removeItem("pending_data");
      setTimeout(function(){
        check_geolocation_enabled_el();
      }, 0);
});

    

    var btn_home_el = document.getElementById("btn_home");

 // 2. ç¶å®šé»æ“Šäº‹ä»¶
 btn_home_el.addEventListener("click", function() {
     // è©¢å•ä½¿ç”¨è€…ï¼Œé¿å…èª¤é»å°è‡´è³‡æ–™æ¶ˆå¤±
     if (confirm("ç¢ºå®šè¦é›¢é–‹ä¸¦å›åˆ°é¦–é å—ï¼Ÿæœªå„²å­˜çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚")) {
         // æ¸…é™¤é€™ä¸€æ¬¡çš„æš«å­˜è³‡æ–™ï¼ˆé¸é¸ï¼šå¦‚æœä½ å¸Œæœ›å›é¦–é å¾Œä¸‹æ¬¡é€²ä¾†æ˜¯ä¹¾æ·¨çš„ï¼‰
         sessionStorage.removeItem("pending_data"); 
         
         window.location.href = "/pet/dashboard"; // é€™è£¡å¡«å…¥ä½ é¦–é çš„ç¶²å€ï¼Œä¾‹å¦‚ "/" æˆ– "/index"
     }
 });


    
      
    // å†æ¬¡æŠ“å–ç¶“ç·¯åº¦æ”¾å›æ¬„ä½
      
      /* // ã€åŠŸèƒ½ï¼šæ¸…ç©ºå¾Œä¸è¦é‡æ–°æŠ“å–ï¼Œè®“æ¬„ä½ä¿æŒæ¸…ç©ºã€‘ (è‹¥æƒ³æ›æˆé€™åŠŸèƒ½ï¼Œè«‹å–æ¶ˆè¨»è§£ä¸‹é¢ï¼Œä¸¦è¨»è§£æ‰ä¸Šé¢çš„ setTimeout)
  // lng_el.value = "";
  // lat_el.value = "";
  */

  document.addEventListener("DOMContentLoaded", function() {
	    var select_btn_el = document.querySelector(".select-btn");
	    var p_file_el = document.getElementById("p_file");

	    if (select_btn_el && p_file_el) {
	        select_btn_el.addEventListener("click", function() {
	            p_file_el.click(); // æ‰‹å‹•é»æ“Šéš±è—çš„ input file
	        });
	    }
	});
  
  // é»æ“Š ã€Œé è¦½åœ–ã€ å€åŸŸï¼Œè·³å‡ºé¸åœ–çš„å½ˆçª—
preview_el.addEventListener("click", function(){
    p_file_el.click(); // è§¸ç™¼éš±è—çš„ input file
});

      // æª”æ¡ˆé¸å–è®Šæ›´æ™‚
      
    p_file_el.addEventListener("change", function(){
      handleFiles(this.files);
    });


    // ä»¥ä¸‹ä¸‰æ­¥åœ¨æ­¥é©Ÿä¸€ä¸éœ€è¦
    // check_geolocation_enabled();
    //preview_el.innerHTML = '<span class="text">é è¦½åœ–</span>';


    //============================fullscreen
    //åˆ¤æ–·æœ‰ç„¡æ”¯æ´å…¨è¢å¹•
    var check_fullscreen_enabled = function(){
      //console.log(document.fullscreenEnabled);
      if(document.fullscreenEnabled) {
        fullscreen_enable_el.innerHTML = "æ˜¯";
      } else{
        fullscreen_enable_el.innerHTML = "å¦";
      }
    };

    //fullscreen
    btn_fullscreen_el.addEventListener("click", function () {
      //console.log(document.fullscreenElement );
      if(document.fullscreenElement) {//é€€å‡ºå…¨è¢å¹•
        document.exitFullscreen();
        this.innerHTML = "é€²å…¥å…¨è¢å¹•æ¨¡å¼";

      } else{
        the_html.requestFullscreen();
        this.innerHTML = "é€€å‡ºå…¨è¢å¹•æ¨¡å¼";
      }
    });

    document.addEventListener("fullscreenchange", function(e) {
    //console.log(document.fullscreenElement)
    if(! document.fullscreenElement){
    btn_fullscreen_el.innerHTML ="é€²å…¥å…¨è¢å¹•æ¨¡å¼";
    }
    });

    // ======================== geolocation =========================

    // åˆ¤æ–·æœ‰ç„¡åœ°ç†è³‡è¨Šå®šä½
    var check_geolocation_enabled_el = function () {
    if (navigator.geolocation) {
        geolocation_enable_el.innerHTML = "æ˜¯";

        // å–å¾— geolocation
        navigator.geolocation.getCurrentPosition(function (position) {
            // console.log(position);
            // console.log("æŠ“åˆ°æ–°åº§æ¨™äº†ï¼", position.coords.longitude);
            lng_el.value = position.coords.longitude;
            lat_el.value = position.coords.latitude;

            // lng_el.disabled = false;
            // lat_el.disabled = false;
        }, function (error) {
            lng_el.disabled = true;
            lat_el.disabled = true;
            console.warn("å®šä½å¤±æ•—åŸå› ä»£ç¢¼: " + error.code + " è¨Šæ¯: " + error.message);
        }, {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000
        });
    } else {
        geolocation_enable_el.innerHTML = "å¦";
    }
};



// ========================== Drag and Drop ==========================

// ç•¶æª”æ¡ˆæ‹–æ›³é€²å…¥å€åŸŸ
    preview_el.addEventListener("dragenter", function (e) {
    e.preventDefault();
    // éœ€æ±‚ 1ï¼šåŠ ä¸Š -on class
    this.classList.add("-on");
});

// ç•¶æª”æ¡ˆåœ¨å€åŸŸä¸Šæ–¹ç§»å‹•
    preview_el.addEventListener("dragover", function (e) {
    e.preventDefault(); // å¿…é ˆå‘¼å«ï¼Œæ‰èƒ½è§¸ç™¼ drop äº‹ä»¶
});

// ç•¶æª”æ¡ˆé›¢é–‹å€åŸŸ
    preview_el.addEventListener("dragleave", function (e) {
    e.preventDefault();
    // éœ€æ±‚ 1ï¼šç§»é™¤ -on class
    this.classList.remove("-on");
});

// ç•¶æª”æ¡ˆæ”¾ä¸‹æ™‚
    preview_el.addEventListener("drop", function (e) {
    e.preventDefault(); // éœ€æ±‚ï¼šå…è¨±å–å¾—æª”æ¡ˆ
    // ç§»é™¤ -on class
    this.classList.remove("-on");
//å¿…é ˆåŠ ä¸Še.é‚£æ®µï¼Œæ‰ä¸æœƒç›´æ¥é–‹å•Ÿåœ–æª”
    // å–å¾— FileList ç‰©ä»¶ä¸¦å°å‡º
    var files = e.dataTransfer.files;
    // console.log(files);
    handleFiles(files);
  });

  the_form_el.addEventListener("submit", function (e) {
    e.preventDefault(); // æ””æˆªè·³è½‰
    
 // --- ğŸ”´ æ–°å¢ï¼šå¯µç‰©åç¨±éç©ºé©—è­‰ ---
    if (p_name_el.value.trim() === "") {
        alert("å¯µç‰©åç¨±è«‹å‹¿ç©ºç™½ï¼");
        p_name_el.focus();
        return;
    }

    // å–å¾—åœ–ç‰‡ Base64 (å¾é è¦½åœ–çš„ src æ‹¿)
    var img_el = preview_el.querySelector(".preview_img"); if (!img_el) { alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡ï¼"); return; }
    canvas.width = img_el.naturalWidth;
    canvas.height = img_el.naturalHeight;
    ctx.drawImage(img_el, 0, 0);

    // 3. è¨­å®šæ–‡å­—æ¨£å¼
    const fontSize = Math.floor(canvas.width / 15); // æ ¹æ“šåœ–å¯¬å‹•æ…‹èª¿æ•´å­—é«”å¤§å°
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.fillStyle = "red";       // æ–‡å­—é¡è‰²
    ctx.strokeStyle = "white";   // æ–‡å­—é‚Šæ¡†é¡è‰²ï¼ˆå¢åŠ è¾¨è­˜åº¦ï¼‰
    ctx.lineWidth = fontSize / 8;
    ctx.textBaseline = "top";    // é‡è¦ï¼šè¨­å®šåŸºæº–ç·šåœ¨é ‚éƒ¨ï¼Œæ–¹ä¾¿ä¾åºè¨ˆç®— Y è»¸

    // 4. ğŸ”´ æº–å‚™è¦é¡¯ç¤ºçš„è³‡æ–™é™£åˆ— (é †åºæ±ºå®šé¡¯ç¤ºé †åº)
    // è«‹ç¢ºä¿é€™äº› ID åœ¨ä½ çš„ HTML ä¸­éƒ½å­˜åœ¨
    const petInfo = [
        { label: "åç¨±", value: p_name_el.value },
        { label: "ç¨®é¡", value: document.getElementById("p_type").value },
        { label: "æ€§åˆ¥", value: p_Gender_el.value },
        { label: "å¹´é½¡", value: p_age_el.value },
        { label: "å°ºå¯¸", value: document.getElementById("p_size").options[document.getElementById("p_size").selectedIndex].text },
        { label: "å‚™è¨»", value: document.getElementById("p_desc").value }
    ];

    // 5. ğŸ”´ ä¾åºç¹ªè£½æ–‡å­—
    const startX = 20;           // å·¦é‚Šè·
    let currentY = 20;           // èµ·å§‹é«˜åº¦
    const lineHeight = fontSize * 1.3; // è¨­å®šè¡Œè· (å­—é«”å¤§å°çš„ 1.3 å€)

    petInfo.forEach((item) => {
        const text = `${item.label}ï¼š${item.value}`;
        
        // ç•«é‚Šæ¡† (é¿å…èƒŒæ™¯å¤ªäº‚çœ‹ä¸æ¸…)
        ctx.strokeText(text, startX, currentY);
        // ç•«æ–‡å­—
        ctx.fillText(text, startX, currentY);
        
        // ğŸ”´ é—œéµï¼šç•«å®Œä¸€è¡Œå¾Œï¼Œå°‡ Y åº§æ¨™å¾€ä¸‹ç§»å‹•ä¸€è¡Œçš„é«˜åº¦
        currentY += lineHeight; 
    });

    // 6. è½‰å­˜ Base64 ä¸¦è·³è½‰
    const final_img_base64 = canvas.toDataURL("image/jpeg", 0.7);
    const form_data = {
            img_base64: final_img_base64,
            original_base64: original_base64_temp,
            petName: p_name_el.value,          // â† æ”¹å
            typeId: p_type_el.value,          // â† æ–°å¢
            petGender: p_Gender_el.value,            // â† æ”¹å
            petAge: p_age_el.value,            // â† æ”¹å
            sizeId: p_size_el.value,          // â† æ–°å¢
            petDescription: p_desc_el.value,          // â† æ–°å¢
            lng: lng_el.value,                 // â† æ”¹ç”¨é€™æ¨£æ¯”è¼ƒæ¸…æ¥š
            lat: lat_el.value
        };

    sessionStorage.setItem("pending_data", JSON.stringify(form_data));
    location.href = "/pet/confirm";
});
  lng_el.disabled = false;
      lat_el.disabled = false;

// =================== session è£¡çš„è³‡æ–™å›å¯«åˆ°è¡¨å–®ä¸­ ===================
    var recovery_data = function () {
    // 1. æ”¹è®€å– pending_data (èˆ‡é€å‡ºæ™‚çš„ Key ä¸€è‡´)
    var savedData = sessionStorage.getItem("pending_data");
    
    // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å°±ç›´æ¥çµæŸ
    if (savedData === null || savedData === "null") {
        return; 
    }

    var data = JSON.parse(savedData);

    // 2. å›å¡«æ–‡å­—æ¬„ä½ (ä½¿ç”¨ data ç‰©ä»¶ä¸­çš„å±¬æ€§åç¨±)
    if(p_name_el) p_name_el.value = data.petName || "";
    if(p_type_el) p_type_el.value = data.typeId || "";
    if(p_Gender_el)  p_Gender_el.value  = data.petSex || "";
    if(p_age_el)  p_age_el.value  = data.petAge || "";
    if(p_size_el) p_size_el.value = data.sizeId || "1";
    if(p_desc_el) p_desc_el.value = data.petDescription || "";
    if(lng_el)    lng_el.value    = data.lng || "";
    if(lat_el)    lat_el.value    = data.lat || "";

    // 3. åœ–ç‰‡éƒ¨åˆ†ï¼šä¾ä½ çš„è¦æ±‚ã€Œä¿ç•™è³‡æ–™ï¼Œåœ–ç‰‡ä¸è¦ã€ï¼Œæ‰€ä»¥å¼·åˆ¶å›åˆ°é è¦½åœ–ç‹€æ…‹
    
    if (data.original_base64) {
        original_base64_temp = data.original_base64;
    }
   if (data.img_base64 && data.img_base64.length > 100) { 
        // åˆ¤æ–·é•·åº¦æ˜¯å› ç‚º Base64 å¾ˆé•·ï¼Œå¦‚æœåªæ˜¯ç©ºå­—ä¸²æˆ–å¤ªçŸ­å°±ä¸è¦é¡¯ç¤º
        preview_el.innerHTML = '<img src="' + data.img_base64 + '" class="preview_img">';
    } else {
        // å¦‚æœæ²’æœ‰åœ–ç‰‡è³‡æ–™ï¼Œå¼·åˆ¶é‚„åŸæˆé è¨­æ–‡å­—
        preview_el.innerHTML = preview_default_html;
    }
};




// ========================== å‡½å¼è§¸ç™¼ ==========================
    // reset_p_count_value();
    check_fullscreen_enabled();
    check_geolocation_enabled_el();
    recovery_data();




    
  </script>


<footer id="main-footer" style="background-color: #f9f9f9; margin-top: 4rem;"></footer>
 <script th:src="@{/js/frontend/main.js}"></script>


</body>
</html>