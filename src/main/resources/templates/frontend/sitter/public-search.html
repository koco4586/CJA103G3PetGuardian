<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœå°‹ä¿å§† - PetGuardian</title>

    <!-- å°ˆæ¡ˆçµ±ä¸€æ¨£å¼ -->
    <link rel="stylesheet" href="/css/frontend/style.css">
    <link rel="stylesheet" href="/css/frontend/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .search-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-label {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            display: block;
        }

        .sitter-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .sitter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .sitter-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .rating-stars {
            color: #ffc107;
            font-size: 1.1rem;
        }

        .price-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            display: inline-block;
            font-weight: 600;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .no-results {
            display: none;
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .test-member-badge {
            background-color: rgba(var(--primary-rgb), 0.1);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* å¾½ç« æ¨£å¼ */
        .badge-pet {
            font-size: 0.85rem;
            padding: 0.4em 0.8em;
            border-radius: 20px;
            margin-right: 5px;
        }

        .badge-cat {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .badge-dog {
            background-color: #fff3e0;
            color: #e65100;
        }
    </style>
</head>

<body>
    <!-- çµ±ä¸€ Header -->
    <header id="main-header" class="header"></header>

    <div class="container" style="padding: 2rem 0;">
        <!-- æ¸¬è©¦æœƒå“¡æç¤º -->
        <div class="test-member-badge" th:if="${currentMember}">
            <i class="fas fa-user"></i>
            ç›®å‰ç™»å…¥ï¼š<span th:text="${currentMember.memName}">æ¸¬è©¦æœƒå“¡</span>ï¼ˆæ¸¬è©¦ç”¨ï¼‰
        </div>

        <h1 class="mb-2">ğŸ¾ æœå°‹ä¿å§†</h1>
        <p style="color: #666; margin-bottom: 2rem;">æ‰¾åˆ°æœ€é©åˆæ‚¨æ¯›å°å­©çš„å°ˆæ¥­ä¿å§†</p>

        <!-- æœå°‹ç¯©é¸å€ -->
        <div class="search-container">
            <h3 class="mb-3"><i class="fas fa-filter"></i> ç¯©é¸æ¢ä»¶</h3>

            <div class="row">
                <!-- ç¸£å¸‚é¸æ“‡ -->
                <div class="col-md-4 filter-section">
                    <label class="filter-label">ç¸£å¸‚</label>
                    <select id="citySelect" class="form-select">
                        <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
                        <!-- å¾è³‡æ–™åº«å‹•æ…‹è¼‰å…¥ç¸£å¸‚é¸é … -->
                    </select>
                </div>

                <!-- æœå‹™é …ç›®ç¯©é¸ï¼ˆæš«æ™‚åœç”¨ï¼Œç­‰æœå‹™é …ç›®æ¨¡çµ„å®Œæˆï¼‰ -->
                <div class="col-md-4 filter-section">
                    <label class="filter-label">æœå‹™é …ç›®</label>
                    <select id="serviceFilter" class="form-control" disabled>
                        <option value="">å…¨éƒ¨æœå‹™ï¼ˆé–‹ç™¼ä¸­ï¼‰</option>
                    </select>
                </div>

                <!-- å¯µç‰©é¡å‹ç¯©é¸ -->
                <div class="col-md-4 filter-section">
                    <label class="filter-label">å¯µç‰©é¡å‹</label>
                    <select id="petTypeFilter" class="form-control">
                        <option value="">å…¨éƒ¨é¡å‹</option>
                        <option value="1">ç‹—</option>
                        <option value="2">è²“</option>
                    </select>
                </div>

                <!-- åƒ¹æ ¼ç¯„åœ -->
                <div class="col-md-4 filter-section">
                    <label class="filter-label">åƒ¹æ ¼ç¯„åœ</label>
                    <select id="priceRangeFilter" class="form-control">
                        <option value="">ä¸é™åƒ¹æ ¼</option>
                        <option value="0-300">$300 ä»¥ä¸‹</option>
                        <option value="300-500">$300 - $500</option>
                        <option value="500-800">$500 - $800</option>
                        <option value="800-1000">$800 - $1,000</option>
                        <option value="1000-99999">$1,000 ä»¥ä¸Š</option>
                    </select>
                </div>

                <!-- æ’åºé¸é … -->
                <div class="col-md-4 filter-section">
                    <label class="filter-label">æ’åºæ–¹å¼</label>
                    <select id="sortBy" class="form-control">
                        <option value="rating_desc">è©•åˆ†ï¼ˆé«˜åˆ°ä½ï¼‰</option>
                        <option value="price_asc">åƒ¹æ ¼ï¼ˆä½åˆ°é«˜ï¼‰</option>
                        <option value="price_desc">åƒ¹æ ¼ï¼ˆé«˜åˆ°ä½ï¼‰</option>
                    </select>
                </div>

                <!-- æœå°‹æŒ‰éˆ• -->
                <div class="col-12 text-center mt-3">
                    <button id="searchBtn" class="btn btn-primary">
                        <i class="fas fa-search"></i> æœå°‹ä¿å§†
                    </button>
                    <button id="resetBtn" class="btn btn-outline ms-2">
                        <i class="fas fa-redo"></i> é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­æç¤º -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
            <p class="mt-2">æœå°‹ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>

        <!-- ç„¡çµæœæç¤º -->
        <div class="no-results" id="noResults">
            <i class="fas fa-search" style="font-size: 3rem; color: #dee2e6;"></i>
            <p class="mt-2">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ä¿å§†ï¼Œè«‹èª¿æ•´ç¯©é¸æ¢ä»¶å¾Œå†è©¦ã€‚</p>
        </div>

        <!-- æœå°‹çµæœå€ -->
        <div id="resultsContainer">
            <!-- ä¿å§†å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- çµ±ä¸€ Footer -->
    <footer id="main-footer" class="footer"></footer>

    <!-- è¼‰å…¥çµ±ä¸€çš„ JavaScript -->
    <script src="/js/frontend/main.js"></script>

    <script th:inline="javascript">
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            loadCities();      // è¼‰å…¥ç¸£å¸‚é¸é …
            loadAllSitters();  // è¼‰å…¥æ‰€æœ‰ä¿å§†
        });

        // å¾ API è¼‰å…¥æ‰€æœ‰ç¸£å¸‚
        function loadCities() {
            fetch('/public/sitter/cities')
                .then(response => response.json())
                .then(cities => {
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = '<option value="">è«‹é¸æ“‡ç¸£å¸‚</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                })
                .catch(error => console.error('è¼‰å…¥ç¸£å¸‚å¤±æ•—:', error));
        }

        // æœå°‹æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.getElementById('searchBtn').addEventListener('click', function () {
            searchSitters();
        });

        // é‡ç½®æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.getElementById('resetBtn').addEventListener('click', function () {
            document.getElementById('citySelect').value = '';
            document.getElementById('serviceFilter').value = '';
            document.getElementById('petTypeFilter').value = '';
            document.getElementById('priceRangeFilter').value = '';
            document.getElementById('sortBy').value = 'rating_desc';
            loadAllSitters();
        });

        // è¼‰å…¥æ‰€æœ‰ä¿å§†
        function loadAllSitters() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('resultsContainer').innerHTML = '';

            fetch('/public/sitter/search/all')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    if (data.length === 0) {
                        document.getElementById('noResults').style.display = 'block';
                    }
                    displaySitters(data);
                })
                .catch(error => {
                    console.error('è¼‰å…¥å¤±æ•—:', error);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
        }

        // æœå°‹ä¿å§†å‡½æ•¸
        function searchSitters() {
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('resultsContainer').innerHTML = '';

            // å–å¾—ç¯©é¸æ¢ä»¶
            const city = document.getElementById('citySelect').value;
            const serviceItemId = document.getElementById('serviceFilter').value;
            const petTypeId = document.getElementById('petTypeFilter').value;
            const priceRange = document.getElementById('priceRangeFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // è§£æåƒ¹æ ¼ç¯„åœ
            let minPrice = null, maxPrice = null;
            if (priceRange) {
                const [min, max] = priceRange.split('-').map(Number);
                minPrice = min;
                maxPrice = max;
            }

            // å»ºç«‹æœå°‹æ¢ä»¶ï¼ˆä¸åŒ…å« districtï¼‰
            const criteria = {
                cityName: city || null,           // å‚³é€ç¸£å¸‚åç¨±
                district: null,                   // ä¸å‚³é€å€åŸŸåç¨±
                serviceItemIds: serviceItemId ? [parseInt(serviceItemId)] : null,
                petTypeIds: petTypeId ? [parseInt(petTypeId)] : null,
                minPrice: minPrice,
                maxPrice: maxPrice,
                sortBy: sortBy
            };

            // ç™¼é€æœå°‹è«‹æ±‚
            fetch('/public/sitter/search/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(criteria)
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    if (data.length === 0) {
                        document.getElementById('noResults').style.display = 'block';
                    }
                    displaySitters(data);
                })
                .catch(error => {
                    console.error('æœå°‹å¤±æ•—:', error);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    alert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
        }

        // [NEW] å–å¾—ç•¶å‰ä¿æ¯ID
        const currentSitterId = /*[[${currentSitterId}]]*/ null;

        // é¡¯ç¤ºä¿å§†åˆ—è¡¨
        function displaySitters(sitters) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            sitters.forEach(sitter => {
                // [NEW] å¦‚æœæ˜¯è‡ªå·±ï¼Œå°±è·³éä¸é¡¯ç¤º
                if (currentSitterId && sitter.sitterId === currentSitterId) {
                    return;
                }

                const card = createSitterCard(sitter);
                container.appendChild(card);
            });
        }

        // å»ºç«‹ä¿å§†å¡ç‰‡
        function createSitterCard(sitter) {
            const card = document.createElement('div');
            card.className = 'sitter-card';

            // è¨ˆç®—æ˜Ÿæ˜Ÿé¡¯ç¤º
            const stars = generateStars(sitter.averageRating || 0);

            // åƒ¹æ ¼é¡¯ç¤º
            const priceText = sitter.minPrice && sitter.maxPrice
                ? `$${sitter.minPrice} - $${sitter.maxPrice}`
                : '';

            // æœå‹™åœ°å€é¡¯ç¤º
            let location = 'æœªæä¾›åœ°å€';
            if (sitter.serviceAreas && sitter.serviceAreas.length > 0) {
                // å¦‚æœæœ‰æœå‹™åœ°å€åˆ—è¡¨ï¼Œé¡¯ç¤ºå‰å¹¾å€‹ï¼ˆé¿å…å¤ªé•·ï¼‰
                const displayAreas = sitter.serviceAreas.slice(0, 3); // æœ€å¤šé¡¯ç¤º3å€‹
                location = displayAreas.join('ã€');
                if (sitter.serviceAreas.length > 3) {
                    location += ` ç­‰ ${sitter.serviceAreas.length} å€‹åœ°å€`;
                }
            } else if (sitter.sitterAdd) {
                // å¦‚æœæ²’æœ‰æœå‹™åœ°å€è³‡æ–™ï¼Œæ‰é¡¯ç¤ºåœ°å€å‰3å­—
                location = sitter.sitterAdd.substring(0, 3) + " (å±…ä½åœ°)";
            }

            // å‡è³‡æ–™å‘ˆç¾å¯µç‰©é¡å‹ (ç­‰å¾…å¾Œç«¯APIå®Œæˆå¾Œå¯ç§»é™¤)
            const petTypeBadges = `
                <span class="badge badge-pet badge-dog"><i class="fas fa-dog"></i> ç‹—</span>
                <span class="badge badge-pet badge-cat"><i class="fas fa-cat"></i> è²“</span>
            `;

            card.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                             <div class="sitter-name mb-0 me-3">${sitter.sitterName}</div>
                             <div class="rating-stars" style="font-size: 0.9rem;">${stars}</div>
                        </div>
                        
                        <!-- å¯µç‰©é¡å‹èˆ‡åœ°å€ -->
                        <div class="mb-3">
                            ${petTypeBadges}
                            <span class="text-muted ms-2"><i class="fas fa-map-marker-alt"></i> æœå‹™åœ°å€: ${location}</span>
                        </div>
                        <br>
                    <div class="col-md-4 text-end">
                        <a href="/public/sitter/detail/${sitter.sitterId}" class="btn btn-primary">
                            <i class="fas fa-info-circle"></i> æŸ¥çœ‹è©³æƒ…
                        </a>
                    </div>
                </div>
            `;

            return card;
        }

        // ç”Ÿæˆæ˜Ÿæ˜Ÿè©•åˆ†
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '';

            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }

            return stars + ` <span class="text-muted">(${rating.toFixed(1)})</span>`;
        }

        // å–å¾—å–®é¸ä¸‹æ‹‰é¸å–®çš„é¸ä¸­å€¼ï¼ˆè¿”å›é™£åˆ—æ ¼å¼ä»¥é…åˆå¾Œç«¯ï¼‰
        function getSingleValue(selectId) {
            const value = document.getElementById(selectId).value;
            return value ? [parseInt(value)] : null;
        }
    </script>
</body>

</html>