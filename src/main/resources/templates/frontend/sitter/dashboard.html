<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å§†ä¸»é  | PetGuardian</title>
    <link rel="stylesheet" th:href="@{/css/frontend/style.css}">
    <link rel="stylesheet" th:href="@{/css/frontend/components.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/frontend/sitter/dashboard.css}">
    <style>
        /* æª¢èˆ‰è¼¸å…¥æ¡†æ¨£å¼ */
        .dynamic-report-wrapper {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0 20px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fff5f5;
            border-radius: 15px;
            border: 1px solid transparent;
            width: 100%;
            box-sizing: border-box;
        }

        .dynamic-report-wrapper.active {
            max-height: 800px;
            opacity: 1;
            margin-top: 15px;
            padding: 20px;
            border: 1px solid #ffcdd2;
            box-shadow: 0 4px 15px rgba(255, 205, 210, 0.3);
        }

        .report-tag {
            display: inline-block;
            padding: 6px 14px;
            margin: 5px;
            background: #fff;
            border: 1px solid #ffcdd2;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #c62828;
            transition: all 0.2s;
        }

        .report-tag.selected {
            background: #ffcdd2;
            font-weight: bold;
        }

        .submit-report-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            float: right;
            transition: transform 0.1s, background 0.2s;
        }

        .submit-report-btn:active {
            transform: scale(0.92);
        }

        .submit-report-btn:hover {
            background: #ff5252;
        }

        /* CSS for calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            background-color: #fff;
        }

        .calendar-day {
            border: 1px solid #eee;
            min-height: 100px;
            padding: 8px;
            cursor: pointer;
            position: relative;
            background: #fff;
            transition: all 0.2s;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .calendar-day.empty {
            background: #f9f9f9;
            pointer-events: none;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .day-summary {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            align-content: flex-start;
        }

        .small-hour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #eee;
        }

        .small-hour-dot.active {
            background-color: #4caf50;
        }

        .small-hour-dot.reserved {
            background-color: #ff9800;
        }

        /* Modal Styles */
        .hour-cell {
            border: 1px solid #ddd;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #f5f5f5;
            color: #999;
            transition: all 0.2s;
        }

        .hour-cell.available {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
            font-weight: bold;
        }

        .hour-cell:hover {
            filter: brightness(0.95);
        }

        .hour-cell.reserved {
            background-color: #ffe0b2;
            color: #e65100;
            border-color: #ffb74d;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <header id="main-header" class="header"></header>


    <div class="container dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="text-center mb-2">
                <div class="avatar-wrapper">
                    <img th:if="${currentMember != null and currentMember.memImage != null}"
                        th:src="${currentMember.memImage}" class="avatar" alt="æœƒå“¡é ­åƒ">
                    <img th:unless="${currentMember != null and currentMember.memImage != null}"
                        src="https://api.dicebear.com/7.x/avataaars/svg?seed=Sitter" class="avatar" alt="é è¨­é ­åƒ">
                </div>
                <h4 th:text="${sitter.sitterName}">ä¿å§†å§“å</h4>
                <p style="color: #999; font-size: 0.9rem;">ä¿å§†å°ˆå€</p>
            </div>
            <nav>
                <a href="/sitter/dashboard" class="menu-item active">
                    <i class="fas fa-home"></i> ä¿å§†ä¸»é 
                </a>
                <a href="/sitter/profile/settings" class="menu-item">
                    <i class="fas fa-cog"></i> å€‹äººè¨­å®š
                </a>
                <a href="/sitter/bookings" class="menu-item">
                    <i class="fas fa-calendar-check"></i> é ç´„ç®¡ç†
                </a>


            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h2 class="mb-2">æ­¡è¿å›ä¾†ï¼Œ<span th:text="${sitter.sitterName}">ä¿å§†</span>ï¼</h2>
            <p style="color: #666; margin-bottom: 2rem;">é€™æ˜¯æ‚¨çš„ä¿å§†æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ‚¨çš„æœå‹™æ¦‚æ³ã€‚</p>

            <!-- æ•¸æ“šæ¦‚è¦½å¡ç‰‡ -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">

                <!-- æœå‹™é …ç›®å¡ç‰‡ -->
                <div class="card" style="text-align: center; padding: 2rem;">
                    <div
                        style="background: #e3f2fd; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <i class="fas fa-list-ul" style="font-size: 1.5rem; color: #1976d2;"></i>
                    </div>
                    <h3 style="font-size: 1.2rem; color: #333; margin-bottom: 0.5rem;">æœå‹™é …ç›®</h3>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #1976d2; margin-bottom: 0.5rem;"
                        th:text="${serviceCount}">0</div>
                    <p style="color: #666; margin-bottom: 1.5rem;">é …å·²ä¸Šæ¶æœå‹™</p>
                    <a href="/sitter/profile/settings" class="btn btn-outline-primary" style="width: 100%;">ç®¡ç†æœå‹™</a>
                </div>

                <!-- æœå‹™åœ°å€å¡ç‰‡ -->
                <div class="card" style="text-align: center; padding: 2rem;">
                    <div
                        style="background: #e8f5e9; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <i class="fas fa-map-marker-alt" style="font-size: 1.5rem; color: #2e7d32;"></i>
                    </div>
                    <h3 style="font-size: 1.2rem; color: #333; margin-bottom: 0.5rem;">æœå‹™åœ°å€</h3>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #2e7d32; margin-bottom: 0.5rem;"
                        th:text="${areaCount}">0</div>
                    <p style="color: #666; margin-bottom: 1.5rem;">å€‹æœå‹™å€åŸŸ</p>
                    <a href="/sitter/profile/settings" class="btn btn-outline-primary" style="width: 100%;">ç®¡ç†åœ°å€</a>
                </div>

                <!-- è©•åƒ¹åˆ†æ•¸å¡ç‰‡ (ç›®å‰ç‚ºéœæ…‹å‡è³‡æ–™) -->
                <!-- <div class="card" style="text-align: center; padding: 2rem;">
                    <div
                        style="background: #fff3e0; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <i class="fas fa-star" style="font-size: 1.5rem; color: #f57c00;"></i>
                    </div>
                    <h3 style="font-size: 1.2rem; color: #333; margin-bottom: 0.5rem;">è©•åƒ¹åˆ†æ•¸</h3>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #f57c00; margin-bottom: 0.5rem;"
                        th:text="${averageRating}">0.0</div>
                    <p style="color: #666; margin-bottom: 1.5rem;">(<span th:text="${sitter.sitterRatingCount}">0</span>
                        å‰‡è©•åƒ¹)</p>
                    <button class="btn btn-disabled"
                        style="width: 100%; cursor: not-allowed; opacity: 0.6;">æŸ¥çœ‹è©•åƒ¹</button>
                </div> -->
            </div>



            <!-- æœˆæ›†è¡Œç¨‹è¡¨ (Review card moved to bottom) -->
            <div class="card" id="calendar-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.2rem; color: var(--primary-color);">æœå‹™è¡Œäº‹æ›† (æœˆæª¢è¦–)</h3>
                    <div style="display: flex; gap: 1rem; font-size: 0.85rem;">
                        <span><span
                                style="display: inline-block; width: 12px; height: 12px; background: #e0e0e0; border:1px solid #ccc; margin-right: 4px;"></span>ä¼‘æ¯</span>
                        <span><span
                                style="display: inline-block; width: 12px; height: 12px; background: #4caf50; margin-right: 4px;"></span>å¯é ç´„</span>
                        <span><span
                                style="display: inline-block; width: 12px; height: 12px; background: #ff9800; margin-right: 4px;"></span>å·²è¢«é ç´„</span>
                    </div>
                </div>

                <!-- æœˆä»½åˆ‡æ› -->
                <div class="calendar-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0 10px;">
                    <button id="prevMonth" class="btn btn-outline-primary"><i class="fas fa-chevron-left"></i>
                        ä¸Šå€‹æœˆ</button>
                    <h4 id="currentMonthDisplay" style="margin:0; font-weight:bold;">2026å¹´ 1æœˆ</h4>
                    <button id="nextMonth" class="btn btn-outline-primary">ä¸‹å€‹æœˆ <i
                            class="fas fa-chevron-right"></i></button>
                </div>

                <!-- æ˜ŸæœŸæ¨™é¡Œ -->
                <div
                    style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-weight: bold; margin-bottom: 5px; color: #666;">
                    <div>é€±æ—¥</div>
                    <div>é€±ä¸€</div>
                    <div>é€±äºŒ</div>
                    <div>é€±ä¸‰</div>
                    <div>é€±å››</div>
                    <div>é€±äº”</div>
                    <div>é€±å…­</div>
                </div>

                <!-- æœˆæ›†ç¶²æ ¼ -->
                <div id="calendar-grid" class="calendar-grid">
                    <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ¯æ—¥è©³æƒ… Modal -->
            <div id="dayDetailModal" class="modal"
                style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
                <div class="modal-content"
                    style="background:white; padding:25px; width:90%; max-width:600px; border-radius:12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <h4 id="modalDateTitle" style="margin:0; color:var(--primary-color);">æ—¥æœŸè¨­å®š</h4>
                        <button onclick="closeModal()"
                            style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:#999;">&times;</button>
                    </div>

                    <div style="margin-bottom:15px; font-size:0.9rem; color:#666;">
                        <i class="fas fa-info-circle"></i> é»æ“Šä¸‹æ–¹æ™‚æ®µä»¥åˆ‡æ›ç‹€æ…‹ (ç¶ è‰²=å¯é ç´„, ç°è‰²=ä¼‘æ¯)
                    </div>

                    <div id="dayHoursGrid"
                        style="display:grid; grid-template-columns:repeat(6, 1fr); gap:8px; margin-bottom:25px;">
                        <!-- 24å°æ™‚æ ¼å­ JS ç”Ÿæˆ -->
                    </div>

                    <div style="text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="closeModal()" class="btn btn-outline-secondary">å–æ¶ˆ</button>
                        <button onclick="saveDaySchedule()" class="btn btn-primary"><i class="fas fa-save"></i>
                            å„²å­˜è¨­å®š</button>
                    </div>
                </div>
            </div>



            <!-- è©³ç´°è³‡è¨Šå€åŸŸ -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">

                <!-- æœå‹™åƒ¹ç›®è¡¨ -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.2rem; color: var(--primary-color);">æœå‹™åƒ¹ç›®è¡¨</h3>
                        <a href="/sitter/profile/settings" style="font-size: 0.9rem; color: #666;">ç·¨è¼¯</a>
                    </div>
                    <table class="table" style="margin-bottom: 0;">
                        <thead style="background: #f8f9fa;">
                            <tr>
                                <th style="padding: 0.5rem;">é …ç›®</th>
                                <th style="padding: 0.5rem;">åƒ¹æ ¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(services)}">
                                <td colspan="2" style="text-align: center; color: #999; padding: 1rem;">å°šæœªè¨­å®šæœå‹™</td>
                            </tr>
                            <tr th:each="service : ${services}">
                                <td style="padding: 0.8rem 0.5rem;"
                                    th:text="${service.serviceItemId == 1 ? 'æ•£æ­¥' : (service.serviceItemId == 2 ? 'é¤µé£Ÿ' : 'æ´—æ¾¡')}">
                                    æ•£æ­¥</td>
                                <td style="padding: 0.8rem 0.5rem; font-weight: bold; color: #28a745;"
                                    th:text="${service.defaultPrice} + ' å…ƒ'">500 å…ƒ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- æœå‹™åœ°å€åˆ—è¡¨ -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.2rem; color: var(--primary-color);">æœå‹™åœ°å€</h3>
                        <a href="/sitter/profile/settings" style="font-size: 0.9rem; color: #666;">ç·¨è¼¯</a>
                    </div>

                    <div th:if="${#lists.isEmpty(areas)}" style="text-align: center; color: #999; padding: 1rem;">
                        å°šæœªè¨­å®šæœå‹™åœ°å€
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <span th:each="area : ${areas}"
                            style="background: #e3f2fd; color: #1565c0; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.9rem;">
                            <i class="fas fa-map-marker-alt" style="font-size: 0.8rem; margin-right: 4px;"></i>
                            <span th:text="${area.area.cityName + area.area.district}">å°åŒ—å¸‚å¤§å®‰å€</span>
                        </span>
                    </div>
                </div>

            </div>

            <!-- æ­·å²è©•åƒ¹å¡ç‰‡ (Moved to Bottom) -->
            <div class="card" id="reviews-card" style="margin-bottom: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.2rem; color: var(--primary-color); margin-bottom: 1rem;">
                    <i class="fas fa-comments"></i> çš„è¢«è©•åƒ¹è¨˜éŒ„
                </h3>

                <div id="reviewsList" data-reviews-container>
                    <!-- å‹•æ…‹è¼‰å…¥è©•åƒ¹ -->
                    <div style="text-align: center; color: #999; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 0.5rem; display: block;"></i>
                        <p>æ­£åœ¨è¼‰å…¥è©•åƒ¹...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer id="main-footer" style="margin-top: 4rem;"></footer>

    <!-- Scripts moved to bottom for better performance and to avoid ID issues -->

    <script th:inline="javascript">
        /*<![CDATA[*/
        const contextPath = /*[[@{/}]]*/ '';
        const sitterId = /*[[${sitter.sitterId}]]*/ 0;
        const currentServiceTime = /*[[${serviceTime != null ? serviceTime : '000000000000000000000000'}]]*/ '000000000000000000000000';

        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth() + 1; // 1-12
        let scheduleCache = {}; // dateString -> statusString

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {

            // [NEW] æª¢æŸ¥æ˜¯å¦æœ‰å¾…ç¢ºèªè¨‚å–®ä¸¦é¡¯ç¤ºé€šçŸ¥
            const pendingCount = /*[[${pendingCount}]]*/ 0;
            const memId = /*[[${sitter.memId}]]*/ 0;
            // æª¢æŸ¥ sessionStorage æ˜¯å¦å·²ç¶“é€šçŸ¥éï¼ˆä½¿ç”¨æœƒå“¡ ID ä½œç‚º Keyï¼‰
            const storageKey = `pendingOrderNotified_${memId}`;
            const hasNotified = sessionStorage.getItem(storageKey);

            if (pendingCount > 0 && !hasNotified) {
                // ä½¿ç”¨ setTimeout ç¢ºä¿é é¢æ¸²æŸ“å®Œæˆå¾Œå½ˆå‡º
                setTimeout(() => {
                    alert(`æ‚¨æœ‰ ${pendingCount} ç­†é ç´„ï¼Œè«‹å‰å¾€ã€Œé ç´„ç®¡ç†ã€æŸ¥çœ‹ã€‚`);
                    // è¨­å®šå·²é€šçŸ¥æ¨™è¨˜ï¼Œé¿å…é‡è¤‡å½ˆå‡º
                    sessionStorage.setItem(storageKey, 'true');
                }, 500);
            }

            initCalendar();

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

            // è¼‰å…¥è©•åƒ¹è³‡æ–™ï¼ˆä¿æ¯ä¸»é å°ˆç”¨ä½ˆå±€ï¼‰
            if (sitterId) {
                // è™•ç†äººåï¼Œç¢ºä¿ä¸å‡ºç¾ç©ºå¼•è™Ÿ
                let sitterName = /*[[${sitter.sitterName}]]*/ '';
                if (!sitterName || sitterName === '""' || sitterName === "''") {
                    sitterName = 'ä¿æ¯';
                }
                // ç¢ºä¿å‡½æ•¸å·²ç”±å¤–éƒ¨è…³æœ¬è¼‰å…¥
                if (typeof loadAndDisplayReviewsForDashboard === 'function') {
                    loadAndDisplayReviewsForDashboard(sitterId, '#reviewsList', sitterName);
                } else {
                    console.warn('loadAndDisplayReviewsForDashboard not yet loaded');
                    window.addEventListener('load', () => {
                        if (typeof loadAndDisplayReviewsForDashboard === 'function') {
                            loadAndDisplayReviewsForDashboard(sitterId, '#reviewsList', sitterName);
                        }
                    });
                }
            }
        });

        // åˆ‡æ›æœˆä»½
        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth() + 1;
            initCalendar();
        }

        // åˆå§‹åŒ–ä¸¦æ¸²æŸ“æœˆæ›†
        async function initCalendar() {
            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('currentMonthDisplay').textContent = `${currentYear}å¹´ ${currentMonth}æœˆ`;

            // æ¸…ç©ºä¸¦é¡¯ç¤ºè¼‰å…¥ä¸­
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;">è¼‰å…¥ä¸­...</div>';

            // å‘¼å« API å–å¾—è³‡æ–™
            try {
                const response = await fetch(`/sitter/api/schedule?year=${currentYear}&month=${currentMonth}`);
                const data = await response.json();

                // å»ºç«‹å¿«å–: { "2026-01-01": "01010...", ... }
                scheduleCache = {};
                data.forEach(item => {
                    scheduleCache[item.scheduleDate] = item.bookingStatus;
                });

                renderGrid(grid);

            } catch (error) {
                console.error('Error fetching schedule:', error);
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
            }
        }

        /**
         * æ¸²æŸ“æœˆæ›†æ ¼å­ (åªé¡¯ç¤ºç•¶æœˆæ—¥æœŸ)
         * 
         * åŠŸèƒ½èªªæ˜:
         * - åªé¡¯ç¤ºç•¶æœˆçš„æ—¥æœŸ (ä¾‹å¦‚: 2026å¹´1æœˆåªé¡¯ç¤º 1-31 è™Ÿ)
         * - ä¸é¡¯ç¤ºä¸Šå€‹æœˆçš„æ—¥æœŸ
         * - ä¸é¡¯ç¤ºä¸‹å€‹æœˆçš„æ—¥æœŸ
         * - å‰é¢çš„ç©ºç™½æ ¼å­ç”¨æ·ºç°è‰²é¡¯ç¤º,ä¸å¯é»æ“Š
         * 
         * @param gridContainer æœˆæ›†å®¹å™¨çš„ DOM å…ƒç´ 
         */
        function renderGrid(gridContainer) {
            // æ­¥é©Ÿ 1: æ¸…ç©ºæœˆæ›†å®¹å™¨
            gridContainer.innerHTML = '';

            // æ­¥é©Ÿ 2: è¨ˆç®—ç•¶æœˆçš„ç›¸é—œè³‡è¨Š
            // firstDay: ç•¶æœˆç¬¬ä¸€å¤©çš„ Date ç‰©ä»¶ (ä¾‹å¦‚: 2026-01-01)
            const firstDay = new Date(currentYear, currentMonth - 1, 1);

            // lastDay: ç•¶æœˆæœ€å¾Œä¸€å¤©çš„ Date ç‰©ä»¶ (ä¾‹å¦‚: 2026-01-31)
            const lastDay = new Date(currentYear, currentMonth, 0);

            // daysInMonth: ç•¶æœˆæœ‰å¹¾å¤© (ä¾‹å¦‚: 1æœˆæœ‰31å¤©, 2æœˆæœ‰28æˆ–29å¤©)
            const daysInMonth = lastDay.getDate();

            // startDayOfWeek: ç•¶æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
            // 0=æ˜ŸæœŸæ—¥, 1=æ˜ŸæœŸä¸€, ..., 6=æ˜ŸæœŸå…­
            // ä¾‹å¦‚: 2026-01-01 æ˜¯æ˜ŸæœŸå››, startDayOfWeek = 4
            const startDayOfWeek = firstDay.getDay();

            // æ­¥é©Ÿ 3: å¡«å……å‰é¢çš„ç©ºç™½æ ¼å­
            // ç›®çš„: è®“æ—¥æœŸå°é½Šåˆ°æ­£ç¢ºçš„æ˜ŸæœŸå¹¾
            // ä¾‹å¦‚: å¦‚æœç•¶æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå››, å‰é¢è¦ç©ºå‡º 4 æ ¼ (æ—¥ä¸€äºŒä¸‰)
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';  // ä½¿ç”¨ empty æ¨£å¼ (æ·ºç°è‰², ä¸å¯é»æ“Š)
                // ä¸è¨­å®šä»»ä½•å…§å®¹, ä¿æŒç©ºç™½
                gridContainer.appendChild(emptyCell);
            }

            // æ­¥é©Ÿ 4: å¡«å……ç•¶æœˆçš„æ—¥æœŸ (å¾ 1 è™Ÿåˆ°æœ€å¾Œä¸€å¤©)
            for (let day = 1; day <= daysInMonth; day++) {
                // å»ºç«‹æ—¥æœŸå­—ä¸² (æ ¼å¼: YYYY-MM-DD)
                // ä¾‹å¦‚: 2026-01-05
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // å¾å¿«å–ä¸­å–å¾—è©²æ—¥æœŸçš„æ’ç¨‹ç‹€æ…‹
                // scheduleCache æ˜¯å¾ API å–å¾—çš„è³‡æ–™
                // æ ¼å¼: { "2026-01-05": "000000001111111100000000", ... }
                // å¦‚æœè©²æ—¥æœŸæ²’æœ‰è³‡æ–™, é è¨­ç‚ºå…¨ 0 (è¡¨ç¤ºå…¨å¤©å¯é ç´„)
                const status = scheduleCache[dateStr] || "000000000000000000000000";

                // å»ºç«‹æ—¥æœŸæ ¼å­çš„ DOM å…ƒç´ 
                const cell = document.createElement('div');
                cell.className = 'calendar-day';  // ä½¿ç”¨ calendar-day æ¨£å¼
                cell.onclick = () => openModal(dateStr, status);  // é»æ“Šæ™‚é–‹å•Ÿè©³ç´°è¨­å®šè¦–çª—

                // å»ºç«‹æ—¥æœŸæ•¸å­— (ä¾‹å¦‚: 1, 2, 3, ...)
                const dateNum = document.createElement('div');
                dateNum.className = 'day-number';
                dateNum.textContent = day;  // åªé¡¯ç¤ºæ—¥æœŸæ•¸å­—, ä¸é¡¯ç¤ºæœˆä»½
                cell.appendChild(dateNum);

                // å»ºç«‹è¦–è¦ºåŒ–æ‘˜è¦ (24 å€‹å°åœ“é», ä»£è¡¨ 24 å°æ™‚)
                const summary = document.createElement('div');
                summary.className = 'day-summary';

                // ç‚ºæ¯å€‹å°æ™‚å»ºç«‹ä¸€å€‹å°åœ“é»
                for (let h = 0; h < 24; h++) {
                    const dot = document.createElement('div');
                    dot.className = 'small-hour-dot';

                    // æ ¹æ“šæ’ç¨‹ç‹€æ…‹è¨­å®šåœ“é»é¡è‰²
                    // status.charAt(h): å–å¾—ç¬¬ h å€‹å­—å…ƒ
                    // '0' = å¯é ç´„ â†’ ç¶ è‰² (åŠ ä¸Š active class)
                    // '1' = å·²é ç´„ â†’ ç°è‰² (ä¸åŠ  active class)
                    if (status.charAt(h) === '0') {
                        dot.classList.add('active');  // ç¶ è‰²
                    } else if (status.charAt(h) === '2') {
                        dot.classList.add('reserved'); // æ©˜è‰² (Status 2 = Booked)
                    }
                    summary.appendChild(dot);
                }
                cell.appendChild(summary);

                // å°‡æ—¥æœŸæ ¼å­åŠ å…¥æœˆæ›†å®¹å™¨
                gridContainer.appendChild(cell);
            }

            // æ­¥é©Ÿ 5: ä¸å¡«å……å¾Œé¢çš„ç©ºç™½æ ¼å­
            // é€™æ¨£æœˆæ›†å°±åªæœƒé¡¯ç¤ºç•¶æœˆçš„æ—¥æœŸ
            // ä¸æœƒé¡¯ç¤ºä¸‹å€‹æœˆçš„æ—¥æœŸ
            // æœˆæ›†çš„é«˜åº¦æœƒæ ¹æ“šç•¶æœˆçš„å¤©æ•¸è‡ªå‹•èª¿æ•´
        }

        // Modal ç›¸é—œè®Šæ•¸
        let modalCurrentDate = '';
        let modalCurrentStatus = [];

        // é–‹å•Ÿè©³ç´°è¨­å®š
        function openModal(dateStr, statusStr) {
            modalCurrentDate = dateStr;
            modalCurrentStatus = statusStr.split('');

            document.getElementById('modalDateTitle').textContent = `${dateStr} è¨­å®š`;
            renderModalGrid();

            document.getElementById('dayDetailModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('dayDetailModal').style.display = 'none';
        }

        // æ¸²æŸ“ Modal å…§çš„ 24 å°æ™‚æ ¼å­
        function renderModalGrid() {
            const container = document.getElementById('dayHoursGrid');
            container.innerHTML = '';

            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.textContent = `${String(i).padStart(2, '0')}:00`;

                // 2=Booked/Buffer (Orange) -> LINK TO BOOKING PAGE
                if (modalCurrentStatus[i] === '2') {
                    cell.classList.add('reserved');
                    cell.title = "é»æ“Šå‰å¾€é ç´„ç®¡ç† (æŸ¥çœ‹/æ¥å—/å–æ¶ˆ)";
                    cell.style.cursor = "pointer";

                    cell.onclick = () => {
                        // è·³è½‰åˆ°é ç´„ç®¡ç†é é¢ (å¸¶ä¸Šæ—¥æœŸåƒæ•¸æ–¹ä¾¿ç¯©é¸ï¼Œéœ€å¾ŒçºŒå¯¦ä½œ frontend æ”¯æ´åƒæ•¸)
                        // ç›®å‰å…ˆå–®ç´”è·³è½‰
                        window.location.href = '/sitter/bookings';
                    };
                }
                // 0=Available (Green)
                else if (modalCurrentStatus[i] === '0') {
                    cell.classList.add('available');
                    cell.title = "å¯é ç´„";

                    cell.onclick = () => {
                        modalCurrentStatus[i] = '1'; // 0->1
                        renderModalGrid();
                    };
                }
                // 1=Resting (Gray)
                else {
                    cell.classList.add('busy');
                    cell.title = "ä¼‘æ¯ä¸­";

                    cell.onclick = () => {
                        modalCurrentStatus[i] = '0'; // 1->0
                        renderModalGrid();
                    };
                }

                container.appendChild(cell);
            }

        }

        function toggleStatus(i) {
            // åƒ…å…è¨± 0(ç©ºé–’) èˆ‡ 1(ä¼‘æ¯) äº’æ›ï¼Œä¸è™•ç† 2
            if (modalCurrentStatus[i] === '0') {
                modalCurrentStatus[i] = '1';
            } else if (modalCurrentStatus[i] === '1') {
                modalCurrentStatus[i] = '0';
            }
            renderModalGrid();
        }

        // å„²å­˜è¨­å®š
        function saveDaySchedule() {
            const newStatusStr = modalCurrentStatus.join('');
            console.log('ğŸš€ é–‹å§‹å„²å­˜:', modalCurrentDate, newStatusStr);

            fetch('/sitter/api/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: modalCurrentDate,
                    status: newStatusStr
                })
            })
                .then(res => {
                    console.log('ğŸ“¡ æ”¶åˆ°å›æ‡‰ï¼Œç‹€æ…‹ç¢¼:', res.status, 'OK:', res.ok);

                    // å…ˆæª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
                    if (!res.ok) {
                        return res.json().then(errData => {
                            throw new Error(errData.message || `HTTP ${res.status}`);
                        }).catch(() => {
                            throw new Error(`HTTP ${res.status}`);
                        });
                    }

                    // è§£ææˆåŠŸçš„ JSON å›æ‡‰
                    return res.json();
                })
                .then(data => {
                    console.log('âœ… å„²å­˜æˆåŠŸï¼Œä¼ºæœå™¨å›æ‡‰:', data);
                    console.log('ğŸ“… æ›´æ–°æ—¥æœŸ:', modalCurrentDate);
                    console.log('ğŸ• æ–°ç‹€æ…‹:', newStatusStr);

                    // æ›´æ–°å¿«å–
                    scheduleCache[modalCurrentDate] = newStatusStr;
                    console.log('ğŸ’¾ å¿«å–å·²æ›´æ–°:', scheduleCache[modalCurrentDate]);

                    // é‡ç¹ªæœˆæ›†
                    const grid = document.getElementById('calendar-grid');
                    renderGrid(grid);
                    console.log('ğŸ”„ æœˆæ›†å·²é‡ç¹ª');

                    // é—œé–‰ Modal
                    closeModal();

                    // é¡¯ç¤ºæˆåŠŸçš„è¦–è¦ºå›é¥‹ï¼ˆç¶ è‰²é–ƒçˆæ•ˆæœï¼‰
                    const calendarCard = document.getElementById('calendar-card');
                    calendarCard.style.transition = 'box-shadow 0.3s';
                    calendarCard.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.6)';
                    setTimeout(() => {
                        calendarCard.style.boxShadow = '';
                    }, 800);
                })
                .catch(err => {
                    console.error('âŒ å„²å­˜å¤±æ•—:', err);
                    console.error('éŒ¯èª¤è©³æƒ…:', err.message);

                    // é¡¯ç¤ºéŒ¯èª¤çš„è¦–è¦ºå›é¥‹ï¼ˆç´…è‰²é–ƒçˆæ•ˆæœï¼‰
                    const calendarCard = document.getElementById('calendar-card');
                    calendarCard.style.transition = 'box-shadow 0.3s';
                    calendarCard.style.boxShadow = '0 0 20px rgba(244, 67, 54, 0.6)';
                    setTimeout(() => {
                        calendarCard.style.boxShadow = '';
                    }, 800);
                });
        }

        // è¨»ï¼šæª¢èˆ‰åŠŸèƒ½å·²æ”¹ç”¨ complaint-functions.js çš„ injectReportBox()

    </script>

    <script th:src="@{/js/frontend/main.js}"></script>
    <script th:src="@{/js/frontend/evaluate-functions.js}"></script>
    <script th:src="@{/js/frontend/complaint-functions.js}"></script>
    <script th:src="@{/js/frontend/sitter-evaluate-functions.js}"></script>

</body>

</html>