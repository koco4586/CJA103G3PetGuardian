<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成為保母 | PetGuardian</title>
    <link rel="stylesheet" href="/css/frontend/style.css">
    <link rel="stylesheet" href="/css/frontend/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/frontend/dashboard.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>

    <header id="main-header" class="header"></header>

    <div class="container dashboard-container">
        <!-- Sidebar -->
        <div th:replace="~{frontend/fragments/dashboard-sidebar :: sidebar(activePage='sitter-registration')}"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="sitter-register">
                <h2 class="mb-2">成為 PetGuardian 保母</h2>
                <p style="color: #666; margin-bottom: 2rem;">加入我們的專業保母團隊，開始您的寵物照顧事業！</p>

                <div class="card">
                    <!-- 訊息提示區塊 -->
                    <div th:if="${successMessage}" class="alert alert-success" role="alert"
                        style="color: green; background: #d4edda; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                        <span th:text="${successMessage}"></span>
                    </div>

                    <div th:if="${errorMessage}" class="alert alert-danger" role="alert"
                        style="color: red; background: #f8d7da; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                        <span th:text="${errorMessage}"></span>
                    </div>

                    <form th:action="@{/sitter/apply}" method="post" th:object="${sitterApplication}"
                        onsubmit="return confirmSubmit()">
                        <!-- 申請人資料（唯讀顯示） -->
                        <h3 class="mb-3" style="font-size: 1.2rem; color: var(--primary-color);">申請人資料</h3>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <p style="margin: 0.5rem 0;">
                                    <strong>姓名：</strong>
                                    <span th:text="${memName}">測試會員</span>
                                </p>
                                <p style="margin: 0.5rem 0;">
                                    <strong>電話：</strong>
                                    <span th:text="${memPhone}">0912345678</span>
                                </p>
                            </div>
                        </div>

                        <!-- 申請資料（需填寫） -->
                        <h3 class="mb-3" style="font-size: 1.2rem; color: var(--primary-color);">申請資料</h3>

                        <div class="form-group mb-3">
                            <label class="form-label">個人簡介 <span style="color: red;">*</span></label>
                            <textarea th:field="*{appIntro}" class="form-control" rows="4"
                                placeholder="請簡單介紹您自己，例如：您的背景、為什麼想成為寵物保姆等（10-500字）" required></textarea>
                            <small style="color: #666;">請輸入 5-500 字</small>
                            <small id="introCount" style="display: block; margin-top: 0.25rem; color: #999;">目前字數: 0 /
                                500</small>
                            <div th:if="${#fields.hasErrors('appIntro')}"
                                style="color: red; font-size: 0.9rem; margin-top: 0.25rem;">
                                <span th:errors="*{appIntro}"></span>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="form-label">相關經驗說明 <span style="color: red;">*</span></label>
                            <textarea th:field="*{appExperience}" class="form-control" rows="4"
                                placeholder="請描述您照顧寵物的相關經驗，例如：曾經照顧過的寵物類型、時間長度、特殊技能等（10-500字）" required></textarea>
                            <small style="color: #666;">請輸入 5-500 字</small>
                            <small id="experienceCount" style="display: block; margin-top: 0.25rem; color: #999;">目前字數:
                                0 / 500</small>
                            <div th:if="${#fields.hasErrors('appExperience')}"
                                style="color: red; font-size: 0.9rem; margin-top: 0.25rem;">
                                <span th:errors="*{appExperience}"></span>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" style="padding: 0.8rem 3rem;"
                                th:disabled="${isDisableSubmit}">提交申請</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer id="main-footer" style="margin-top: 4rem;"></footer>

    <script src="/js/frontend/main.js"></script>
    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // 即時字數統計 + LocalStorage 自動儲存
        document.addEventListener('DOMContentLoaded', function () {
            // 使用 name 屬性選取 textarea (Thymeleaf 會將 th:field="*{appIntro}" 轉換為 name="appIntro")
            const introTextarea = document.querySelector('textarea[name="appIntro"]');
            const experienceTextarea = document.querySelector('textarea[name="appExperience"]');
            const introCount = document.getElementById('introCount');
            const experienceCount = document.getElementById('experienceCount');

            // LocalStorage 的 key 名稱
            const STORAGE_KEY_INTRO = 'sitterApplication_appIntro';
            const STORAGE_KEY_EXPERIENCE = 'sitterApplication_appExperience';

            // 更新字數統計的函數
            function updateCount(textarea, countElement) {
                const length = textarea.value.length;
                const maxLength = 500;
                const minLength = 5;

                countElement.textContent = `目前字數: ${length} / ${maxLength}`;

                // 根據字數改變顏色
                if (length < minLength) {
                    countElement.style.color = '#dc3545'; // 紅色 - 字數不足
                } else if (length > maxLength) {
                    countElement.style.color = '#dc3545'; // 紅色 - 超過限制
                } else {
                    countElement.style.color = '#28a745'; // 綠色 - 正常範圍
                }
            }

            // 儲存表單資料到 LocalStorage
            function saveFormData() {
                if (introTextarea) {
                    localStorage.setItem(STORAGE_KEY_INTRO, introTextarea.value);
                }
                if (experienceTextarea) {
                    localStorage.setItem(STORAGE_KEY_EXPERIENCE, experienceTextarea.value);
                }
            }

            // 從 LocalStorage 恢復表單資料
            function restoreFormData() {
                const savedIntro = localStorage.getItem(STORAGE_KEY_INTRO);
                const savedExperience = localStorage.getItem(STORAGE_KEY_EXPERIENCE);

                // 只在欄位為空時才恢復資料（避免覆蓋後端回填的資料）
                if (introTextarea && savedIntro && !introTextarea.value) {
                    introTextarea.value = savedIntro;
                    updateCount(introTextarea, introCount);
                }
                if (experienceTextarea && savedExperience && !experienceTextarea.value) {
                    experienceTextarea.value = savedExperience;
                    updateCount(experienceTextarea, experienceCount);
                }
            }

            // 清除 LocalStorage 中的表單資料
            function clearFormData() {
                localStorage.removeItem(STORAGE_KEY_INTRO);
                localStorage.removeItem(STORAGE_KEY_EXPERIENCE);
            }

            // 頁面載入時恢復資料
            restoreFormData();

            // 監聽輸入事件 - 字數統計 + 自動儲存
            if (introTextarea && introCount) {
                introTextarea.addEventListener('input', function () {
                    updateCount(this, introCount);
                    saveFormData(); // 自動儲存
                });
                // 初始化字數統計
                updateCount(introTextarea, introCount);
            }

            if (experienceTextarea && experienceCount) {
                experienceTextarea.addEventListener('input', function () {
                    updateCount(this, experienceCount);
                    saveFormData(); // 自動儲存
                });
                // 初始化字數統計
                updateCount(experienceTextarea, experienceCount);
            }

            // 檢查是否有成功訊息，如果有則清除暫存資料
            const successMessage = document.querySelector('.alert-success');
            if (successMessage) {
                clearFormData();
            }
        });

        function confirmSubmit() {
            try {
                // 使用 name 屬性取得欄位值
                const introTextarea = document.querySelector('textarea[name="appIntro"]');
                const experienceTextarea = document.querySelector('textarea[name="appExperience"]');

                if (!introTextarea || !experienceTextarea) {
                    console.error('找不到表單欄位');
                    return true; // 如果找不到欄位,讓後端處理驗證
                }

                const introValue = introTextarea.value;
                const experienceValue = experienceTextarea.value;

                // 驗證個人簡介
                if (introValue.length < 5) {
                    showError('個人簡介字數不足', '個人簡介至少需要 5 個字,目前只有 ' + introValue.length + ' 個字');
                    return false;
                }

                if (introValue.length > 500) {
                    showError('個人簡介字數超過限制', '個人簡介最多 500 個字,目前有 ' + introValue.length + ' 個字');
                    return false;
                }

                // 驗證相關經驗
                if (experienceValue.length < 5) {
                    showError('相關經驗字數不足', '相關經驗至少需要 5 個字,目前只有 ' + experienceValue.length + ' 個字');
                    return false;
                }

                if (experienceValue.length > 500) {
                    showError('相關經驗字數超過限制', '相關經驗最多 500 個字,目前有 ' + experienceValue.length + ' 個字');
                    return false;
                }

                // 所有驗證通過,跳出確認視窗
                if (confirm('確定要提交申請成為保姆嗎?')) {
                    return true;
                }
                return false;
            } catch (error) {
                console.error('驗證函數執行錯誤:', error);
                // 如果驗證函數出錯,讓後端處理
                return true;
            }
        }

        // 顯示錯誤訊息的輔助函數
        function showError(title, text) {
            // 檢查 SweetAlert2 是否載入
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: title,
                    text: text,
                    confirmButtonText: '確認'
                });
            } else {
                // Fallback: 使用原生 alert
                alert(title + '\n\n' + text);
            }
        }
    </script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            // 取得後端傳來的 errorMessage
            var errorMessage = /*[[${errorMessage}]]*/ '';

            // 檢查是否包含 "停權" 關鍵字
            if (errorMessage && errorMessage.includes('停權')) {
                Swal.fire({
                    title: '通知',
                    text: '你已被停權，請向管理員聯繫處理',
                    icon: 'warning',
                    confirmButtonText: '確認',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then((result) => {
                    // 關閉後強制跳轉首頁
                    if (result.isConfirmed) {
                        window.location.href = '/';
                    }
                });
            }
        });
        /*]]>*/
    </script>
</body>

</html>