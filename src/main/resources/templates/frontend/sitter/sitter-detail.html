<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿æ¯è©³æƒ… - PetGuardian</title>
    <link rel="stylesheet" th:href="@{/css/frontend/style.css}">
    <link rel="stylesheet" th:href="@{/css/frontend/components.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .profile-header {
            background: linear-gradient(to bottom, #f8f9fa 50%, transparent 50%);
            padding-top: 2rem;
        }

        .profile-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
            color: var(--primary-color);
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px dashed #eee;
        }

        .service-item:last-child {
            border-bottom: none;
        }

        .price-text {
            color: var(--danger);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .area-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
            font-size: 0.9rem;
        }

        .review-card {
            border-bottom: 1px solid #eee;
            padding: 1.5rem 1.2rem;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .booking-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
    </style>
    <style>
        /* æª¢èˆ‰è¼¸å…¥æ¡†æ¨£å¼ */
        .dynamic-report-wrapper {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0 20px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fff5f5;
            border-radius: 15px;
            border: 1px solid transparent;
            width: 100%;
            box-sizing: border-box;
        }

        .dynamic-report-wrapper.active {
            max-height: 800px;
            opacity: 1;
            margin-top: 15px;
            padding: 20px;
            border: 1px solid #ffcdd2;
            box-shadow: 0 4px 15px rgba(255, 205, 210, 0.3);
        }

        .report-tag {
            display: inline-block;
            padding: 6px 14px;
            margin: 5px;
            background: #fff;
            border: 1px solid #ffcdd2;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #c62828;
            transition: all 0.2s;
        }

        .report-tag.selected {
            background: #ffcdd2;
            font-weight: bold;
        }

        .submit-report-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            float: right;
            transition: transform 0.1s, background 0.2s;
        }

        .submit-report-btn:active {
            transform: scale(0.92);
        }

        .submit-report-btn:hover {
            background: #ff5252;
        }
    </style>
</head>

<body style="padding-bottom: 80px;"> <!-- é ç•™åº•éƒ¨é ç´„æŒ‰éˆ•ç©ºé–“ -->

    <!-- Header -->
    <header id="main-header" class="header"></header>

    <div class="container" style="padding-top: 2rem;">
        <div class="row">
            <!-- å·¦å´ï¼šå€‹äººç°¡ä»‹ -->
            <div class="col-md-4">
                <div class="profile-card">
                    <!-- é è¨­é ­åƒæˆ–ä¿æ¯ä¸Šå‚³çš„é ­åƒ -->
                    <img th:if="${sitterMember != null and sitterMember.memImage != null}"
                        th:src="${sitterMember.memImage}" class="profile-avatar" alt="ä¿æ¯é ­åƒ">
                    <img th:unless="${sitterMember != null and sitterMember.memImage != null}"
                        th:src="'https://api.dicebear.com/7.x/avataaars/svg?seed=' + ${sitter.sitterId}"
                        class="profile-avatar" alt="é è¨­é ­åƒ">

                    <!-- B. ä¿æ¯åç¨± -->
                    <h2 class="mb-2" th:text="${sitter.sitterName}">ä¿æ¯åç¨±</h2>

                    <!-- <div class="d-flex justify-center align-center mb-3 text-warning">
                        <i class="fas fa-star"></i>
                        <span class="ms-1 fw-bold"
                            th:text="${sitter.sitterStarCount != null ? sitter.sitterStarCount : '0.0'}">5.0</span>
                        <span class="text-muted ms-1"
                            th:text="'(' + (${sitter.sitterRatingCount != null ? sitter.sitterRatingCount : 0}) + ' å‰‡è©•åƒ¹)'">(10
                            å‰‡è©•åƒ¹)</span>
                    </div> -->

                    <!-- <p class="text-muted" th:if="${sitter.sitterAdd}" th:text="'ğŸ“ ' + ${sitter.sitterAdd}">å°åŒ—å¸‚å¤§å®‰å€</p> -->
                </div>
            </div>

            <!-- å³å´ï¼šè©³ç´°è³‡è¨Š -->
            <div class="col-md-8">

                <!-- C. æœå‹™å°è±¡ (å¯µç‰©ç¨®é¡èˆ‡é«”å‹) -->
                <div class="section-card">
                    <h3 class="section-title"><i class="fas fa-paw"></i> æœå‹™å°è±¡</h3>
                    <div th:if="${petTypes != null and !petTypes.isEmpty()}">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead style="background-color: #f8f9fa;">
                                    <tr class="text-center">
                                        <th style="width: 25%; padding: 1rem;">æœå‹™é …ç›®</th>
                                        <th style="width: 25%; padding: 1rem;">å¯µç‰©ç¨®é¡</th>
                                        <th style="width: 25%; padding: 1rem;">é«”å‹</th>
                                        <th style="width: 25%; padding: 1rem;">åƒ¹æ ¼</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="pt : ${petTypes}" class="text-center align-middle">
                                        <!-- æœå‹™é …ç›® -->
                                        <td style="padding: 1rem;">
                                            <span class="badge bg-secondary"
                                                style="font-size: 0.95rem; padding: 0.5em 1em;"
                                                th:text="${serviceNameMap.get(pt.serviceItemId) != null ? serviceNameMap.get(pt.serviceItemId) : 'é …ç›® ' + pt.serviceItemId}">
                                                æœå‹™é …ç›®
                                            </span>
                                        </td>

                                        <!-- ç¨®é¡ -->
                                        <td style="padding: 1rem;">
                                            <span th:switch="${pt.typeId}"
                                                class="badge rounded-pill bg-light text-dark border"
                                                style="font-size: 0.95rem; padding: 0.5em 1em;">
                                                <i class="fas"
                                                    th:classappend="${pt.typeId == 1} ? 'fa-dog' : 'fa-cat'"></i>
                                                <span th:case="1">ç‹—</span>
                                                <span th:case="2">è²“</span>
                                            </span>
                                        </td>

                                        <!-- é«”å‹ -->
                                        <td style="padding: 1rem;">
                                            <span th:switch="${pt.sizeId}" style="font-size: 1rem;">
                                                <span th:case="1">å°å‹</span>
                                                <span th:case="2">ä¸­å‹</span>
                                                <span th:case="3">å¤§å‹</span>
                                                <span th:case="*">ä¸é™</span>
                                            </span>
                                        </td>

                                        <!-- åƒ¹æ ¼ -->
                                        <td style="padding: 1rem;">
                                            <span class="text-danger fw-bold" style="font-size: 1.1rem;"
                                                th:text="${servicePriceMap.get(pt.serviceItemId) != null ? '$' + servicePriceMap.get(pt.serviceItemId) : 'å¦æ´½'}">
                                                $500
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div th:if="${petTypes == null or petTypes.isEmpty()}" class="text-center text-muted">
                        æœªè¨­å®šæœå‹™å°è±¡èˆ‡åƒ¹æ ¼
                    </div>
                </div>

                <!-- E. æœå‹™åœ°å€ -->
                <div class="section-card">
                    <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> æœå‹™åœ°å€</h3>
                    <div th:if="${serviceAreas != null and !serviceAreas.isEmpty()}">
                        <span th:each="area : ${serviceAreas}" class="area-tag">
                            <i class="fas fa-location-arrow"></i>
                            <span th:text="${area.area.cityName + ' ' + area.area.district}">å°åŒ—å¸‚ å¤§å®‰å€</span>
                        </span>
                    </div>
                    <div th:if="${serviceAreas == null or serviceAreas.isEmpty()}" class="text-center text-muted">
                        å…¨å€æœå‹™æˆ–æœªè¨­å®š
                    </div>
                </div>

                <!-- F. æ­·å²è©•åƒ¹ -->
                <div class="section-card" id="reviews" th:data-sitter-id="${sitter.sitterId}"
                    th:data-sitter-name="${sitter.sitterName}">
                    <h3 class="section-title" style="cursor: pointer; user-select: none;"
                        onclick="toggleHistoryReviews('reviewsList', 'toggleIcon')">
                        <i class="fas fa-comments"></i> æ­·å²è©•åƒ¹
                        <span style="color: #999; font-size: 0.9rem; margin-left: 10px;">
                            (å…± <span th:text="${reviews != null ? reviews.size() : 0}">0</span> ç­†)
                        </span>
                        <i id="toggleIcon" class="fas fa-chevron-down"
                            style="float: right; transition: transform 0.3s;"></i>
                    </h3>

                    <div id="reviewsList" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease;">
                        <div th:if="${reviews != null and !reviews.isEmpty()}">
                            <div class="review-card" th:each="review : ${reviews}">
                                <div class="review-header">
                                    <!-- é¡¯ç¤ºè©•åƒ¹è€… (æœƒå“¡ ID æˆ– åç¨±ï¼Œé€™è£¡æš«ç”¨ ID) -->
                                    <div>
                                        <strong>æœƒå“¡ <span th:text="${review.memId}">ID</span></strong>
                                        <button class="btn btn-sm btn-outline-danger ms-2"
                                            style="padding: 0px 6px; font-size: 0.8rem;"
                                            th:onclick="'reportReview(' + ${review.bookingOrderId} + ')'">
                                            <i class="fas fa-flag"></i> æª¢èˆ‰
                                        </button>
                                    </div>
                                    <div style="color: #ffc107;" th:if="${review.sitterRating != null}">
                                        <i class="fas fa-star"
                                            th:each="i : ${#numbers.sequence(1, review.sitterRating)}"></i>
                                    </div>
                                </div>
                                <p class="mb-0 text-muted" th:text="${review.sitterReview}">å¾ˆæ£’çš„ä¿æ¯ï¼</p>
                                <small class="text-muted"
                                    th:text="${#temporals.format(review.endTime, 'yyyy-MM-dd')}">2023-10-10</small>
                            </div>
                        </div>
                    </div>

                    <div th:if="${reviews == null or reviews.isEmpty()}" class="text-center text-muted py-3">
                        <i class="far fa-comment-dots fa-2x mb-2"></i>
                        <p>ç›®å‰å°šç„¡è©•åƒ¹ç´€éŒ„</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- G. åº•éƒ¨é ç´„æŒ‰éˆ• -->
    <div class="booking-bar container">
        <div class="d-none d-md-block">
            <h5 class="mb-0 text-primary" th:text="${sitter.sitterName}">ä¿æ¯åç¨±</h5>
            <small class="text-muted">å°ˆæ¥­ç”¨å¿ƒï¼Œå€¼å¾—ä¿¡è³´</small>
        </div>
        <div class="d-flex gap-2 w-100 w-md-auto justify-content-end">
            <a href="#" onclick="history.back()" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> è¿”å›
            </a>
            <!-- é€£çµåˆ°é ç´„é é¢ï¼Œå¸¶ä¸Š sitterId -->
            <!-- <a th:href="@{/booking/create(sitterId=${sitter.sitterId})}" class="btn btn-primary"
                style="min-width: 150px;">
                <i class="fas fa-calendar-check"></i> ç«‹å³é ç´„
            </a> -->

            <button class="btn btn-primary" style="min-width: 150px;"
                th:onclick="openBookingModal([[${sitter.sitterName}]], [[${sitter.sitterId}]])">
                <i class="fas fa-calendar-check"></i> ç«‹å³é ç´„
            </button>
        </div>
    </div>
    <!--åŒæ­¥services.html-->
    <!-- é ç´„ Modal -->
    <div id="bookingModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center;">
        <div
            style="background: white; padding: 2.5rem; border-radius: 2rem; width: 95%; max-width: 450px; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <button onclick="closeModal()"
                style="position: absolute; right: 1.5rem; top: 1.5rem; background: #f0f0f0; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer;">&times;</button>
            <h3 style="font-weight: 700; font-size: 1.5rem;">
                é ç´„ <span id="sitterName" style="color: var(--primary-color);"></span>
            </h3>

            <form id="realBookingForm" class="mt-2">
                <input type="hidden" id="modalSitterId">
                <div class="form-group">
                    <label class="form-label">é¸æ“‡å°æ¯›å­©</label> <select class="form-control" id="petId">
                        <option th:if="${#lists.isEmpty(myPets)}" value="">è«‹å…ˆè‡³æœƒå“¡ä¸­å¿ƒæ–°å¢å¯µç‰©</option>

                        <option th:each="pet : ${myPets}" th:value="${pet.petId}"
                            th:text="${pet.petName} + ' (' + ${pet.petTypeName} + ')'">
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æœå‹™é …ç›®</label> <select class="form-control" id="serviceItemId">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é–‹å§‹æ™‚é–“</label> <input type="datetime-local" id="startTime"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">çµæŸæ™‚é–“</label> <input type="datetime-local" id="endTime"
                        class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">ç‰¹åˆ¥éœ€æ±‚</label>
                    <textarea class="form-control" id="bookingNotes" rows="2" placeholder="æœ‰ä»€éº¼æƒ³å‘Šè¨´ä¿æ¯çš„å—ï¼Ÿ"></textarea>
                </div>
                <button type="button" class="btn btn-primary"
                    style="width: 100%; border-radius: 3rem; margin-top: 1rem; height: 50px; font-size: 1.1rem;"
                    onclick="submitBooking()">ç¢ºèªé€å‡º</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer id="main-footer" class="footer"></footer>

    <!-- JS -->
    <!-- Scripts moved to bottom for consistency -->

    <script th:inline="javascript">
        /*<![CDATA[*/
        const contextPath = /*[[@{/}]]*/ '';
        /*]]>*/

        // 1. é–‹å•Ÿé ç´„å½ˆçª— (åŒæ­¥ services.html é‚è¼¯)
        async function openBookingModal(name, id) {
            console.log("æ­£åœ¨é–‹å•Ÿé ç´„å½ˆçª— (Async/Detail):", name, id);
            const modal = document.getElementById('bookingModal');
            const sitterNameSpan = document.getElementById('sitterName');
            const sitterIdInput = document.getElementById('modalSitterId');
            const startInput = document.getElementById('startTime');
            const endInput = document.getElementById('endTime');
            const serviceSelect = document.getElementById('serviceItemId');

            if (!modal || !sitterNameSpan || !sitterIdInput) {
                console.error("æ‰¾ä¸åˆ°å¿…è¦çš„å½ˆçª—å…ƒä»¶");
                return;
            }

            sitterNameSpan.innerText = name;
            sitterIdInput.value = id;

            // é‡ç½®ä¸¦è¼‰å…¥æœå‹™é …ç›®
            serviceSelect.innerHTML = '<option>æ­£åœ¨è¼‰å…¥æœå‹™...</option>';
            serviceSelect.disabled = true;

            try {
                // ç™¼é€è«‹æ±‚å»å¾Œç«¯ API æŠ“å–æœå‹™è³‡æ–™
                const response = await fetch(`/booking/api/sitter/${id}/services`);
                if (!response.ok) throw new Error("è³‡æ–™è®€å–å¤±æ•—");

                const services = await response.json();

                // è¼‰å…¥å®Œæˆï¼Œé‡ç½®é¸å–®
                serviceSelect.innerHTML = '';
                serviceSelect.disabled = false;

                if (services.length === 0) {
                    let opt = document.createElement('option');
                    opt.text = "æ­¤ä¿æ¯æš«ç„¡æœå‹™é …ç›®";
                    serviceSelect.add(opt);
                } else {
                    services.forEach(svc => {
                        let opt = document.createElement('option');
                        opt.value = svc.id;
                        opt.text = svc.name;
                        serviceSelect.add(opt);
                    });
                }
            } catch (error) {
                console.error("è¼‰å…¥æœå‹™å¤±æ•—:", error);
                serviceSelect.innerHTML = '<option>è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</option>';
                serviceSelect.disabled = false;
            }

            // è‡ªå‹•è¨­å®šæ™‚é–“é™åˆ¶ (ç¾åœ¨ç•¶ä¸‹ ~ 60å¤©å…§)
            const now = new Date();
            const minDate = new Date(now.getTime());
            const maxDate = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000);

            function formatDT(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                const h = String(date.getHours()).padStart(2, '0');
                const min = String(date.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${d}T${h}:${min}`;
            }

            const minStr = formatDT(minDate);
            const maxStr = formatDT(maxDate);

            if (startInput) {
                startInput.min = minStr;
                startInput.max = maxStr;
                startInput.value = minStr; // é è¨­å¸¶å…¥æœ€æ—©å¯é¸æ™‚é–“
            }
            if (endInput) {
                endInput.min = minStr;
                endInput.max = maxStr;
            }

            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('bookingModal');
            if (modal) modal.style.display = 'none';
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('bookingModal');
            if (e.target === modal) closeModal();
        });

        // 3. æäº¤é‚è¼¯
        async function submitBooking() {
            const petId = document.getElementById('petId').value;
            if (!petId) {
                alert("ç›®å‰å°šç„¡å¯µç‰©è³‡æ–™ï¼Œè«‹å…ˆæ–°å¢å¯µç‰©ï¼");
                return;
            }

            const startVal = document.getElementById('startTime').value;
            const endVal = document.getElementById('endTime').value;

            if (!startVal || !endVal) {
                alert("è«‹å¡«å¯«æ™‚é–“ï¼");
                return;
            }

            if (new Date(startVal) >= new Date(endVal)) {
                alert("çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“ï¼");
                return;
            }

            const formData = new URLSearchParams();
            formData.append('sitterId', document.getElementById('modalSitterId').value);
            formData.append('petId', petId);
            formData.append('serviceItemId', document.getElementById('serviceItemId').value);
            formData.append('startTime', startVal);
            formData.append('endTime', endVal);
            formData.append('bookingNotes', document.getElementById('bookingNotes').value);

            try {
                const response = await fetch('/booking/submit', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert("é ç´„æˆåŠŸï¼");
                    window.location.href = "/booking/memberOrders";
                } else {
                    const msg = await response.text();
                    alert("é ç´„å¤±æ•—ï¼š" + msg);
                }
            } catch (err) {
                console.error(err);
                alert("ç™¼ç”Ÿç³»çµ±éŒ¯èª¤");
            }
        }
    </script>

    <script th:src="@{/js/frontend/main.js}"></script>
    <script th:src="@{/js/frontend/evaluate-functions.js}"></script>
    <script th:src="@{/js/frontend/complaint-functions.js}"></script>

    <script th:inline="javascript">
        // 5. è¼‰å…¥è©•åƒ¹è³‡æ–™ (å»¶é²åˆ° DOM èˆ‡ JS æª”æ¡ˆè¼‰å…¥å®Œæˆ)
        document.addEventListener('DOMContentLoaded', function () {
            const reviewsCard = document.getElementById('reviews');
            if (reviewsCard) {
                const sitterId = reviewsCard.getAttribute('data-sitter-id');
                const sitterName = reviewsCard.getAttribute('data-sitter-name');
                if (sitterId && typeof loadAndDisplayReviews === 'function') {
                    loadAndDisplayReviews(sitterId, '#reviewsList', 'span', sitterName);
                }
            }
        });
    </script>
</body>

</html>