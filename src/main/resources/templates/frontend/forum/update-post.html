<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç·¨è¼¯è²¼æ–‡ | PetGuardian</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root { --primary-orange: #ff9800; --deep-brown: #5d4037; --bg-light: #fdfcf8; }
    body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; }
    
    .update-container {
        max-width: 800px; margin: 40px auto; background: #fff;
        border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden;
    }
    
    .update-header {
        background: linear-gradient(135deg, #fffcf5 0%, #faedcd 100%);
        padding: 30px; border-bottom: 1px solid #eee; text-align: center;
    }
    .update-header h2 { margin: 0; color: var(--deep-brown); font-weight: 900; }
    
    .update-body { padding: 40px; }
    
    .form-group { margin-bottom: 25px; }
    .form-label { display: block; font-weight: 800; color: var(--deep-brown); margin-bottom: 10px; font-size: 1.1rem; }
    
    .form-control {
        width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px;
        font-size: 1rem; transition: 0.3s; box-sizing: border-box; font-family: inherit;
    }
    .form-control:focus { border-color: var(--primary-orange); outline: none; box-shadow: 0 0 0 4px rgba(255, 152, 0, 0.1); }
    
    textarea.form-control { height: 300px; resize: vertical; line-height: 1.6; }

    /* åœ–ç‰‡ç®¡ç†å€ */
    .current-pics-section {
        margin-bottom: 25px; padding: 15px; background: var(--bg-light);
        border-radius: 12px; border: 1px dashed #ddd;
    }
    .pics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
    .pic-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .pic-item img { width: 100%; height: 100%; object-fit: cover; }

    .file-input-wrapper {
        position: relative; padding: 20px; border: 2px dashed #ccc;
        border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s;
    }
    .file-input-wrapper:hover { border-color: var(--primary-orange); background: #fffcf5; }
    
    .update-footer {
        padding: 25px 40px; background: #fcfcfc; border-top: 1px solid #eee;
        display: flex; justify-content: space-between; align-items: center;
    }
    
    .btn-save {
        background: var(--primary-orange); color: white; border: none;
        padding: 12px 35px; border-radius: 50px; font-weight: 800;
        font-size: 1.1rem; cursor: pointer; transition: 0.3s;
    }
    .btn-save:hover { background: #f57c00; transform: translateY(-2px); }
    
    .btn-cancel { text-decoration: none; color: #888; font-weight: 700; }
    
    /* éŒ¯èª¤å€å¡Šï¼šäº®ç´…è‰²å¼·åŒ– */
    .error-box { background-color: #fff5f5; border: 2px solid #ff0000; padding: 15px; margin-bottom: 25px; border-radius: 8px; }
    .error-box p { color: #cf1322; margin: 0 0 10px 0; font-weight: 900; }
    .error-list { margin: 0; padding-left: 20px; color: #ff0000; font-weight: 600; }

	/* ç•¶æª”æ¡ˆæ‹–åˆ°ä¸Šæ–¹æ™‚è®Šè‰² */
	.file-input-wrapper.drag-over {
	    background-color: #fffcf5;
	    border: 2px dashed var(--primary-orange) !important;
	}

</style>
</head>
<body>

    <div class="update-container">
        <div class="update-header">
            <h2>ğŸ¾ ç·¨è¼¯æ‚¨çš„è²¼æ–‡</h2>
        </div>

        <form class="update-body" th:action="@{/forumpost/update-post-submit}" th:object="${forumPostVO}" method="post" enctype="multipart/form-data">
            
            <input type="hidden" th:field="*{postId}">
            <input type="hidden" th:field="*{postStatus}">
           
            <div th:if="${#fields.hasAnyErrors()}" class="error-box">
                <p><i class="fas fa-exclamation-circle"></i> éŒ¯èª¤è¨Šæ¯ï¼š</p>
                <ul class="error-list">
                    <li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
                </ul>
            </div>
           
            <div class="form-group">
                <label class="form-label">è²¼æ–‡æ¨™é¡Œ</label>
                <input type="text" th:field="*{postTitle}" class="form-control" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ...">
                <div class="error-msg" th:if="${#fields.hasErrors('postTitle')}" th:errors="*{postTitle}" style="display: none;"></div>
            </div>

            <div class="form-group">
                <label class="form-label">æ–‡ç« å…§å®¹</label>
                <textarea th:field="*{postContent}" class="form-control" placeholder="åˆ†äº«æ‚¨çš„å¯µç‰©è¶£äº‹..."></textarea>
                <div class="error-msg" th:if="${#fields.hasErrors('postContent')}" th:errors="*{postContent}" style="display: none;"></div>
            </div>
			<div class="form-group">
			    <label class="form-label">ä¸»é å°é¢åœ–ç‰‡</label>
			    <div class="current-pics-section">
			        <div class="pics-grid">
			            <div class="pic-item" style="width: 200px; height: 150px;">
			                <img th:src="@{/forum/post-picture(postId=${forumPostVO.postId})}" 
			                     id="main-pic-preview" alt="ç›®å‰å°é¢åœ–">
			            </div>
			        </div>
			        
			        <div class="file-input-wrapper" style="margin-top: 15px; padding: 10px;" 
			             onclick="document.getElementById('main-pic-input').click()">
			            <span style="font-weight: 700; color: var(--primary-orange);">
			                <i class="fas fa-image"></i> æ›´æ›å°é¢åœ–
			            </span>
			            <input type="file" id="main-pic-input" th:field="*{upFile}" 
			                   style="display: none;" onchange="previewMainPic(this)">
			            <div class="error-msg" th:if="${#fields.hasErrors('upFile')}" th:errors="*{upFile}" style="display: none;"></div>
			        </div>
			        <div id="main-pic-name" style="margin-top: 5px; font-size: 0.85rem; color: #666;"></div>
			    </div>
			</div>
            <div class="form-group" th:if="${not #lists.isEmpty(picsId)}" id="old-pics-section">
			    <label class="form-label">è²¼æ–‡é™„ä»¶ç…§ç‰‡</label>
			    <div class="current-pics-section">
			        <div class="pics-grid">
			            <div class="pic-item" th:each="picId : ${picsId}">
			                <img th:src="@{/forum/get-pic-id-for-pic(picId=${picId})}" alt="è²¼æ–‡åœ–ç‰‡">
			            </div>
			        </div>
			        <small style="display: block; margin-top: 10px; color: #888;">* è‹¥éœ€ä¿®æ”¹ç…§ç‰‡ï¼Œè«‹åœ¨ä¸‹æ–¹é‡æ–°ä¸Šå‚³ï¼ˆå°‡è¦†è“‹èˆŠç…§ç‰‡ï¼‰</small>
			    </div>
			</div>
			
			<div class="form-group">
			    <label class="form-label">é‡æ–°ä¸Šå‚³ç…§ç‰‡ (å¯é¸)</label>
			    
			    <div id="new-pics-preview" class="pics-grid" style="margin-bottom: 15px;"></div>
			
			    <div class="file-input-wrapper" id="multi-drop-zone" onclick="document.getElementById('file-input').click()">
			        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #aaa; margin-bottom: 10px;"></i>
			        <p style="margin: 0; color: #666; font-weight: 600;">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡è‡³æ­¤è™•</p>
			        <input type="file" id="file-input" name="upFiles" multiple style="display: none;" onchange="updateFileName(this)">
			        <div id="file-list" style="margin-top: 10px; font-size: 0.9rem; color: var(--primary-orange);"></div>
			    </div>
			</div>

            <div class="update-footer">
                <a href="javascript:history.back()" class="btn-cancel">å–æ¶ˆ</a>
                <button type="submit" class="btn-save">å„²å­˜æ›´æ–°</button>
            </div>
            
            <div>
                <input type="hidden" name="forumId" th:value="${forumId}" id="forumId" >
	            <input type="hidden" name="forumName" th:value="${forumName}" id="forumName" >
            </div>
            <div id="errorData" th:if="${errorMsgs}" th:data-msgs="${errorMsgs}" style="display: none;"></div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    	
	 	// é è¦½ä¸»é å°é¢åœ–
	    function previewMainPic(input) {
	        const preview = document.getElementById('main-pic-preview');
	        const fileNameDisplay = document.getElementById('main-pic-name');
	        
	        if (input.files && input.files[0]) {
	            const reader = new FileReader();
	            
	            reader.onload = function(e) {
	                preview.src = e.target.result; // æ›´æ›é è¦½åœ–
	                fileNameDisplay.innerHTML = `æº–å‚™ä¸Šå‚³ï¼š${input.files[0].name}`;
	            }
	            
	            reader.readAsDataURL(input.files[0]);
	        }
	    }
    	
	    function updateFileName(input) {
	        const fileList = document.getElementById('file-list');
	        const oldSection = document.getElementById('old-pics-section');
	        const newPreview = document.getElementById('new-pics-preview');
	        
	        // æ¸…ç©ºä¹‹å‰çš„æ–°é è¦½å…§å®¹
	        newPreview.innerHTML = '';

	        if (input.files && input.files.length > 0) {
	        	fileList.innerHTML = `âœ… å·²é¸æ“‡ ${input.files.length} å¼µæ–°ç…§ç‰‡ <br> 
                    <small style="color: #ff5252;">(æé†’ï¼šæœ€å¤šåƒ…èƒ½ä¸Šå‚³ 6 å¼µç…§ç‰‡å–”ï¼)</small>`;
	            
	            // âœ¨ éš±è—èˆŠåœ–å€å¡Š
	            if (oldSection) {
	                oldSection.style.display = 'none';
	            }

	            // âœ¨ ç”¢ç”Ÿæ–°åœ–é è¦½
	            Array.from(input.files).forEach(file => {
	                const reader = new FileReader();
	                reader.onload = function(e) {
	                    const div = document.createElement('div');
	                    div.className = 'pic-item';
	                    div.innerHTML = `<img src="${e.target.result}" alt="æ–°åœ–ç‰‡é è¦½">`;
	                    newPreview.appendChild(div);
	                };
	                reader.readAsDataURL(file);
	            });
	        } else {
	            // å¦‚æœä½¿ç”¨è€…å–æ¶ˆé¸æ“‡ï¼Œé¡¯ç¤ºå›èˆŠåœ–
	            fileList.innerHTML = '';
	            if (oldSection) {
	                oldSection.style.display = 'block';
	            }
	        }
	    }
	    
	 	// âœ¨ ä¿®æ­£ï¼šæ”¹ç”¨ ID æŠ“å–ç‰¹å®šçš„å¤šåœ–æ‹–æ›³å€åŸŸ
	    const multiDropZone = document.getElementById('multi-drop-zone');
	    const multiFileInput = document.getElementById('file-input');

	    if (multiDropZone) {
	        // 1. é˜²æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º
	        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
	            multiDropZone.addEventListener(eventName, e => {
	                e.preventDefault();
	                e.stopPropagation();
	            }, false);
	        });

	        // 2. æ‹–æ›³é€²å…¥æ•ˆæœ
	        ['dragenter', 'dragover'].forEach(eventName => {
	            multiDropZone.addEventListener(eventName, () => {
	                multiDropZone.classList.add('drag-over');
	            }, false);
	        });

	        // 3. æ‹–æ›³é›¢é–‹/æ”¾ä¸‹æ•ˆæœ
	        ['dragleave', 'drop'].forEach(eventName => {
	            multiDropZone.addEventListener(eventName, () => {
	                multiDropZone.classList.remove('drag-over');
	            }, false);
	        });

	        // 4. âœ¨ æ ¸å¿ƒé‚è¼¯ï¼šè™•ç†æ”¾ä¸‹æª”æ¡ˆ
	        multiDropZone.addEventListener('drop', e => {
	            const dt = e.dataTransfer;
	            const files = dt.files;

	            if (files.length > 0) {
	                // å°‡æª”æ¡ˆå¡å…¥ input
	                multiFileInput.files = files;
	                // æ‰‹å‹•è§¸ç™¼æ¸²æŸ“
	                updateFileName(multiFileInput);
	            }
	        }, false);
	    }
   
     	// è™•ç†åœ–ç‰‡å¤§å°/å¼µæ•¸ç­‰éŒ¯èª¤ (Controller å‚³ä¾†çš„ errorMsgs)
        const errorEl = document.getElementById('errorData');
        if (errorEl) {
            const msg = errorEl.getAttribute('data-msgs');
            Swal.fire({ icon: 'error', title: 'å¤±æ•—', text: msg, confirmButtonColor: '#ff9800' });
        }
    </script>
</body>
</html>