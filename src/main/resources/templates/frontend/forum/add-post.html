<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’°å¯«è²¼æ–‡ | PetGuardian</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-orange: #ff9800; --deep-brown: #5d4037; --bg-light: #fdfcf8; }
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; }
        
        .update-container {
            max-width: 800px; margin: 40px auto; background: #fff;
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden;
        }
        
        .update-header {
            background: linear-gradient(135deg, #fffcf5 0%, #faedcd 100%);
            padding: 30px; border-bottom: 1px solid #eee; text-align: center;
        }
        .update-header h2 { margin: 0; color: var(--deep-brown); font-weight: 900; }
        
        .update-body { padding: 40px; }
        
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; font-weight: 800; color: var(--deep-brown); margin-bottom: 10px; font-size: 1.1rem; }
        
        .form-control {
            width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px;
            font-size: 1rem; transition: 0.3s; box-sizing: border-box; font-family: inherit;
        }
        .form-control:focus { border-color: var(--primary-orange); outline: none; box-shadow: 0 0 0 4px rgba(255, 152, 0, 0.1); }
        
        textarea.form-control { height: 300px; resize: vertical; line-height: 1.6; }

        /* åœ–ç‰‡ç®¡ç†å€æ¨£å¼ (èˆ‡ç·¨è¼¯é çµ±ä¸€) */
        .current-pics-section {
            margin-bottom: 25px; padding: 15px; background: var(--bg-light);
            border-radius: 12px; border: 1px dashed #ddd;
        }
        .pics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .pic-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pic-item img { width: 100%; height: 100%; object-fit: cover; }

        .file-input-wrapper {
            position: relative; padding: 20px; border: 2px dashed #ccc;
            border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s;
        }
        .file-input-wrapper:hover { border-color: var(--primary-orange); background: #fffcf5; }
        
        /* é å°¾æŒ‰éˆ•å€ */
        .update-footer {
            padding: 25px 40px; background: #fcfcfc; border-top: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .btn-save {
            background: var(--primary-orange); color: white; border: none;
            padding: 12px 35px; border-radius: 50px; font-weight: 800;
            font-size: 1.1rem; cursor: pointer; transition: 0.3s;
        }
        .btn-save:hover { background: #f57c00; transform: translateY(-2px); }
        
        .btn-cancel {
		    text-decoration: none;
		    color: var(--deep-brown); /* æ”¹ç”¨æ·±æ£•è‰²ï¼Œæ›´æœ‰æ•´é«”æ„Ÿ */
		    font-weight: 800;
		    padding: 12px 30px;
		    border: 2px solid #eee; /* çµ¦å®ƒä¸€å€‹æ·¡æ·¡çš„é‚Šæ¡† */
		    border-radius: 50px;    /* è·Ÿç¢ºèªæŒ‰éˆ•ä¸€æ¨£çš„è† å›Šé€ å‹ */
		    background: transparent;
		    transition: all 0.3s ease;
		    display: inline-flex;
		    align-items: center;
		    justify-content: center;
		}
		
		.btn-cancel:hover {
		    background-color: #f5f5f5; /* æ‡¸åœæ™‚æ·¡æ·¡çš„ç°è‰² */
		    color: #333;
		    border-color: #ddd;
		    transform: translateY(-2px); /* è¼•å¾®ä¸Šæµ®æ„Ÿ */
		    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
		}
		
		.btn-cancel:active {
		    transform: translateY(0); /* é»æ“Šæ™‚ä¸‹å£“æ„Ÿ */
		}
        
        /* éŒ¯èª¤å€å¡Š */
        .error-box { background-color: #fff5f5; border: 2px solid #ff0000; padding: 15px; margin-bottom: 25px; border-radius: 8px; }
        .error-box p { color: #cf1322; margin: 0 0 10px 0; font-weight: 900; }
        .error-list { margin: 0; padding-left: 20px; color: #ff0000; font-weight: 600; }

        .file-input-wrapper.drag-over {
            background-color: #fffcf5;
            border: 2px dashed var(--primary-orange) !important;
        }
    </style>
</head>

<body>
    <div class="update-container">
        <div class="update-header">
            <h2>ğŸ¾ ç™¼å¸ƒæ–°è²¼æ–‡</h2>
        </div>

        <form class="update-body" th:action="@{insert-post}" method="post" th:object="${forumPostVO}" enctype="multipart/form-data" id="postForm">
            
            <div th:if="${#fields.hasAnyErrors()}" class="error-box">
                <p><i class="fas fa-exclamation-circle"></i> éŒ¯èª¤è¨Šæ¯ï¼š</p>
                <ul class="error-list">
                    <li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
                </ul>
            </div>

            <div class="form-group">
                <label class="form-label">è²¼æ–‡æ¨™é¡Œ</label>
                <input type="text" th:field="*{postTitle}" class="form-control" placeholder="è«‹è¼¸å…¥è²¼æ–‡æ¨™é¡Œ..." />
            </div>

            <div class="form-group">
                <label class="form-label">æ–‡ç« å…§å®¹</label>
                <textarea th:field="*{postContent}" class="form-control" placeholder="åˆ†äº«æ¯›å°å­©çš„æ—¥å¸¸å¿ƒå¾—..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">ä¸»é å°é¢åœ–ç‰‡</label>
                <div class="current-pics-section">
                    <div id="mainPreview" class="pics-grid">
                        </div>
                    
                    <div class="file-input-wrapper" style="margin-top: 15px; padding: 15px;" 
                         onclick="document.getElementById('mainPicInput').click()">
                        <span style="font-weight: 700; color: var(--primary-orange);">
                            <i class="fas fa-camera"></i> é¸æ“‡å°é¢ç…§ç‰‡
                        </span>
                        <input type="file" th:field="*{upFile}" id="mainPicInput" accept="image/*" style="display: none;" onchange="previewMainPic(this)"/>
                    </div>
                    <div id="main-pic-name" style="margin-top: 5px; font-size: 0.85rem; color: #666; text-align: center;"></div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">è²¼æ–‡é™„ä»¶ç…§ç‰‡ (æœ€å¤š 6 å¼µ)</label>
                <div id="multiPreview" class="pics-grid" style="margin-bottom: 15px;"></div>

                <div class="file-input-wrapper" id="multi-drop-zone" onclick="document.getElementById('multiPicInput').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #aaa; margin-bottom: 10px;"></i>
                    <p style="margin: 0; color: #666; font-weight: 600;">é»æ“Šæˆ–æ‹–æ›³å¤šå¼µç…§ç‰‡è‡³æ­¤</p>
                    <input type="file" name="upFiles" id="multiPicInput" multiple accept="image/*" style="display: none;" onchange="updateFileName(this)"/>
                    <div id="file-list" style="margin-top: 10px; font-size: 0.9rem; color: var(--primary-orange);"></div>
                </div>
            </div>

            <div class="update-footer">
                <button type="button" class="btn-cancel" onclick="cancelPost()">å–æ¶ˆé›¢é–‹</button>
                <button type="submit" class="btn-save">ç¢ºèªç™¼å¸ƒ <i class="fas fa-paper-plane" style="margin-left: 5px;"></i></button>
            </div>
            
            <input type="hidden" th:field="*{forum.forumId}" id="forumId" >
            <input type="hidden" name="forumName" th:value="${forumName}" id="forumName" >
            
            <div id="errorData" th:if="${errorMsgs}" th:data-msgs="${errorMsgs}" style="display: none;"></div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        const forumId = document.getElementById('forumId').value;
        const forumName = document.getElementById('forumName').value;
        
        // 1. å–æ¶ˆæŒ‰éˆ•é‚è¼¯
        function cancelPost() {
            Swal.fire({
                title: 'ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ',
                text: "å°šæœªç™¼å¸ƒçš„å…§å®¹å°‡æœƒéºå¤±å–”ï¼",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff9800',
                cancelButtonColor: '#aaa',
                confirmButtonText: 'ç¢ºå®šé›¢é–‹',
                cancelButtonText: 'ç¹¼çºŒæ’°å¯«'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/forumpost/get-forum-id-for-posts?forumId=${forumId}&forumName=${encodeURIComponent(forumName)}`;
                }
            });
        }

        // 2. é è¦½ä¸»é å°é¢åœ–
        function previewMainPic(input) {
            const previewContainer = document.getElementById('mainPreview');
            const fileNameDisplay = document.getElementById('main-pic-name');
            previewContainer.innerHTML = '';
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'pic-item';
                    div.style.width = '200px'; div.style.height = '150px'; div.style.margin = '0 auto';
                    div.innerHTML = `<img src="${e.target.result}" alt="å°é¢é è¦½">`;
                    previewContainer.appendChild(div);
                    fileNameDisplay.innerHTML = `å·²é¸å–ï¼š${input.files[0].name}`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 3. è™•ç†å¤šåœ–é è¦½èˆ‡æé†’
        function updateFileName(input) {
            const fileList = document.getElementById('file-list');
            const previewContainer = document.getElementById('multiPreview');
            previewContainer.innerHTML = '';

            if (input.files && input.files.length > 0) {
                fileList.innerHTML = `âœ… å·²é¸æ“‡ ${input.files.length} å¼µç…§ç‰‡ <br> 
                    <small style="color: #ff5252;">(æé†’ï¼šæœ€å¤šåƒ…èƒ½ä¸Šå‚³ 6 å¼µç…§ç‰‡å–”ï¼)</small>`;
                
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'pic-item';
                        div.innerHTML = `<img src="${e.target.result}" alt="é è¦½">`;
                        previewContainer.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                fileList.innerHTML = '';
            }
        }

        // 4. æ‹–æ›³åŠŸèƒ½å¯¦ä½œ
        const multiDropZone = document.getElementById('multi-drop-zone');
        const multiFileInput = document.getElementById('multiPicInput');

        if (multiDropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                multiDropZone.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                multiDropZone.addEventListener(eventName, () => multiDropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                multiDropZone.addEventListener(eventName, () => multiDropZone.classList.remove('drag-over'), false);
            });

            multiDropZone.addEventListener('drop', e => {
                const dt = e.dataTransfer;
                multiFileInput.files = dt.files;
                updateFileName(multiFileInput);
            }, false);
        }

        // 5. éŒ¯èª¤è™•ç†
        const errorEl = document.getElementById('errorData');
        if (errorEl) {
            const msg = errorEl.getAttribute('data-msgs');
            Swal.fire({ icon: 'error', title: 'å¤±æ•—', text: msg, confirmButtonColor: '#ff9800' });
        }
    </script>
</body>
</html>