<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>撰寫貼文 | PetGuardian</title>
    <link rel="stylesheet" th:href="@{/css/frontend/style.css}">
    <link rel="stylesheet" th:href="@{/css/frontend/components.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-orange: #ff9800;
            --deep-brown: #5d4037;
            --light-bg: #fdfbf7;
        }

        body { background-color: #f8f9fa; }
        .container { max-width: 850px; margin: 40px auto; padding: 0 20px; }
        .form-section { background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        /* 錯誤區塊：亮紅色強化 */
        .error-box { background-color: #fff5f5; border: 2px solid #ff0000; padding: 15px; margin-bottom: 25px; border-radius: 8px; }
        .error-box p { color: #cf1322; margin: 0 0 10px 0; font-weight: 900; }
        .error-list { margin: 0; padding-left: 20px; color: #ff0000; font-weight: 600; }

        .input-group { margin-bottom: 25px; }
        .input-label { display: block; font-weight: 800; color: var(--deep-brown); margin-bottom: 10px; font-size: 1.05rem; }
        .input-title, .input-content { width: 100%; border-radius: 12px; border: 2px solid #eee; padding: 18px; box-sizing: border-box; transition: 0.3s; }
        .input-title:focus, .input-content:focus { outline: none; border-color: var(--primary-orange); background: var(--light-bg); }
        .input-content { min-height: 250px; resize: vertical; }
        
        /* 圖片預覽區樣式 */
        .preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; min-height: 50px; }
        .preview-wrapper { position: relative; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; animation: fadeIn 0.3s ease; }
        .preview-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* 圖片上傳區塊 */
        .upload-container { display: flex; gap: 20px; margin-top: 10px; }
        .upload-card { flex: 1; padding: 25px 15px; border: 2px dashed #ddd; border-radius: 15px; background: #fafafa; text-align: center; transition: 0.3s; }
        .upload-card:hover { border-color: var(--primary-orange); background: var(--light-bg); }
        .upload-card i { font-size: 1.5rem; color: #aaa; margin-bottom: 10px; display: block; }
        
        .submit-area { display: flex; justify-content: flex-end; gap: 15px; margin-top: 40px; padding-top: 25px; border-top: 1px solid #eee; }
        .btn-cancel { background: #eee; color: #666; padding: 12px 30px; border-radius: 12px; font-weight: 800; border:none; cursor: pointer; }
        .btn-submit { background: var(--primary-orange); color: white; padding: 12px 40px; border-radius: 12px; font-weight: 800; border:none; cursor: pointer; }
    </style>
</head>

<body>
    <div class="container">
	    <div class="form-section">
	        <h2 style="color: var(--deep-brown); font-weight: 900; margin-bottom: 30px; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-edit" style="color: var(--primary-orange);"></i> 發布新貼文
            </h2>
	
	        <form th:action="@{insert-post}" method="post" th:object="${forumPostVO}" enctype="multipart/form-data" id="postForm">
	            
                <div th:if="${#fields.hasAnyErrors()}" class="error-box">
	                <p><i class="fas fa-exclamation-circle"></i> 錯誤訊息：</p>
	                <ul class="error-list">
	                    <li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
	                </ul>
	            </div>
	
	            <div class="input-group">
	                <label class="input-label">貼文標題</label>
	                <input type="text" th:field="*{postTitle}" class="input-title" placeholder="請給貼文一個吸引人的標題吧！" />
	            </div>
	
	            <div class="input-group">
	                <label class="input-label">文章內容</label>
	                <textarea th:field="*{postContent}" class="input-content" placeholder="分享毛小孩的日常心得（至少 30 字）..."></textarea>
	            </div>
	
	            <div class="upload-container">
	                <div class="upload-card">
	                    <i class="fas fa-camera"></i>
                        <span style="font-weight: 800; color: #555;">主頁封面圖片</span>
                        <input type="file" th:field="*{upFile}" id="mainPicInput" accept="image/*" />
                        <div id="mainPreview" class="preview-container"></div>
	                </div>
	
	                <div class="upload-card">
	                    <i class="fas fa-images"></i>
                        <span style="font-weight: 800; color: #555;">貼文附件照片</span>
                        <p style="font-size: 0.75rem; color: #999; margin: 5px 0;">最多 6 張照片</p>
	                    <input type="file" name="upFiles" id="multiPicInput" multiple accept="image/*" />
                        <div id="multiPreview" class="preview-container"></div>
	                </div>
	            </div>
	
	            <div class="submit-area">
                    <button type="button" class="btn-cancel" onclick="cancelPost()">取消離開</button>
                    <button type="submit" class="btn-submit">確認發佈 <i class="fas fa-paper-plane" style="margin-left: 5px;"></i></button>
	            </div>
	            
	            <div>
	                <input type="hidden" th:field="*{forum.forumId}" id="forumId" >
	            	<input type="hidden" name="forumName" th:value="${forumName}" id="forumName" >
	            </div>
	        </form>
	        <div id="errorData" th:if="${errorMsgs}" th:data-msgs="${errorMsgs}" style="display: none;"></div>
	    </div>
	</div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/js/frontend/main.js}"></script>

    <script th:inline="javascript">
        // 取得參數
        const forumId = document.getElementById('forumId').value;
		const forumName = document.getElementById('forumName').value;
        
        // 1. 取消按鈕重導向
        function cancelPost() {
            Swal.fire({
                title: '確定要離開嗎？',
                text: "尚未發布的內容將會遺失喔！",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff9800',
                cancelButtonColor: '#aaa',
                confirmButtonText: '確定離開',
                cancelButtonText: '繼續撰寫'
            }).then((result) => {
                if (result.isConfirmed) {
                	window.location.href = `/forumpost/get-forum-id-for-posts?forumId=${forumId}&forumName=${encodeURIComponent(forumName)}`;
                }
            });
        }

        // 2. 圖片預覽
        function handlePreview(input, previewId) {
            const previewContainer = document.getElementById(previewId);
            input.addEventListener('change', function() {
                previewContainer.innerHTML = ''; 
                Array.from(this.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'preview-wrapper';
                        wrapper.innerHTML = `<img src="${e.target.result}">`;
                        previewContainer.appendChild(wrapper);
                    }
                    reader.readAsDataURL(file);
                });
            });
        }
        handlePreview(document.getElementById('mainPicInput'), 'mainPreview');
        handlePreview(document.getElementById('multiPicInput'), 'multiPreview');

        // 3. 處理圖片大小/張數等錯誤 (Controller 傳來的 errorMsgs)
        const errorEl = document.getElementById('errorData');
        if (errorEl) {
            const msg = errorEl.getAttribute('data-msgs');
            Swal.fire({ icon: 'error', title: '上傳失敗', text: msg, confirmButtonColor: '#ff9800' });
        }
    </script>
</body>
</html>