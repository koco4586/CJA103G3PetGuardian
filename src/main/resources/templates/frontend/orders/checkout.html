<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>結帳 | PetGuardian</title>
    <link rel="stylesheet" href="/css/frontend/style.css">
    <link rel="stylesheet" href="/css/frontend/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/frontend/orders/checkout.css">

</head>

<body>

    <header id="main-header" class="header"></header>

    <!-- Flash Messages -->
    <div th:if="${message}" class="flash-message success">
        <i class="fas fa-check-circle"></i> <span th:text="${message}">成功訊息</span>
    </div>
    <div th:if="${error}" class="flash-message error">
        <i class="fas fa-exclamation-circle"></i> <span th:text="${error}">錯誤訊息</span>
    </div>

    <div class="container" style="margin-top: 2rem; margin-bottom: 4rem;">

        <!-- 購物車空白提示 -->
        <div th:if="${checkout == null || #lists.isEmpty(checkout.cartItems)}" class="empty-cart"
            style="text-align: center; padding: 4rem 2rem;">
            <i class="fas fa-shopping-cart" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem;"></i>
            <h2>購物車是空的</h2>
            <p style="color: #999; margin-bottom: 2rem;">請先選購商品再進行結帳</p>
            <a th:href="@{/store}" class="btn btn-primary">
                <i class="fas fa-store"></i> 前往商城
            </a>
        </div>

        <!-- 有商品時顯示結帳流程 -->
        <div th:if="${checkout != null && !#lists.isEmpty(checkout.cartItems)}">

            <!-- 進度條 -->
            <div class="checkout-progress">
                <div class="progress-step active completed">
                    <div class="step-circle">✓</div>
                    <span class="step-label">選擇商品</span>
                </div>
                <div class="progress-line active"></div>
                <div class="progress-step active">
                    <div class="step-circle">2</div>
                    <span class="step-label">填寫資料</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <div class="step-circle">3</div>
                    <span class="step-label">完成訂單</span>
                </div>
            </div>

            <!-- 主要內容區域 -->
            <div class="checkout-container">

                <!-- 左側：表單區域 -->
                <div class="checkout-form-section">

                    <!-- 賣家信譽區塊 -->
                    <div class="seller-info-card">
                        <!-- 商品預覽 -->
                        <div class="product-preview" th:if="${!#lists.isEmpty(checkout.cartItems)}">
                            <img th:src="${checkout.cartItems[0].imageBase64}" th:alt="${checkout.cartItems[0].proName}"
                                class="product-preview-img">
                            <div class="product-preview-info">
                                <div class="product-preview-name" th:text="${checkout.cartItems[0].proName}">商品名稱</div>
                                <div class="product-preview-price"
                                    th:text="'$' + ${#numbers.formatInteger(checkout.cartItems[0].proPrice, 1, 'COMMA')}">
                                    $0</div>
                                <div th:if="${#lists.size(checkout.cartItems) > 1}"
                                    style="font-size: 0.85rem; color: #999; margin-top: 0.25rem;">
                                    <i class="fas fa-plus"></i> 另有 <span
                                        th:text="${#lists.size(checkout.cartItems) - 1}">0</span> 件商品
                                </div>
                            </div>
                        </div>

                        <div class="seller-header">
                            <div class="seller-avatar"
                                th:text="${checkout.sellerInfo.sellerName != null ? checkout.sellerInfo.sellerName.substring(0, 1) : '?'}">
                                賣</div>
                            <div style="flex: 1;">
                                <div class="seller-name" th:text="${checkout.sellerInfo.sellerName}">賣家名稱</div>
                                <div class="seller-rating">
                                    <span class="rating-stars">
                                        <i th:each="i : ${#numbers.sequence(1, 5)}"
                                            th:class="${i <= checkout.sellerInfo.averageRating} ? 'fas fa-star' : 'far fa-star'"></i>
                                    </span>
                                    <span class="rating-text">
                                        <span
                                            th:text="${#numbers.formatDecimal(checkout.sellerInfo.averageRating, 1, 1)}">0.0</span>
                                        分 / <span th:text="${checkout.sellerInfo.reviewCount}">0</span> 則評價
                                    </span>
                                </div>
                            </div>
                            <!-- 聯絡賣家按鈕 -->
                            <form th:action="@{/chat/connect/store}" method="post" style="display:inline;">
                                <input type="hidden" name="targetUserId" th:value="${sellerId}" />
                                <input type="hidden" name="chatroomType" value="1" />
                                <button type="submit" class="btn btn-outline" style="white-space: nowrap;">
                                    <i class="fas fa-comment-dots"></i> 聯絡賣家
                                </button>
                            </form>
                        </div>

                        <!-- 評論展開區 -->
                        <details class="reviews-details">
                            <summary class="review-toggle">
                                <i class="fas fa-comments"></i>
                                查看 <span th:text="${checkout.sellerInfo.reviewCount}">0</span> 則買家評價
                            </summary>
                            <div class="reviews-section">
                                <!-- 無評價 -->
                                <div th:if="${#lists.isEmpty(checkout.sellerInfo.reviews)}" class="no-reviews">
                                    <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                    <p>目前還沒有評價</p>
                                </div>

                                <!-- 評價列表 -->
                                <div th:each="review : ${checkout.sellerInfo.reviews}" class="review-item">
                                    <div class="review-header">
                                        <span class="review-buyer">
                                            <i class="fas fa-user-circle"></i>
                                            <span th:text="${review.buyerName}">買家</span>
                                        </span>
                                        <span class="review-time" th:text="${review.reviewTime}">2024-01-01</span>
                                    </div>
                                    <div class="review-stars">
                                        <i th:each="i : ${#numbers.sequence(1, 5)}"
                                            th:class="${i <= review.rating} ? 'fas fa-star' : 'far fa-star'"></i>
                                    </div>
                                    <p class="review-content"
                                        th:text="${review.reviewContent != null && !review.reviewContent.isEmpty() ? review.reviewContent : '買家未留下評語'}">
                                        評論內容</p>

                                    <!-- 檢舉按鈕 -->
                                    <div class="btn-report-wrapper">
                                        <button type="button" class="btn-report" th:data-review-id="${review.reviewId}"
                                            onclick="toggleReportForm(this)">
                                            <i class="fas fa-flag"></i> 檢舉
                                        </button>
                                    </div>

                                    <!-- 檢舉表單（隱藏） -->
                                    <form th:action="@{/reviews/report}" method="post" class="report-form"
                                        th:id="'report-form-' + ${review.reviewId}">
                                        <input type="hidden" name="reviewId" th:value="${review.reviewId}">
                                        <input type="hidden" name="redirectUrl" value="/store/checkout">

                                        <!-- 檢舉原因選項 -->
                                        <div class="report-reasons">
                                            <label class="report-reason-label">請選擇檢舉原因：</label>
                                            <div class="report-reason-options">
                                                <label class="report-option">
                                                    <input type="radio" name="reportType" value="不實評價" th:name="'reportType-' + ${review.reviewId}" onchange="updateReportReason(this)">
                                                    <span><i class="fas fa-comment-slash"></i> 不實評價</span>
                                                </label>
                                                <label class="report-option">
                                                    <input type="radio" name="reportType" value="惡意攻擊/人身攻擊" th:name="'reportType-' + ${review.reviewId}" onchange="updateReportReason(this)">
                                                    <span><i class="fas fa-user-slash"></i> 惡意攻擊</span>
                                                </label>
                                                <label class="report-option">
                                                    <input type="radio" name="reportType" value="垃圾訊息/廣告" th:name="'reportType-' + ${review.reviewId}" onchange="updateReportReason(this)">
                                                    <span><i class="fas fa-ad"></i> 垃圾訊息</span>
                                                </label>
                                                <label class="report-option">
                                                    <input type="radio" name="reportType" value="其他" th:name="'reportType-' + ${review.reviewId}" onchange="updateReportReason(this)">
                                                    <span><i class="fas fa-ellipsis-h"></i> 其他</span>
                                                </label>
                                            </div>
                                        </div>

                                        <textarea name="reportReason" placeholder="補充說明（選填）..." rows="2"
                                            maxlength="200" class="report-textarea"></textarea>
                                        <input type="hidden" name="finalReportReason" class="final-report-reason">
                                        <div class="d-flex gap-sm justify-end">
                                            <button type="button" class="btn btn-outline btn-sm"
                                                onclick="toggleReportForm(this)">取消</button>
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="fas fa-paper-plane"></i> 提交檢舉
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </details>
                    </div>


                    <!-- 同店加購區 -->
                    <div th:if="${checkout.upsellProducts != null && !#lists.isEmpty(checkout.upsellProducts)}"
                        class="card upsell-section">
                        <h3 class="mb-1">
                            <i class="fas fa-plus-circle" style="color: var(--success); margin-right: 0.5rem;"></i>
                            同店加購
                        </h3>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">這位賣家還有其他商品，一起購買更划算！</p>

                        <div class="upsell-grid">
                            <div th:each="product : ${checkout.upsellProducts}" class="upsell-card">
                                <!-- Base64 圖片 -->
                                <img th:src="${product.imageBase64}" th:alt="${product.proName}">
                                <div class="title" th:text="${product.proName}">商品名稱</div>
                                <div class="price" th:text="'$' + ${product.proPrice}">$0</div>
                                <form th:action="@{/cart/upsell}" method="post">
                                    <input type="hidden" name="proId" th:value="${product.proId}">
                                    <input type="hidden" name="quantity" value="1">
                                    <button type="submit" class="btn btn-primary btn-add"
                                        th:disabled="${product.stockQuantity == null || product.stockQuantity <= 0}">
                                        <i class="fas fa-plus"></i>
                                        <span
                                            th:text="${product.stockQuantity != null && product.stockQuantity > 0 ? '加購' : '售完'}">加購</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 結帳表單 -->
                    <form th:action="@{/orders/submit}" method="post" id="checkout-form">

                        <!-- 隱藏欄位：賣家 ID -->
                        <input type="hidden" name="sellerId" th:value="${sellerId}">

                        <!-- 收件人資訊 -->
                        <div class="card">
                            <h3 class="mb-2">
                                <i class="fas fa-user-circle"
                                    style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                                收件人資訊
                            </h3>

                            <div class="form-group">
                                <label class="form-label required">收件人姓名</label>
                                <input type="text" class="form-control" id="receiverName" name="receiverName"
                                    placeholder="請輸入收件人姓名" required maxlength="20" th:value="${param.receiverName}">
                                <span class="error-message" id="error-receiverName"></span>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">聯絡電話</label>
                                <input type="tel" class="form-control" id="receiverPhone" name="receiverPhone"
                                    placeholder="例如：0912345678" required maxlength="20" pattern="[0-9]{10}"
                                    th:value="${param.receiverPhone}">
                                <span class="error-message" id="error-receiverPhone"></span>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">收件地址</label>
                                <input type="text" class="form-control" id="receiverAddress" name="receiverAddress"
                                    placeholder="請輸入完整地址（含縣市、區、街道）" required maxlength="100"
                                    th:value="${param.receiverAddress}">
                                <span class="error-message" id="error-receiverAddress"></span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">備註說明（選填）</label>
                                <textarea class="form-control" id="specialInstructions" name="specialInstructions"
                                    rows="3" placeholder="例如：請勿按門鈴、放管理室..." maxlength="200"
                                    th:text="${param.specialInstructions}"></textarea>
                                <small style="color: #999; font-size: 0.85rem;">最多 200 字</small>
                            </div>
                        </div>

                    </form>

                </div>

                <!-- 右側：訂單摘要 (桌面版) -->
                <div class="order-summary-desktop">
                    <div class="card sticky-summary">
                        <h3 class="mb-2">
                            <i class="fas fa-shopping-bag"
                                style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                            訂單摘要
                            <span style="font-size: 0.9rem; font-weight: normal; color: #999;"
                                th:text="'（' + ${#lists.size(checkout.cartItems)} + ' 件）'">（0 件）</span>
                        </h3>

                        <!-- 商品列表 -->
                        <div id="order-items-list">
                            <div th:each="item : ${checkout.cartItems}" class="cart-item-card">
                                <!-- Base64 圖片 -->
                                <img th:src="${item.imageBase64}" th:alt="${item.proName}" class="cart-item-img">
                                <div class="cart-item-info">
                                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.5rem; line-height: 1.4;"
                                        th:text="${item.proName}">商品名稱</div>
                                    <div class="d-flex justify-between align-center">
                                        <!-- 數量調整 -->
                                        <form th:action="@{/cart/update}" method="post" class="quantity-control">
                                            <input type="hidden" name="proId" th:value="${item.proId}">
                                            <select name="quantity" onchange="this.form.submit()"
                                                th:with="maxQty=${item.stockQuantity != null and item.stockQuantity > 10 ? 10 : (item.stockQuantity != null ? item.stockQuantity : 10)}">
                                                <option th:each="i : ${#numbers.sequence(1, maxQty)}" th:value="${i}"
                                                    th:text="${i}" th:selected="${i == item.quantity}">1
                                                </option>
                                            </select>
                                        </form>
                                        <div class="d-flex align-center gap-sm">
                                            <span
                                                style="font-weight: 700; color: var(--primary-color); font-size: 1.05rem;"
                                                th:text="'$' + ${#numbers.formatInteger(item.subtotal, 1, 'COMMA')}">$0</span>
                                            <!-- 移除按鈕 -->
                                            <form th:action="@{/cart/remove}" method="post" style="display: inline;"
                                                th:id="'remove-form-' + ${item.proId}">
                                                <input type="hidden" name="proId" th:value="${item.proId}">
                                                <button type="button" class="btn-remove" title="移除"
                                                    th:data-pro-id="${item.proId}" th:data-pro-name="${item.proName}"
                                                    onclick="showRemoveConfirm(this.dataset.proId, this.dataset.proName)">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 總金額 -->
                        <div class="order-total-section">
                            <div class="d-flex justify-between align-center">
                                <span style="font-size: 1.1rem; font-weight: 600;">總金額</span>
                                <span style="font-size: 1.4rem; font-weight: 800; color: var(--primary-color);"
                                    th:text="'$' + ${#numbers.formatInteger(checkout.orderTotal, 1, 'COMMA')}">$0</span>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <!-- 付款方式 -->
                        <h3 class="mb-2">
                            <i class="fas fa-wallet" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                            付款方式
                        </h3>

                        <div class="payment-info"
                            style="background: var(--secondary-color); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <i class="fas fa-wallet" style="font-size: 2rem; color: var(--primary-color);"></i>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">錢包餘額付款</div>
                                    <small style="color: #666;">使用您的平台錢包餘額進行付款</small>
                                </div>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.75rem; border-top: 1px dashed #ddd;">
                                <span style="color: #666;">目前餘額</span>
                                <span th:class="${walletBalance < checkout.orderTotal} ? 'text-danger' : ''"
                                    style="font-size: 1.25rem; font-weight: 700;"
                                    th:style="${walletBalance < checkout.orderTotal} ? 'color: #e03131;' : 'color: var(--primary-color);'"
                                    th:text="'$' + ${#numbers.formatInteger(walletBalance, 1, 'COMMA')}">$0</span>
                            </div>
                            <!-- 餘額不足提示 -->
                            <div th:if="${walletBalance < checkout.orderTotal}"
                                style="margin-top: 0.75rem; padding: 0.75rem; background: #fff5f5; border-radius: 8px; color: #e03131; font-size: 0.9rem;">
                                <i class="fas fa-exclamation-triangle"></i> 餘額不足！
                            </div>
                        </div>

                        <!-- 按鈕區 -->
                        <form th:action="@{/orders/submit}" method="post" id="checkout-form-submit">
                            <!-- 隱藏欄位：賣家 ID 和付款方式 -->
                            <input type="hidden" name="sellerId" th:value="${sellerId}">
                            <input type="hidden" name="paymentMethod" value="0">
                            <!-- 需要 JavaScript 複製表單欄位 -->
                            <input type="hidden" name="receiverName" id="hiddenReceiverName">
                            <input type="hidden" name="receiverPhone" id="hiddenReceiverPhone">
                            <input type="hidden" name="receiverAddress" id="hiddenReceiverAddress">
                            <input type="hidden" name="specialInstructions" id="hiddenSpecialInstructions">

                            <div class="d-flex gap-md">
                                <a th:href="@{/store}" class="btn btn-outline" style="flex: 1;">
                                    <i class="fas fa-arrow-left"></i> 返回
                                </a>
                                <button type="submit" class="btn btn-primary" id="submit-order-btn" style="flex: 2;"
                                    th:disabled="${walletBalance < checkout.orderTotal}">
                                    <i class="fas fa-lock"></i> 確認並付款
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer id="main-footer" style="background-color: #f9f9f9;"></footer>

    <!-- 自訂確認對話框 -->
    <div id="confirm-modal" class="confirm-modal-overlay">
        <div class="confirm-modal">
            <div class="confirm-modal-icon">
                <i class="fas fa-trash-alt"></i>
            </div>
            <h3 class="confirm-modal-title">移除商品</h3>
            <p class="confirm-modal-message">確定要將「<span id="confirm-product-name"></span>」從購物車中移除嗎？</p>
            <div class="confirm-modal-buttons">
                <button type="button" class="btn-modal-cancel" onclick="hideRemoveConfirm()">
                    取消
                </button>
                <button type="button" class="btn-modal-confirm" id="confirm-remove-btn">
                    <i class="fas fa-check"></i> 確定移除
                </button>
            </div>
        </div>
    </div>

    <style>
        /* 確認對話框樣式 */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            transition: background 0.2s ease, visibility 0.2s ease;
        }

        .confirm-modal-overlay.show {
            background: rgba(0, 0, 0, 0.5);
            visibility: visible;
        }

        .confirm-modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 360px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .confirm-modal-overlay.show .confirm-modal {
            opacity: 1;
            transform: scale(1);
        }

        .confirm-modal-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.25rem;
        }

        .confirm-modal-icon i {
            font-size: 1.5rem;
            color: #dc2626;
        }

        .confirm-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.75rem;
        }

        .confirm-modal-message {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .confirm-modal-message span {
            font-weight: 600;
            color: #333;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .btn-modal-cancel,
        .btn-modal-confirm {
            flex: 1;
            padding: 0.85rem 1rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-modal-cancel {
            background: #f3f4f6;
            color: #666;
        }

        .btn-modal-cancel:hover {
            background: #e5e7eb;
        }

        .btn-modal-confirm {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .btn-modal-confirm:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
    </style>

    <script src="/js/frontend/main.js"></script>

    <!-- JavaScript：表單驗證與訊息處理 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-hide flash messages
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(msg => {
                setTimeout(() => {
                    msg.style.opacity = '0';
                    setTimeout(() => msg.remove(), 300);
                }, 3000);
            });

            const inputForm = document.getElementById('checkout-form');
            const submitForm = document.getElementById('checkout-form-submit');
            if (!inputForm || !submitForm) return;

            // 同步表單欄位到右側提交表單
            function syncFormFields() {
                document.getElementById('hiddenReceiverName').value = document.getElementById('receiverName').value;
                document.getElementById('hiddenReceiverPhone').value = document.getElementById('receiverPhone').value;
                document.getElementById('hiddenReceiverAddress').value = document.getElementById('receiverAddress').value;
                document.getElementById('hiddenSpecialInstructions').value = document.getElementById('specialInstructions').value;
            }

            // 右側表單提交驗證
            submitForm.addEventListener('submit', function (e) {
                let isValid = true;

                // 驗證姓名
                const name = document.getElementById('receiverName');
                if (name && name.value.trim().length < 2) {
                    showError('receiverName', '姓名至少需要 2 個字');
                    isValid = false;
                } else {
                    clearError('receiverName');
                }

                // 驗證電話
                const phone = document.getElementById('receiverPhone');
                const phonePattern = /^[0-9]{10}$/;
                if (phone && !phonePattern.test(phone.value.trim())) {
                    showError('receiverPhone', '請輸入有效的 10 碼電話號碼');
                    isValid = false;
                } else {
                    clearError('receiverPhone');
                }

                // 驗證地址
                const address = document.getElementById('receiverAddress');
                if (address && address.value.trim().length < 10) {
                    showError('receiverAddress', '請輸入完整地址（至少 10 個字）');
                    isValid = false;
                } else {
                    clearError('receiverAddress');
                }

                if (!isValid) {
                    e.preventDefault();
                    // 滾動到第一個錯誤欄位
                    const firstError = document.querySelector('.form-control.error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }
                } else {
                    // 同步表單欄位
                    syncFormFields();
                    // 顯示載入狀態
                    const btn = document.getElementById('submit-order-btn');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
                    }
                }
            });

            // 即時驗證
            const inputs = inputForm.querySelectorAll('input[required]');
            inputs.forEach(input => {
                input.addEventListener('blur', () => validateField(input));
                input.addEventListener('input', () => {
                    if (input.classList.contains('error')) {
                        validateField(input);
                    }
                });
            });
        });

        function validateField(input) {
            const name = input.name;
            const value = input.value.trim();

            switch (name) {
                case 'receiverName':
                    if (value.length < 2) {
                        showError(name, '姓名至少需要 2 個字');
                    } else {
                        clearError(name);
                    }
                    break;
                case 'receiverPhone':
                    if (!/^[0-9]{10}$/.test(value)) {
                        showError(name, '請輸入有效的 10 碼電話號碼');
                    } else {
                        clearError(name);
                    }
                    break;
                case 'receiverAddress':
                    if (value.length < 10) {
                        showError(name, '請輸入完整地址（至少 10 個字）');
                    } else {
                        clearError(name);
                    }
                    break;
            }
        }

        function showError(fieldName, message) {
            const input = document.getElementById(fieldName);
            const errorSpan = document.getElementById('error-' + fieldName);
            if (input) input.classList.add('error');
            if (errorSpan) errorSpan.textContent = message;
        }

        function clearError(fieldName) {
            const input = document.getElementById(fieldName);
            const errorSpan = document.getElementById('error-' + fieldName);
            if (input) input.classList.remove('error');
            if (errorSpan) errorSpan.textContent = '';
        }

        // 檢舉表單切換
        function toggleReportForm(btn) {
            const reviewId = btn.dataset.reviewId || btn.closest('.report-form').querySelector('input[name="reviewId"]').value;
            const form = document.getElementById('report-form-' + reviewId);
            if (form) {
                form.classList.toggle('show');
                // 重置表單
                if (!form.classList.contains('show')) {
                    form.reset();
                }
            }
        }

        // 更新檢舉原因
        function updateReportReason(radio) {
            const form = radio.closest('form');
            const textarea = form.querySelector('.report-textarea');

            // 如果選擇「其他」，讓使用者自行填寫
            if (radio.value === '其他') {
                textarea.placeholder = '請說明檢舉原因...';
                textarea.required = true;
            } else {
                textarea.placeholder = '補充說明（選填）...';
                textarea.required = false;
            }
        }

        // 檢舉表單提交處理
        document.querySelectorAll('.report-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const selectedRadio = form.querySelector('input[type="radio"]:checked');
                const textarea = form.querySelector('.report-textarea');

                if (!selectedRadio) {
                    e.preventDefault();
                    alert('請選擇檢舉原因');
                    return;
                }

                // 組合最終檢舉原因
                let finalReason = selectedRadio.value;
                if (textarea.value.trim()) {
                    finalReason += '：' + textarea.value.trim();
                }

                // 設定到 reportReason 欄位
                textarea.value = finalReason;
            });
        });

        // 移除商品確認對話框
        let currentRemoveProId = null;

        function showRemoveConfirm(proId, productName) {
            currentRemoveProId = proId;
            document.getElementById('confirm-product-name').textContent = productName;
            document.getElementById('confirm-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideRemoveConfirm() {
            document.getElementById('confirm-modal').classList.remove('show');
            document.body.style.overflow = '';
            currentRemoveProId = null;
        }

        // 點擊確認移除按鈕
        document.getElementById('confirm-remove-btn').addEventListener('click', function () {
            if (currentRemoveProId) {
                document.getElementById('remove-form-' + currentRemoveProId).submit();
            }
        });

        // 點擊背景關閉對話框
        document.getElementById('confirm-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                hideRemoveConfirm();
            }
        });

        // ESC 鍵關閉對話框
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && document.getElementById('confirm-modal').classList.contains('show')) {
                hideRemoveConfirm();
            }
        });
    </script>

</body>

</html>