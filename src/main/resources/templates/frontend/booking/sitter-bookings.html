<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>é ç´„ç®¡ç† | PetGuardian</title>
	<!-- å¼•å…¥å…±ç”¨ CSS -->
	<link rel="stylesheet" th:href="@{/css/frontend/style.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/components.css}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" th:href="@{/css/frontend/sitter/dashboard.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/booking/sitter-bookings.css}">
	<link rel="stylesheet" th:href="@{/css/frontend/evaluate-styles.css}">
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
	<header id="main-header" class="header"></header>

	<div class="container dashboard-container">
		<!-- å´é‚Šæ¬„ -->
		<div class="sidebar">
			<div class="text-center mb-2">
				<div class="avatar-wrapper">
					<img th:if="${currentMember != null and currentMember.memImage != null}"
					    th:src="@{${currentMember.memImage}}" class="avatar" alt="æœƒå“¡é ­åƒ">
					<img th:unless="${currentMember != null and currentMember.memImage != null}"
					    src="/images/member/aed4ec81-2887-41e6-8ed3-cd4cd6aa17f3_petguardianMember01.png" 
					    class="avatar" alt="é è¨­é ­åƒ">
				</div>
				<h4 th:text="${sitter != null and sitter.sitterName != null and sitter.sitterName != ''} ? ${sitter.sitterName} : ${currentMember.memName}">åç¨±</h4>
				<p style="color: #64748b; font-size: 0.85rem; margin-top: 0;">å°ˆæ¥­ä¿å§†å°ˆå€</p>
			</div>
			<nav style="margin-top: 1.5rem;">
				<a href="/sitter/dashboard" class="menu-item">
					<i class="fas fa-home"></i> ä¿å§†ä¸»é 
				</a>
				<a href="/sitter/profile/settings" class="menu-item">
					<i class="fas fa-user-cog"></i> å€‹äººè¨­å®š
				</a>
				<a href="/sitter/bookings" class="menu-item active">
					<i class="fas fa-calendar-check"></i> é ç´„ç®¡ç†
				</a>
				<div style="border-top: 1px solid #f1f5f9; margin: 0.5rem 0;"></div>
				<!-- 	<a href="/member/login" class="menu-item" style="color: var(--danger, #ef476f);">
					<i class="fas fa-sign-out-alt"></i> ç™»å‡º  -->
				</a>
			</nav>
		</div>

		<!-- ä¸»è¦å…§å®¹å€ -->
		<div class="main-content">
			<!-- æ¨™é¡Œèˆ‡æ”¶å…¥æ‘˜è¦ -->
			<div class="income-card">
				<div>
					<h2 class="mb-1" style="color: #1e293b; font-size: 1.5rem; margin-bottom: 0.5rem;">é ç´„ç®¡ç†</h2>
					<p style="color: #64748b; margin: 0;">æª¢è¦–ä¸¦ç®¡ç†æ‚¨çš„æ‰€æœ‰æœå‹™é ç´„</p>
				</div>
				<div style="text-align: right;">
					<div class="income-label"><i class="fas fa-coins" style="color: gold;"></i> æœ¬æœˆé ä¼°æ”¶å…¥</div>
					<h3>$ <span th:text="${monthlyIncome}">0</span></h3>
				</div>
			</div>

			<!-- ç¯©é¸æ¨™ç±¤ -->
			<div class="filter-tabs">
				<a th:href="@{/sitter/bookings}" class="filter-tab"
					th:classappend="${currentStatus == null} ? 'active' : ''">
					<i class="fas fa-th-large"></i> å…¨éƒ¨è¨‚å–®
				</a>

				<a th:href="@{/sitter/bookings(status=0)}" class="filter-tab"
					th:classappend="${currentStatus == 0} ? 'active' : ''">
					<i class="fas fa-hourglass-half"></i> å¾…è™•ç†
				</a>

				<a th:href="@{/sitter/bookings(status=1)}" class="filter-tab"
					th:classappend="${currentStatus == 1} ? 'active' : ''">
					<i class="fas fa-walking"></i> é€²è¡Œä¸­
				</a>

				<a th:href="@{/sitter/bookings(status=2)}" class="filter-tab"
					th:classappend="${currentStatus == 2} ? 'active' : ''">
					<i class="fas fa-check-circle"></i> å·²å®Œæˆ
				</a>
			</div>

			<!-- é ç´„åˆ—è¡¨ -->
			<div class="booking-list">
				<div th:each="order : ${bookingList}" class="booking-card">

					<!-- å¡ç‰‡ä¸Šæ–¹ç‹€æ…‹åˆ— -->
					<div class="card-header-status">
						<span class="booking-id">NO. <span th:text="${order.bookingOrderId}"></span></span>

						<!-- ç‹€æ…‹æ¨™ç±¤åˆ¤æ–· -->
						<span th:if="${order.orderStatus == 0}" class="status-badge upcoming">ç­‰å¾…ç¢ºèª</span>
						<span th:if="${order.orderStatus == 1}" class="status-badge ongoing">é€²è¡Œä¸­</span>
						<span th:if="${order.orderStatus == 2}" class="status-badge completed">æœå‹™å®Œæˆ</span>
						<span th:if="${order.orderStatus == 3}" class="status-badge cancelled">å·²å–æ¶ˆ</span>
						<span th:if="${order.orderStatus == 4}" class="status-badge cancelled">å·²é€€æ¬¾</span>
						<span th:if="${order.orderStatus == 5}" class="status-badge completed">å·²çµæ¡ˆ</span>
					</div>

					<!-- å¡ç‰‡ä¸»è¦å…§å®¹ -->
					<div class="card-body">
						<!-- åœ–ç‰‡å€ -->
						<div class="avatar-area">
							<img th:src="@{${order.petImage != null ? order.petImage : '/images/default-pet.png'}}"
								onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=Pet'" alt="Pet"
								class="pet-avatar-img">
						</div>

						<!-- è³‡è¨Šå€ -->
						<div class="info-area">
							<h4 th:text="${order.memName}">é£¼ä¸»å§“å</h4>

							<div class="info-row">
								<i class="fas fa-paw"></i>
								<span>å¯µç‰©ï¼š<span th:text="${order.petName}"
										style="color: #1e293b; font-weight: 500;">æ¯›å­©å</span></span>
							</div>

							<div class="info-row">
								<i class="far fa-clock"></i> 
    <span th:text="${#temporals.format(order.startTime, 'yyyy-MM-dd HH:mm')}">é–‹å§‹æ™‚é–“</span>
    ~ 
    <span th:text="${#temporals.format(order.endTime, 'yyyy-MM-dd HH:mm')}">çµæŸæ™‚é–“</span>
							</div>


						</div>

						<!-- åƒ¹æ ¼èˆ‡æ“ä½œå€ -->
						<div class="price-action-area">
							<div class="price-tag" th:text="'$ ' + ${order.reservationFee}">$ 500</div>

							<div class="card-actions">
								<!-- å¾…è™•ç† -->
								<th:block th:if="${order.orderStatus == 0}">
									<form th:action="@{/chat/connect/sitter}" method="post" style="display:inline;">
										<input type="hidden" name="targetUserId" th:value="${order.memId}" />
										<input type="hidden" name="chatroomType" value="0" />
										<button type="submit" class="btn btn-outline-secondary btn-sm">
											<i class="far fa-comment-dots"></i> è¯çµ¡
										</button>
									</form>



									<button class="btn btn-primary btn-sm"
										th:onclick="'acceptOrder(' + ${order.bookingOrderId} + ')'">
										<i class="fas fa-check"></i> æ¥å—
									</button>
									<button class="btn btn-outline-danger btn-sm"
										th:onclick="'rejectOrder(' + ${order.bookingOrderId} + ')'">
										<i class="fas fa-times"></i> æ‹’çµ•
									</button>
									<button class="btn btn-outline-secondary btn-sm" onclick="alert('è¯çµ¡åŠŸèƒ½é–‹ç™¼ä¸­')">
										<i class="far fa-comment-dots"></i> è¯çµ¡
									</button>
								</th:block>

								<!-- é€²è¡Œä¸­ -->
								<th:block th:if="${order.orderStatus == 1}">
									<form th:action="@{/chat/connect/sitter}" method="post" style="display:inline;">
										<input type="hidden" name="targetUserId" th:value="${order.memId}" />
										<input type="hidden" name="chatroomType" value="0" />
										<button type="submit" class="btn btn-outline-secondary btn-sm">
											<i class="far fa-comment-dots"></i> è¯çµ¡
										</button>
									</form>

									<th:block th:with="
    now=${#temporals.createNow()},
    startTimeBound=${order.endTime.minusMinutes(30)},
    endTimeBound=${order.endTime.plusMinutes(30)},
    isWithinTime=${now.isAfter(startTimeBound) && now.isBefore(endTimeBound)}">
    
    <button class="btn btn-primary btn-sm"
        th:onclick="|handleComplete(${order.bookingOrderId}, ${isWithinTime})|"
        th:classappend="${!isWithinTime} ? 'btn-secondary' : 'btn-primary'"
        th:title="${isWithinTime ? 'é»æ“Šå®Œæˆè¨‚å–®' : 'æœå‹™çµæŸå‰å¾Œ 30 åˆ†é˜å…§æ‰å¯é»æ“Š'}">
        <i class="fas fa-flag-checkered"></i> å®Œæˆ
    </button>
</th:block>
								</th:block>

								<th:block th:if="${order.orderStatus >= 2}">
									<button class="btn btn-outline-info btn-sm" th:data-mem-id="${order.memId}"
										th:data-mem-name="${order.memName}"
										onclick="showMemberReviewModal(this.getAttribute('data-mem-id'), this.getAttribute('data-mem-name'))">
										<i class="fas fa-user-tag"></i> æœƒå“¡è©•åƒ¹
									</button>

									<!-- ğŸ”¥ é™åˆ¶ï¼šè¢«æª¢èˆ‰å…©æ¬¡å‰‡éš±è—è©•åƒ¹æŒ‰éˆ• -->
									<button th:if="${order.complaintCount < 2}" class="btn btn-primary btn-sm"
										th:onclick="|injectSitterEvalBox(this, ${order.bookingOrderId}, ${order.memId})|">
										<i class="fas fa-paw"></i> è©•åƒ¹
									</button>
								</th:block>
							</div>
						</div>
					</div>
				</div>

				<!-- ç©ºç‹€æ…‹ -->
				<div th:if="${#lists.isEmpty(bookingList)}" class="empty-state">
					<i class="fas fa-calendar-times"></i>
					<p>ç›®å‰æ²’æœ‰æ–°å¢çš„é ç´„è¨‚å–®</p>
					<a href="/sitter/dashboard" class="btn btn-primary btn-sm" style="margin-top: 1rem;">è¿”å›ä¸»é </a>
				</div>
			</div>
		</div>
	</div>

	<!-- æ‹’çµ•åŸå›  Modal -->
	<div id="rejectModal" class="modal">
		<div class="modal-content">
			<h3 class="modal-title">å©‰æ‹’é ç´„</h3>
			<p style="color: #64748b; margin-bottom: 1rem;">ç‚ºäº†è®“é£¼ä¸»äº†è§£åŸå› ï¼Œè«‹å»ºè­°å¡«å¯«ç°¡çŸ­èªªæ˜ï¼š</p>
			<textarea id="rejectReason" rows="4" 
		          maxlength="200" 
		          placeholder="ä¾‹å¦‚ï¼šä¸å¥½æ„æ€ï¼Œè©²æ™‚æ®µå®¶ä¸­è‡¨æ™‚æœ‰äº‹ï¼Œç„¡æ³•æä¾›æœå‹™(å­—æ•¸é™åˆ¶:4~200å­—)..."></textarea>
			<div style="display: flex; gap: 12px; justify-content: flex-end;">
				<button class="btn btn-outline-secondary" onclick="closeRejectModal()">å†ä¾†æƒ³æƒ³</button>
				<button class="btn btn-primary" style="background-color: #ef476f; border-color: #ef476f;"
					id="confirmRejectBtn">ç¢ºèªæ‹’çµ•</button>
			</div>
		</div>
	</div>
	<div class="pagination-wrapper">
	    <div class="pagination-container mt-4 d-flex justify-content-center align-items-center gap-2" th:if="${totalPages > 1}">
	        <a th:href="@{/sitter/bookings(page=0, status=${status})}" 
	           class="btn btn-outline btn-sm" th:if="${currentPage > 0}">ç¬¬ä¸€é </a>
	        <a th:href="@{/sitter/bookings(page=${currentPage - 1}, status=${status})}" 
	           class="btn btn-outline btn-sm" th:if="${currentPage > 0}">
	           <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
	        </a>
	        <span class="static-page-box">
	            <th:block th:text="${currentPage + 1}">1</th:block> / <th:block th:text="${totalPages}">1</th:block>
	        </span>
	        <a th:href="@{/sitter/bookings(page=${currentPage + 1}, status=${status})}" 
	           class="btn btn-outline btn-sm" th:if="${currentPage < totalPages - 1}">
	           ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
	        </a>
	        
	        <a th:href="@{/sitter/bookings(page=${totalPages - 1}, status=${status})}" 
	           class="btn btn-outline btn-sm" th:if="${currentPage < totalPages - 1}">æœ€å¾Œä¸€é </a>
	    </div>
	</div>
	<footer id="main-footer"></footer>

	<!-- Scripts -->
	<script th:src="@{/js/frontend/main.js}"></script>
	<script th:src="@{/js/frontend/evaluate-functions.js}"></script>
	<script th:src="@{/js/frontend/complaint-functions.js}"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/
		const contextPath = /*[[@{/}]]*/ '';
		window.currentMemId = /*[[${session.memId}]]*/ 0;
		/*]]>*/
		async function updateStatus(orderId, newStatus) {
			const statusText = {
				1: 'æ¥å—é ç´„',
				2: 'å®Œæˆæœå‹™',
				3: 'æ‹’çµ•é ç´„'
			};
			if (!confirm(`ç¢ºå®šè¦ã€Œ${statusText[newStatus]}ã€å—ï¼Ÿ`)) return;

			$.post(`/sitter/updateStatus/${orderId}`, {
				newStatus: newStatus
			}).done(function (res) {
				alert("æ›´æ–°æˆåŠŸï¼");
				location.reload();
			}).fail(function (xhr) {
				alert("æ“ä½œå¤±æ•—ï¼š" + (xhr.responseText || "æœªçŸ¥éŒ¯èª¤"));
			});
		}

		let currentRejectOrderId = null;

		function rejectOrder(orderId) {
			currentRejectOrderId = orderId;
			document.getElementById('rejectReason').value = '';

			const modal = document.getElementById('rejectModal');
			modal.style.display = 'flex';
			setTimeout(() => modal.classList.add('show'), 10);
		}

		function closeRejectModal() {
			const modal = document.getElementById('rejectModal');
			modal.classList.remove('show');
			setTimeout(() => {
				modal.style.display = 'none';
			}, 300);
		}

		document.getElementById('confirmRejectBtn').onclick = function () {
			const reason = document.getElementById('rejectReason').value;

			 if (reason.length < 4 || reason.length > 200) {
			        alert("ç‚ºäº†è®“é£¼ä¸»äº†è§£åŸå› ï¼Œå©‰æ‹’ç†ç”±è«‹å¡«å¯« 4 è‡³ 200 å€‹å­—ä¹‹é–“å–”ï¼");
			        return;
			    }
			$.post(`/sitter/updateStatus/${currentRejectOrderId}`, {
				newStatus: 3,
				reason: reason
			}).done(function (res) {
				alert("å·²å©‰æ‹’è©²é ç´„");
				location.reload();
			}).fail(function (err) {
				alert("æ“ä½œå¤±æ•—ï¼š" + err.responseText);
			});
		};

		function acceptOrder(id) { updateStatus(id, 1); }
		function completeOrder(id) { updateStatus(id, 2); }

		// é»æ“Š Modal å¤–éƒ¨é—œé–‰
		window.onclick = function (event) {
			const modal = document.getElementById('rejectModal');
			if (event.target == modal) {
				closeRejectModal();
			}
		}
		function handleComplete(orderId, isWithinTime) {
		    if (!isWithinTime) {
		        alert('è«‹åœ¨é ç´„çµæŸå‰å¾Œ 30 åˆ†é˜å…§æŒ‰å®ŒæˆæŒ‰éˆ•');
		        return false;
		    }
		    
		    // å¦‚æœåœ¨æ™‚é–“å…§ï¼ŒåŸ·è¡ŒåŸæœ¬çš„å®Œæˆé‚è¼¯
		    if (confirm('ç¢ºå®šè¦å°‡æ­¤è¨‚å–®æ¨™è¨˜ç‚ºå®Œæˆå—ï¼Ÿ')) {
		        completeOrder(orderId);
		    }
		}
	</script>
</body>

</html>