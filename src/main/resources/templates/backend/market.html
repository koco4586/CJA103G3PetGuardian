<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Pet Guardian - 二手商城管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/css/backend/style.css}">
    <link rel="stylesheet" th:href="@{/css/backend/market.css}">

</head>

<body>
<script th:src="@{/js/backend/sidebar.js}"></script>
<div class="main-content">
    <header>
        <button class="menu-btn" onclick="toggleSidebar()">☰</button>
        <img src="https://images.unsplash.com/photo-1518791841217-8f162f1e1131?q=80&w=60&auto=format&fit=crop"
             alt="admin-avatar" style="width:48px;height:48px;border-radius:10px;object-fit:cover;">
        <div>
            <h1>二手商城管理</h1>
            <div class="sub">處理訂單、退貨審核及商品類別管理</div>
        </div>
    </header>

    <section>
        <!-- 成功訊息 -->
        <div th:if="${successMessage}" class="alert-success">
            <i class="fas fa-check-circle"></i>
            <span th:text="${successMessage}">操作成功</span>
        </div>

        <!-- 錯誤訊息 -->
        <div th:if="${error}" class="alert-error">
            <i class="fas fa-exclamation-circle"></i>
            <span th:text="${error}">操作失敗</span>
        </div>

        <!-- 主要分頁標籤 -->
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('orders')">
                <i class="fa-solid fa-file-invoice-dollar"></i>
                查閱訂單紀錄
            </button>
            <button class="tab-btn" onclick="switchTab('refunds')">
                <i class="fa-solid fa-rotate-left"></i>
                退貨申請審核
                <span class="badge" th:text="${refundPendingCount}" th:if="${refundPendingCount > 0}">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('categories')">
                <i class="fa-solid fa-tags"></i>
                商品類別管理
            </button>
        </div>

        <!-- ========== 查閱訂單紀錄區塊 ========== -->
        <div id="panel-orders" class="panel active">

            <!-- 子分頁按鈕 -->
            <div class="sub-tab-container">
                <button class="sub-tab-btn active" onclick="switchOrderTab('pending')">
                    待完成 <span class="count" th:text="'(' + ${pendingCount} + ')'">(0)</span>
                </button>
                <button class="sub-tab-btn" onclick="switchOrderTab('closed')">
                    結案訂單 <span class="count" th:text="'(' + ${closedCount} + ')'">(0)</span>
                </button>
                <button class="sub-tab-btn" onclick="switchOrderTab('return')">
                    退貨 <span class="count" th:text="'(' + ${returnCount} + ')'">(0)</span>
                </button>
            </div>

            <!-- 待完成訂單 -->
            <div id="order-pending" class="sub-panel active">
                <div class="card">
                    <h3>待完成訂單</h3>
                    <div class="sub">訂單狀態為「已付款」或「已出貨」</div>

                    <table>
                        <thead>
                        <tr>
                            <th>訂單編號</th>
                            <th>買家</th>
                            <th>賣家</th>
                            <th>訂單金額</th>
                            <th>訂單狀態</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="orderData : ${pendingOrders}">
                            <td th:text="'#' + ${orderData.order.orderId}">#001</td>
                            <td th:text="${orderData.buyerName}">買家名稱</td>
                            <td th:text="${orderData.sellerName}">賣家名稱</td>
                            <td style="font-weight: 600; color: #4a90a4;"
                                th:text="'$' + ${#numbers.formatInteger(orderData.order.orderTotal, 0, 'COMMA')}">
                                $0
                            </td>
                            <td>
                                <span class="status-badge status-paid"
                                      th:if="${orderData.order.orderStatus == 0}">已付款</span>
                                <span class="status-badge status-shipped"
                                      th:if="${orderData.order.orderStatus == 1}">已出貨</span>
                            </td>
                            <td>
                                <button class="btn"
                                        style="background: var(--orange); color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer;"
                                        th:onclick="'openAdminOrderDetail(' + ${orderData.order.orderId} + ')'">
                                    <i class="fa-solid fa-eye"></i> 查閱
                                </button>
                            </td>
                        </tr>

                        <!-- 空狀態 -->
                        <tr th:if="${#lists.isEmpty(pendingOrders)}">
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>目前沒有待完成訂單</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 結案訂單 -->
            <div id="order-closed" class="sub-panel">
                <div class="card">
                    <h3>結案訂單</h3>
                    <div class="sub">訂單狀態為「已完成」或「已取消」，可進行撥款操作</div>

                    <table>
                        <thead>
                        <tr>
                            <th>訂單編號</th>
                            <th>買家</th>
                            <th>賣家</th>
                            <th>訂單金額</th>
                            <th>訂單狀態</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="orderData : ${closedOrders}">
                            <td th:text="'#' + ${orderData.order.orderId}">#001</td>
                            <td th:text="${orderData.buyerName}">買家名稱</td>
                            <td th:text="${orderData.sellerName}">賣家名稱</td>
                            <td style="font-weight: 600; color: #4a90a4;"
                                th:text="'$' + ${#numbers.formatInteger(orderData.order.orderTotal, 0, 'COMMA')}">
                                $0
                            </td>
                            <td>
                                <span class="status-badge status-completed"
                                      th:if="${orderData.order.orderStatus == 2}">已完成</span>
                                <span class="status-badge status-cancelled"
                                      th:if="${orderData.order.orderStatus == 3}">已取消</span>
                                <span class="status-badge status-paidout"
                                      th:if="${orderData.order.orderStatus == 6}">已撥款</span>
                            </td>
                            <td>
                                <!-- 已完成訂單可撥款 -->
                                <button class="btn"
                                        style="background: var(--orange); color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px;"
                                        th:onclick="'openAdminOrderDetail(' + ${orderData.order.orderId} + ')'">
                                    <i class="fa-solid fa-eye"></i> 查閱
                                </button>
                                <form th:if="${orderData.order.orderStatus == 2}"
                                      th:action="@{/admin/store/payout}" method="post" style="display: inline;">
                                    <input type="hidden" name="orderId" th:value="${orderData.order.orderId}">
                                    <button type="submit" class="btn"
                                            style="background: var(--orange); color: white;"
                                            onclick="return confirm('確定要撥款給賣家嗎？')">
                                        <i class="fa-solid fa-money-bill-transfer"></i> 撥款給賣家
                                    </button>
                                </form>

                                <!-- 已撥款 -->
                                <button th:if="${orderData.order.orderStatus == 6}"
                                        class="btn" disabled style="background: #ccc;">
                                    <i class="fa-solid fa-check"></i> 已撥款
                                </button>

                                <!-- 已取消 -->
                                <span th:if="${orderData.order.orderStatus == 3}" style="color: #999;">-</span>
                            </td>
                        </tr>

                        <!-- 空狀態 -->
                        <tr th:if="${#lists.isEmpty(closedOrders)}">
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>目前沒有結案訂單</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 退貨訂單 -->
            <div id="order-return" class="sub-panel">
                <div class="card">
                    <h3>退貨訂單</h3>
                    <div class="sub">訂單狀態為「申請退貨中」或「退貨完成」</div>

                    <table>
                        <thead>
                        <tr>
                            <th>訂單編號</th>
                            <th>買家</th>
                            <th>賣家</th>
                            <th>訂單金額</th>
                            <th>訂單狀態</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="orderData : ${returnOrders}">
                            <td th:text="'#' + ${orderData.order.orderId}">#001</td>
                            <td th:text="${orderData.buyerName}">買家名稱</td>
                            <td th:text="${orderData.sellerName}">賣家名稱</td>
                            <td style="font-weight: 600; color: #4a90a4;"
                                th:text="'$' + ${#numbers.formatInteger(orderData.order.orderTotal, 0, 'COMMA')}">
                                $0
                            </td>
                            <td>
                                <span class="status-badge status-refunding"
                                      th:if="${orderData.order.orderStatus == 4}">申請退貨中</span>
                                <span class="status-badge status-refunded"
                                      th:if="${orderData.order.orderStatus == 5}">退貨完成</span>
                            </td>
                            <td>
                                <button class="btn"
                                        style="background: var(--orange); color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer;"
                                        th:onclick="'openAdminOrderDetail(' + ${orderData.order.orderId} + ')'">
                                    <i class="fa-solid fa-eye"></i> 查閱
                                </button>
                            </td>
                        </tr>

                        <!-- 空狀態 -->
                        <tr th:if="${#lists.isEmpty(returnOrders)}">
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>目前沒有退貨訂單</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== 退貨申請審核區塊 ========== -->
        <div id="panel-refunds" class="panel">
            <div class="card">
                <h3>退貨爭議審核</h3>
                <div class="sub">買家發起退貨申請，需管理員介入審核是否符合退貨標準。</div>

                <table>
                    <thead>
                    <tr>
                        <th>退貨訂單編號</th>
                        <th>訂單編號</th>
                        <th>申請人</th>
                        <th>退款金額</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="returnData : ${returnsWithDetails}">
                        <td th:text="'#REF-' + ${returnData.returnOrder.returnId}">#REF-001</td>
                        <td th:text="'#' + ${returnData.returnOrder.orderId}">#ORD-001</td>
                        <td th:text="${returnData.buyerName}">申請人</td>
                        <td style="font-weight: 600; color: #e67e22;"
                            th:text="'$' + ${#numbers.formatInteger(returnData.returnOrder.refundAmount, 0, 'COMMA')}">
                            $0
                        </td>
                        <td>
                            <span class="status-badge return-pending"
                                  th:if="${returnData.isPending}">審核中</span>
                            <span class="status-badge return-approved"
                                  th:if="${returnData.isApproved}">已通過</span>
                            <span class="status-badge return-rejected"
                                  th:if="${returnData.isRejected}">已駁回</span>
                        </td>
                        <td>
                            <!-- 待審核狀態 -->
                            <div th:if="${returnData.isPending}" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn"
                                        style="background: #2196f3; color: white;"
                                        th:onclick="'openModal(' + ${returnData.returnOrder.returnId} + ')'">
                                    <i class="fa-solid fa-eye"></i> 查看
                                </button>

                                <form th:action="@{/admin/store/return/approve}" method="post" style="display: inline;">
                                    <input type="hidden" name="returnId" th:value="${returnData.returnOrder.returnId}">
                                    <button type="submit" class="btn"
                                            style="background: var(--orange); color: white;"
                                            onclick="return confirm('確定批准退款並撥款給買家嗎？')">
                                        <i class="fa-solid fa-check"></i> 批准
                                    </button>
                                </form>

                                <form th:action="@{/admin/store/return/reject}" method="post" style="display: inline;">
                                    <input type="hidden" name="returnId" th:value="${returnData.returnOrder.returnId}">
                                    <button type="submit" class="btn ghost"
                                            style="color: red; border-color: red;"
                                            onclick="return confirm('確定駁回退款申請嗎？')">
                                        <i class="fa-solid fa-times"></i> 駁回
                                    </button>
                                </form>
                            </div>

                            <!-- 已處理狀態 -->
                            <div th:unless="${returnData.isPending}">
                                <button type="button" class="btn"
                                        style="background: #2196f3; color: white;"
                                        th:onclick="'openModal(' + ${returnData.returnOrder.returnId} + ')'">
                                    <i class="fa-solid fa-eye"></i> 查看
                                </button>
                                <span style="color: #999; margin-left: 10px;">已處理</span>
                            </div>
                        </td>
                    </tr>

                    <!-- 空狀態 -->
                    <tr th:if="${#lists.isEmpty(returnsWithDetails)}">
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>目前沒有退貨申請</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== 商品類別管理區塊 ========== -->
        <div id="panel-categories" class="panel">

            <!-- 新增類別按鈕 -->
            <div style="margin-bottom:16px;">
                <button class="btn" onclick="openCategoryModal()"
                        style="background:var(--orange); color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">
                    <i class="fa-solid fa-plus"></i> 新增類別
                </button>
            </div>

            <!-- 類別列表 -->
            <div class="card">
                <h3>商品類別列表</h3>
                <div class="sub" style="margin-bottom: 15px;">管理二手商城的商品分類</div>

                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                        <tr>
                            <th style="width: 100px;">ID</th>
                            <th>類別名稱</th>
                            <th style="width: 120px;">商品數量</th>
                            <th style="width: 200px;">操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="typeData : ${proTypesWithCount}">
                            <td th:text="${typeData.proType.proTypeId}">1</td>
                            <td th:text="${typeData.proType.proTypeName}">類別名稱</td>
                            <td th:text="${typeData.productCount} + ' 件'">0 件</td>
                            <td>
                                <button class="btn" onclick="editCategory(this)"
                                        th:data-id="${typeData.proType.proTypeId}"
                                        th:data-name="${typeData.proType.proTypeName}"
                                        style="background:var(--orange); color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin-right:8px;">
                                    編輯
                                </button>
                                <form th:action="@{/admin/store/protype/delete}" method="post" style="display:inline;"
                                      onsubmit="return confirm('確定要刪除這個類別嗎？如果此類別下有商品將無法刪除。');">
                                    <input type="hidden" name="proTypeId" th:value="${typeData.proType.proTypeId}">
                                    <button type="submit" class="btn ghost"
                                            style="background:#6c757d; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">
                                        刪除
                                    </button>
                                </form>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(proTypesWithCount)}">
                            <td colspan="4" style="padding:40px; text-align:center; color:#999;">
                                目前沒有任何類別
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </section>

    <!-- 後台訂單詳情 Modal -->
    <div id="adminOrderDetailModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>
                    <i class="fa-solid fa-file-invoice" style="color: var(--orange);"></i>
                    訂單詳情
                    <span id="adminDetailOrderId" style="font-weight: 400; color: #999; margin-left: 0.5rem;">#0</span>
                </h3>
                <button class="modal-close" onclick="closeAdminOrderDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 載入中提示 -->
                <div id="adminOrderLoading" style="text-align: center; padding: 2rem; color: #999;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 1.5rem;"></i>
                    <p>載入中...</p>
                </div>

                <!-- 訂單詳情內容 -->
                <div id="adminOrderContent" style="display: none;">
                    <!-- 訂單資訊 -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; font-size: 1rem;">
                            <i class="fa-solid fa-info-circle" style="color: var(--orange);"></i> 訂單資訊
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="display: flex; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">訂單狀態</span>
                                <span id="adminDetailStatus" style="font-size: 0.95rem; color: #333; font-weight: 500;">-</span>
                            </div>
                            <div style="display: flex; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">下單時間</span>
                                <span id="adminDetailOrderTime" style="font-size: 0.95rem; color: #333; font-weight: 500;">-</span>
                            </div>
                            <div style="display: flex; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">買家</span>
                                <span id="adminDetailBuyerName" style="font-size: 0.95rem; color: #333; font-weight: 500;">-</span>
                            </div>
                            <div style="display: flex; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">訂單金額</span>
                                <span id="adminDetailOrderTotal" style="font-size: 0.95rem; color: var(--orange); font-weight: 600;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 收件資訊 -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; font-size: 1rem;">
                            <i class="fa-solid fa-truck" style="color: var(--orange);"></i> 收件資訊
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="display: flex; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">收件人</span>
                                <span id="adminDetailReceiverName" style="font-size: 0.95rem; color: #333; font-weight: 500;">-</span>
                            </div>
                            <div style="display: flex; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">聯絡電話</span>
                                <span id="adminDetailReceiverPhone" style="font-size: 0.95rem; color: #333; font-weight: 500;">-</span>
                            </div>
                            <div style="display: flex; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px; grid-column: 1 / -1;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">收件地址</span>
                                <span id="adminDetailReceiverAddress" style="font-size: 0.95rem; color: #333; font-weight: 500;">-</span>
                            </div>
                            <div id="adminDetailSpecialRow" style="display: none; flex-direction: column; padding: 10px 12px; background: #f9f9f9; border-radius: 8px; grid-column: 1 / -1;">
                                <span style="font-size: 0.85rem; color: #868e96; margin-bottom: 4px;">備註</span>
                                <span id="adminDetailSpecialInstructions" style="font-size: 0.95rem; color: #333; font-weight: 500;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 訂單商品 -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; font-size: 1rem;">
                            <i class="fa-solid fa-shopping-cart" style="color: var(--orange);"></i> 訂單商品
                        </h4>
                        <div id="adminOrderItemsContainer" style="background: #f9f9f9; border-radius: 8px; padding: 12px;">
                            <p style="color: #999; text-align: center;">載入中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 退貨詳情 Modal -->
<div id="returnDetailModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fa-solid fa-file-lines"></i> 退貨申請詳情</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="detail-row">
                <span class="detail-label">退貨單編號</span>
                <span class="detail-value" id="modal-returnId">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">訂單編號</span>
                <span class="detail-value" id="modal-orderId">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">申請人</span>
                <span class="detail-value" id="modal-buyerName">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">賣家</span>
                <span class="detail-value" id="modal-sellerName">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">退款金額</span>
                <span class="detail-value" id="modal-refundAmount" style="color: #e67e22; font-weight: 600;">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">申請時間</span>
                <span class="detail-value" id="modal-applyTime">-</span>
            </div>
            <div class="detail-row" style="flex-direction: column;">
                <span class="detail-label" style="margin-bottom: 8px;">退款原因</span>
                <div id="modal-returnReason"
                     style="background: #f9f9f9; padding: 12px; border-radius: 8px; color: #333;">
                    -
                </div>
            </div>
            <div id="modal-images-container" style="margin-top: 15px; display: none;">
                <span class="detail-label" style="margin-bottom: 8px; display: block;">退貨圖片</span>
                <div id="modal-images" style="display: flex; gap: 10px; flex-wrap: wrap;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增/編輯類別 Modal -->
<div id="categoryModal" class="modal-overlay" style="display:none;">
    <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:400px;">
        <h3 id="categoryModalTitle" style="margin:0 0 20px 0;">新增類別</h3>
        <form th:action="@{/admin/store/protype/add}" method="post" id="categoryForm">
            <input type="hidden" id="proTypeIdEdit" name="proTypeId">

            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">類別名稱 <span style="color:red;">*</span></label>
                <input type="text" id="proTypeName" name="proTypeName" required
                       placeholder="例如：貓咪用品、狗狗服飾"
                       style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; outline:none; box-sizing:border-box;">
            </div>

            <div style="text-align:right;">
                <button type="button" onclick="closeCategoryModal()"
                        style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-right:10px;">
                    取消
                </button>
                <button type="submit"
                        style="background:var(--orange); color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;">
                    儲存
                </button>
            </div>
        </form>
    </div>
</div>
<script th:src="@{/js/backend/market/market.js}"></script>

</body>

</html>