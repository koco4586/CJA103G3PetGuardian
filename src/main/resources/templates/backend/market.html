<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pet Guardian - 二手商城管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/backend/style.css}">
    <link rel="stylesheet" th:href="@{/css/backend/market.css}">

</head>

<body>
<script th:src="@{/js/backend/sidebar.js}"></script>

<div class="main-content">
    <header>
        <button class="menu-btn" onclick="toggleSidebar()">☰</button>
        <div>
            <h1>二手商城管理</h1>
            <div class="sub">處理訂單撥款與退款爭議</div>
        </div>
    </header>

    <section>
        <!-- 成功訊息 -->
        <div th:if="${successMessage}" class="alert-success">
            <i class="fas fa-check-circle"></i>
            <span th:text="${successMessage}">操作成功</span>
        </div>

        <!-- 錯誤訊息 -->
        <div th:if="${error}" class="alert-error">
            <i class="fas fa-exclamation-circle"></i>
            <span th:text="${error}">操作失敗</span>
        </div>

        <!-- 分頁標籤 -->
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('orders')">
                <i class="fa-solid fa-file-invoice-dollar"></i> 查閱訂單紀錄及撥款
            </button>
            <button class="tab-btn" onclick="switchTab('refunds')">
                <i class="fa-solid fa-rotate-left"></i> 退款審核申請
            </button>
        </div>

        <!-- ========== 訂單撥款區塊 ========== -->
        <div id="panel-orders" class="panel active">
            <div class="card">
                <h3>待撥款訂單列表</h3>
                <div class="sub" style="margin-bottom:15px; color:#666;">
                    當買家確認收貨後（訂單狀態為「已完成」），系統將顯示於此，管理員需手動撥款給賣家。
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>訂單編號</th>
                        <th>買家</th>
                        <th>賣家</th>
                        <th>訂單金額</th>
                        <th>下單時間</th>
                        <th>完成時間</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="orderData : ${ordersWithDetails}">
                        <td th:text="'#' + ${orderData.order.orderId}">#ORD-001</td>
                        <td th:text="${orderData.buyerName}">王小明</td>
                        <td th:text="${orderData.sellerName}">陳大發</td>
                        <td style="font-weight: 600; color: var(--orange);"
                            th:text="'$' + ${#numbers.formatInteger(orderData.order.orderTotal, 0, 'COMMA')}">
                            $1,500
                        </td>
                        <td th:text="${#temporals.format(orderData.order.orderTime, 'yyyy-MM-dd HH:mm')}">
                            2024-01-01 10:00
                        </td>
                        <td th:text="${#temporals.format(orderData.order.orderTime, 'yyyy-MM-dd HH:mm')}">
                            2024-01-05 15:30
                        </td>
                        <td>
                            <form th:action="@{/admin/marketplace/payout}" method="post" style="display: inline;">
                                <input type="hidden" name="orderId" th:value="${orderData.order.orderId}">
                                <button type="submit" class="btn"
                                        onclick="return confirm('確定要撥款給賣家嗎？')">
                                    <i class="fa-solid fa-money-bill-transfer"></i> 撥款給賣家
                                </button>
                            </form>
                        </td>
                    </tr>

                    <!-- 空狀態 -->
                    <tr th:if="${#lists.isEmpty(ordersWithDetails)}">
                        <td colspan="7" style="text-align: center; padding: 3rem; color: #999;">
                            <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; display: block; margin-bottom: 1rem;"></i>
                            <p>目前沒有待撥款訂單</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== 退款審核區塊 ========== -->
        <div id="panel-refunds" class="panel">
            <div class="card">
                <h3>退款爭議審核</h3>
                <div class="sub" style="margin-bottom:15px; color:#666;">
                    買家發起退款申請，需人工介入審核是否符合退貨標準。
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>申請編號</th>
                        <th>訂單編號</th>
                        <th>申請人</th>
                        <th>退款金額</th>
                        <th>退款原因</th>
                        <th>申請時間</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="returnData : ${returnsWithDetails}">
                        <td th:text="'#REF-' + ${returnData.returnOrder.returnId}">#REF-009</td>
                        <td th:text="'#' + ${returnData.returnOrder.orderId}">#ORD-001</td>
                        <td th:text="${returnData.buyerName}">李四</td>
                        <td style="font-weight: 600; color: var(--orange);"
                            th:text="'$' + ${#numbers.formatInteger(returnData.returnOrder.refundAmount, 0, 'COMMA')}">
                            $1,500
                        </td>
                        <td>
                            <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                 th:text="${returnData.returnOrder.returnReason}"
                                 th:title="${returnData.returnOrder.returnReason}">
                                商品破損嚴重，與描述不符
                            </div>
                        </td>
                        <td th:text="${#temporals.format(returnData.returnOrder.applyTime, 'yyyy-MM-dd HH:mm')}">
                            2024-01-06 10:00
                        </td>
                        <td>
                                    <span th:if="${returnData.returnOrder.returnStatus == 0}"
                                          style="color:orange; font-weight:bold;">
                                        <i class="fa-solid fa-clock"></i> 待審核
                                    </span>
                            <span th:if="${returnData.returnOrder.returnStatus == 1}"
                                  style="color:green; font-weight:bold;">
                                        <i class="fa-solid fa-check"></i> 已批准
                                    </span>
                            <span th:if="${returnData.returnOrder.returnStatus == 2}"
                                  style="color:red; font-weight:bold;">
                                        <i class="fa-solid fa-times"></i> 已駁回
                                    </span>
                        </td>
                        <td>
                            <!-- 待審核狀態：顯示批准和駁回按鈕 -->
                            <div th:if="${returnData.returnOrder.returnStatus == 0}"
                                 style="display: flex; gap: 8px;">
                                <form th:action="@{/admin/marketplace/return/approve}" method="post" style="display: inline;">
                                    <input type="hidden" name="returnId" th:value="${returnData.returnOrder.returnId}">
                                    <button type="submit" class="btn" style="background:#4CAF50;"
                                            onclick="return confirm('確定批准退款並撥款給買家嗎？')">
                                        <i class="fa-solid fa-check"></i> 批准退款
                                    </button>
                                </form>

                                <form th:action="@{/admin/marketplace/return/reject}" method="post" style="display: inline;">
                                    <input type="hidden" name="returnId" th:value="${returnData.returnOrder.returnId}">
                                    <button type="submit" class="btn" style="background:#d9534f;"
                                            onclick="return confirm('確定駁回退款申請嗎？')">
                                        <i class="fa-solid fa-times"></i> 駁回
                                    </button>
                                </form>
                            </div>

                            <!-- 已處理狀態 -->
                            <div th:if="${returnData.returnOrder.returnStatus != 0}">
                                <span style="color: #999;">已處理</span>
                            </div>
                        </td>
                    </tr>

                    <!-- 空狀態 -->
                    <tr th:if="${#lists.isEmpty(returnsWithDetails)}">
                        <td colspan="8" style="text-align: center; padding: 3rem; color: #999;">
                            <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; display: block; margin-bottom: 1rem;"></i>
                            <p>目前沒有退款申請</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </section>
</div>

<script th:src="@{/js/backend/store/store.js}"></script>
</body>

</html>