<!doctype html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pet Guardian - 預約管理</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" th:href="@{/css/backend/style.css}">
<link rel="stylesheet" th:href="@{/css/backend/bookings.css}">
</head>

<body>
	<script th:src="@{/js/backend/sidebar.js}"></script>
	<div class="main-content">
		<header>
			<button class="menu-btn" onclick="toggleSidebar()">☰</button>
			<img
				src="https://images.unsplash.com/photo-1518791841217-8f162f1e1131?q=80&w=60&auto=format&fit=crop"
				alt="logo"
				style="width: 48px; height: 48px; border-radius: 10px; object-fit: cover;">
			<div>
				<h1>預約管理</h1>
				<div class="sub">追蹤服務進度與執行財務作業</div>
			</div>
		</header>

		<section>
			<div class="tab-container">
				<button class="tab-btn active" onclick="switchTab('all-process')">
					<i class="fa-solid fa-list-check"></i> 預約進度與撥款
				</button>
				<button class="tab-btn" onclick="switchTab('refund-requests')">
					<i class="fa-solid fa-hand-holding-dollar"></i> 退款申請審核
				</button>
			</div>

			<div id="panel-all-process" class="panel active">
				<div class="card">
					<h3>全部預約流程</h3>
					<table>
						<thead>
							<tr>
								<th>編號</th>
								<th>飼主 / 保母</th>
								<th>日期</th>
								<th>狀態</th>
								<th>總額 / 實撥</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="order : ${allBookings}">
								<td th:text="'#BK-' + ${order.bookingOrderId}"></td>
								<td><span th:text="'會員ID: ' + ${order.memId}"></span> <i
									class="fa-solid fa-arrow-right"></i> <span
									th:text="'保母ID: ' + ${order.sitterId}"></span></td>
								<td th:text="${#temporals.format(order.startTime, 'MM-dd')}"></td>
								<td><span th:if="${order.orderStatus == 0}"
									class="badge status-wait">待確認</span> <span
									th:if="${order.orderStatus == 1}" class="badge status-ongoing">進行中</span>
									<span th:if="${order.orderStatus == 2}"
									class="badge status-ready">服務完成</span> <span
									th:if="${order.orderStatus == 5}" class="badge">已結案</span></td>
								<td><span th:text="'$' + ${order.reservationFee}"></span> /
									<strong th:if="${order.orderStatus == 5}" style="color: green">已撥款</strong>
								</td>
								<td>
									<button th:if="${order.orderStatus == 2}" class="btn"
										style="background: green;"
										th:onclick="'executePayout(' + ${order.bookingOrderId} + ')'">執行撥款</button>
									<button th:if="${order.orderStatus == 0}" class="btn ghost">催促保母</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<div id="panel-refund-requests" class="panel">
				<div class="card">
					<h3>
						<i class="fa-solid fa-triangle-exclamation"></i> 退款申請待處理
					</h3>
					<table style="width: 100%; table-layout: fixed; border-collapse: collapse;">
						<thead>
							<tr>
								<th style="width: 10%;">編號</th>
			                    <th style="width: 15%;">申請人</th>
			                    <th style="width: 20%;">服務時間 / 金額</th> <th style="width: 15%;">申請時間</th>
			                    <th style="width: 15%;">原因</th>
			                    <th style="width: 25%;">操作</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="order : ${refundRequests}">
								<td th:text="'#BK-' + ${order.bookingOrderId}"></td>
								<td th:text="'會員ID: ' + ${order.memId}"></td>
			                    <td>
			                        <div style="font-weight: 600; color: #1e293b;" 
			                             th:text="${#temporals.format(order.startTime, 'yyyy-MM-dd')}"></div>
			                        <div style="font-size: 0.8rem; color: #64748b;" 
			                             th:text="${#temporals.format(order.startTime, 'HH:mm')} + ' ~ ' + ${#temporals.format(order.endTime, 'HH:mm')}"></div>
			                        <div style="color: #ea580c; font-weight: 700; margin-top: 4px;" 
			                             th:text="'$ ' + ${order.reservationFee}"></div>
			                    </td>
			                    
			                    <td>
			                        <small th:text="${order.cancelTime != null ? #temporals.format(order.cancelTime, 'MM-dd HH:mm') : '無紀錄'}"></small>
			                    </td>
			                    
			                    <td>
			                        <div style="font-size: 0.85rem; max-height: 4.5em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; line-clamp: 3;" 
			                             th:title="${order.cancelReason}" 
			                             th:text="${order.cancelReason}"></div>
			                    </td>
			                    
			                    <td>
								    <th:block th:with="
								        now=${#temporals.createNow()},
								        startTime=${order.startTime},
								        cancelTime=${order.cancelTime ?: now},
								        diffDays=${startTime != null ? T(java.time.temporal.ChronoUnit).DAYS.between(cancelTime, startTime) : 0},
								        isExpired=${order.endTime != null and order.endTime.plusDays(7).isBefore(now)}">
								
								        <div th:if="${isExpired}">
								            <div style="color: #ef4444; font-size: 0.75rem; margin-bottom: 5px;">
								                <i class="fa-solid fa-clock-rotate-left"></i> 已逾期 7 天
								            </div>
								            <button class="btn" style="background: #6366f1; width: 100%;"
								                th:onclick="'forceComplete(' + ${order.bookingOrderId} + ')'">轉為完成(撥款)</button>
								        </div>
								
								        <div th:unless="${isExpired}" style="display: flex; flex-direction: column; gap: 5px;">
								            
								            <th:block th:if="${diffDays >= 7}">
								                <div style="color: #2f9e44; font-size: 0.75rem; font-weight: 600;">符合全額退費</div>
								                <button class="btn btn-sm" style="background: #2f9e44; width: 100%;"
								                    th:onclick="'approveRefund(' + ${order.bookingOrderId} + ', 1.0)'">核准全額退款</button>
								            </th:block>
								
								            <th:block th:if="${diffDays > 0 and diffDays < 7}">
								                <div style="color: #ea580c; font-size: 0.75rem; font-weight: 600;">酌收手續費 (退 50%)</div>
								                <button class="btn btn-sm" style="background: #ea580c; width: 100%;"
								                    th:onclick="'approveRefund(' + ${order.bookingOrderId} + ', 0.5)'">核准 50% 退款</button>
								            </th:block>
								
								            <th:block th:if="${diffDays <= 0}">
								                <div style="color: #fa5252; font-size: 0.75rem; font-weight: 600;">條件不符 (不予退費)</div>
								                <button class="btn btn-sm" style="background: #fa5252; width: 100%;"
								                    th:onclick="'rejectRefund(' + ${order.bookingOrderId} + ')'">駁回退款申請</button>
								            </th:block>
								
								            <button th:if="${diffDays > 0}" class="btn ghost btn-sm" style="width: 100%; color: #666; border-color: #ccc;"
								                th:onclick="'rejectRefund(' + ${order.bookingOrderId} + ')'">理由不當駁回</button>
								        </div>
								    </th:block>
								</td>
			                </tr>
			            </tbody>
			        </table>
			    </div>
			</div>
	</section>
</div>
	<script th:inline="javascript">
		// 切換頁籤邏輯
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            
            const activeBtn = event.currentTarget;
            activeBtn.classList.add('active');
            document.getElementById('panel-' + tabName).classList.add('active');
        }
        

        // 2. 核准退款
        async function handleApiCall(url, orderId, successMsg) {
        	try {
                const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'orderId=' + orderId
            })
                const data = await response.text();
                if (data === 'success') {
                    alert(successMsg);
                    location.reload();
                } else {
                    alert('處理失敗：' + data);
                }
            }catch (error) {
                alert('連線異常，請稍後再試');
            }
        }
        function approveRefund(orderId, ratio) {
        	const percent = ratio * 100;
            if (confirm(`確定要「核准」此申請嗎？\n系統將會退還 ${percent}% 的預約金給會員。`)) {
                handleApiCall('/admin/bookings/approveRefund?ratio='+ ratio, orderId, `退款已核准 (${percent}%)。`);
            }
        }

        function rejectRefund(orderId) {
            if (confirm('確定要「駁回」退款申請嗎？\n駁回後訂單將回到「進行中」狀態。')) {
                handleApiCall('/admin/bookings/rejectRefund', orderId, '已駁回申請，訂單恢復進行中。');
            }
        }

        function executePayout(orderId) {
            if (confirm('確定要「執行撥款」給保母嗎？\n一旦撥款，該筆訂單將標記為已結案。')) {
                handleApiCall('/admin/bookings/payout', orderId, '撥款成功，訂單已結案。');
            }
        }
        function forceComplete(orderId) {
            if (confirm('該申請已超過退款期限（7天），確定要將其轉為「服務完成」以便撥款嗎？')) {
                handleApiCall('/admin/bookings/forceComplete', orderId, '已轉為服務完成狀態。');
            }
        }
    </script>

</body>
</html>