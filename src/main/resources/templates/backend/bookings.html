<!doctype html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pet Guardian - 預約管理</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" th:href="@{/css/backend/style.css}">
<link rel="stylesheet" th:href="@{/css/backend/bookings.css}">
</head>

<body>
	<script th:src="@{/js/backend/sidebar.js}"></script>
	<div class="main-content">
		<header>
			<button class="menu-btn" onclick="toggleSidebar()">☰</button>
			<img
				src="https://images.unsplash.com/photo-1518791841217-8f162f1e1131?q=80&w=60&auto=format&fit=crop"
				alt="logo"
				style="width: 48px; height: 48px; border-radius: 10px; object-fit: cover;">
			<div>
				<h1>預約管理</h1>
				<div class="sub">追蹤服務進度與執行財務作業</div>
			</div>
		</header>

		<section>
			<div class="tab-container">
				<button class="tab-btn active" onclick="switchTab('all-process')">
					<i class="fa-solid fa-list-check"></i> 預約進度與撥款
				</button>
				<button class="tab-btn" onclick="switchTab('refund-requests')">
					<i class="fa-solid fa-hand-holding-dollar"></i> 退款申請審核
				</button>
			</div>

			<div id="panel-all-process" class="panel active">
				<div class="card">
					<h3>全部預約流程</h3>
					<table>
						<thead>
							<tr>
								<th>編號</th>
								<th>飼主 / 保母</th>
								<th>日期</th>
								<th>狀態</th>
								<th>總額 / 實撥</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="order : ${allBookings}">
								<td th:text="'#BK-' + ${order.bookingOrderId}"></td>
								<td><span th:text="'會員ID: ' + ${order.memId}"></span> <i
									class="fa-solid fa-arrow-right"></i> <span
									th:text="'保母ID: ' + ${order.sitterId}"></span></td>
								<td th:text="${#temporals.format(order.startTime, 'MM-dd')}"></td>
								<td>
								    <div th:if="${order.sitterStatus != null and order.sitterStatus.toString() == '1' and (order.orderStatus == 0 or order.orderStatus == 1)}" 
								         class="badge" style="background-color: #e74c3c; color: white !important;">
								        <i class="fa-solid fa-triangle-exclamation"></i> 保母已停權
								    </div>
								
								    <div th:unless="${order.sitterStatus != null and order.sitterStatus.toString() == '1' and (order.orderStatus == 0 or order.orderStatus == 1)}">
								        <span th:if="${order.orderStatus == 0}" class="badge status-wait">待確認</span>
								        <span th:if="${order.orderStatus == 1}" class="badge status-ongoing">進行中</span>
								        <span th:if="${order.orderStatus == 2}" class="badge status-ready">服務完成</span>
								        <span th:if="${order.orderStatus == 4}" class="badge" style="background-color: #95a5a6; color: white;"
								              th:text="${order.cancelReason != null and #strings.contains(order.cancelReason, '已過審核時間') ? '已退款(已過審核時間)' : '已退款'}">
								        </span>
								        <span th:if="${order.orderStatus == 5}" class="badge">已結案</span>
								        <span th:if="${order.orderStatus == 6}" class="badge" style="background-color: #e74c3c; color: white;">保母停權</span>
								    </div>
								</td>
								<td><span th:text="'$' + ${order.reservationFee}"></span> /
									<strong th:if="${order.orderStatus == 5}" style="color: green">已撥款</strong>
								</td>
								<td>
									<button th:if="${order.orderStatus == 2}" class="btn"
										style="background: green;"
										th:onclick="'executePayout(' + ${order.bookingOrderId} + ')'">執行撥款</button>
								<!-- 	<button th:if="${order.orderStatus == 0}" class="btn ghost">催促保母</button> -->
									<button th:if="${order.sitterStatus != null and order.sitterStatus.toString() == '1' and (order.orderStatus == 0 or order.orderStatus == 1)}" 
									        class="btn" style="background: #e67e22;"
									        th:onclick="'suspendSitterRefund(' + ${order.bookingOrderId} + ')'">
									    處置停權退款
									</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<div id="panel-refund-requests" class="panel">
				<div class="card">
					<h3>
						<i class="fa-solid fa-triangle-exclamation"></i> 退款申請待處理
					</h3>
					<table>
						<thead>
							<tr>
								<th>編號</th>
								<th>申請人</th>
								<th>服務時間</th> <th>申請退款時間</th><th>原因</th>
								<th>預約金額</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="order : ${refundRequests}">
								<td th:text="'#BK-' + ${order.bookingOrderId}"></td>
								<td th:text="'會員ID: ' + ${order.memId}"></td>
								<td th:text="${#temporals.format(order.startTime, 'MM-dd HH:mm')} + ' ~ ' + ${#temporals.format(order.endTime, 'HH:mm')}"></td>
						        <td th:style="${order.cancelTime != null && order.cancelTime.isAfter(order.startTime.minusHours(24)) ? 'color: orange; font-weight: bold;' : ''}">
                                    <span th:text="${order.cancelTime != null ? #temporals.format(order.cancelTime, 'MM-dd HH:mm') : '無資料'}"></span>
                                    <small th:if="${order.cancelTime != null && order.cancelTime.isAfter(order.startTime.minusHours(24))}" 
                                           style="display: block; font-size: 10px;">(低於24h)</small>
                                </td>
                                <td th:text="${order.cancelReason}"></td>
                                <td th:text="'$' + ${order.reservationFee}"></td>
                                
								<td>
									<button class="btn"
										th:onclick="'approveRefund(' + ${order.bookingOrderId} + ')'">核准退款</button>
									<button class="btn ghost"
										style="color: red; border-color: red;"
										th:onclick="'rejectRefund(' + ${order.bookingOrderId} + ')'">駁回</button>
								</td>
								</tr>
                        </tbody>
								<div th:if="${isExpired}">
				                    <button class="btn" style="background: #6c757d;" 
				                            th:onclick="'forceCompleteRefund(' + ${order.bookingOrderId} + ')'">
				                        已退款 (已過審核時間)
				                    </button>
				                </div>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</section>
	</div>
	<script th:inline="javascript">
		// 切換頁籤邏輯
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            
            const activeBtn = event.currentTarget;
            activeBtn.classList.add('active');
            document.getElementById('panel-' + tabName).classList.add('active');
        }
        

        // 2. 核准退款
        async function handleApiCall(url, orderId, successMsg) {
        	try {
                const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'orderId=' + orderId
            })
                const data = await response.text();
                if (data === 'success') {
                    alert(successMsg);
                    location.reload();
                } else {
                    alert('處理失敗：' + data);
                }
            }catch (error) {
                alert('連線異常，請稍後再試');
            }
        }
        function approveRefund(orderId) {
            if (confirm('確定要「核准」退款嗎？\n核准後訂單將結案，且保母的預約時段將會釋出。')) {
                handleApiCall('/admin/bookings/approveRefund', orderId, '退款已核准，時段已釋出。');
            }
        }
        function rejectRefund(orderId) {
            if (confirm('確定要「駁回」退款申請嗎？\n駁回後訂單將回到「進行中」狀態。')) {
                handleApiCall('/admin/bookings/rejectRefund', orderId, '已駁回申請，訂單恢復進行中。');
            }
        }

        function executePayout(orderId) {
            if (confirm('確定要「執行撥款」給保母嗎？\n一旦撥款，該筆訂單將標記為已結案。')) {
                handleApiCall('/admin/bookings/payout', orderId, '撥款成功，訂單已結案。');
            }
        }
        function suspendSitterRefund(orderId) {
            if (confirm('確定要執行「保母停權退款」嗎？\n這將會 100% 退款給會員並將訂單標記為停權。')) {
                handleApiCall('/admin/bookings/suspendRefund', orderId, '已執行停權退款，時段已釋出。');
            }
        }
    </script>

</body>
</html>