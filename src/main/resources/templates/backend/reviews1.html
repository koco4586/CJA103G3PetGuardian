<!doctype html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pet Guardian - è©•åƒ¹ç®¡ç†</title>
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css}" />
    <link rel="stylesheet" th:href="@{/css/backend/style.css}">
    <link rel="stylesheet" th:href="@{/css/backend/reviews.css}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* é é¢å°ˆç”¨æ¨£å¼ - å…¶ä»–æ¨£å¼ç¹¼æ‰¿è‡ª style.css */
        textarea:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(206, 135, 91, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }
    </style>

</head>

<body>
    <script th:src="@{/js/backend/sidebar.js}"></script>

    <div class="main-content">
        <header>
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
            <img src="https://images.unsplash.com/photo-1518791841217-8f162f1e1131?q=80&w=60&auto=format&fit=crop"
                alt="logo" style="width:48px;height:48px;border-radius:10px;object-fit:cover;">
            <div>
                <h1>è©•åƒ¹æª¢èˆ‰ç®¡ç†</h1>
                <div class="sub">è™•ç†å…¨ç«™ï¼ˆæœƒå“¡/ä¿æ¯ï¼‰é•è¦è©•åƒ¹å¯©æ ¸</div>
            </div>
        </header>

        <section>
            <div class="tab-container" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="tab-btn active" onclick="switchTab(this, 'pending-section')" style="
                    padding: 10px 20px; 
                    border: none; 
                    background: #eee; 
                    border-radius: 8px 8px 0 0; 
                    cursor: pointer; 
                    font-weight: bold;
                    transition: all 0.3s;
                ">
                    <i class="fa-solid fa-clock"></i> å¾…è™•ç†æª¢èˆ‰ä»¶
                </button>
                <button class="tab-btn" onclick="switchTab(this, 'closed-section')" style="
                    padding: 10px 20px; 
                    border: none; 
                    background: #eee; 
                    border-radius: 8px 8px 0 0; 
                    cursor: pointer; 
                    font-weight: bold;
                    transition: all 0.3s;
                ">
                    <i class="fa-solid fa-box-archive"></i> å·²çµæ¡ˆç´€éŒ„
                </button>
            </div>

            <style>
                .tab-btn.active {
                    background: #fff !important;
                    color: var(--orange);
                    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                    border-bottom: 2px solid var(--orange);
                }

                .content-section {
                    display: none;
                }

                .content-section.active {
                    display: block;
                }
            </style>

            <div id="pending-section" class="card content-section active">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-list-ul"></i> å¾…è™•ç†æª¢èˆ‰ä»¶</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æª¢èˆ‰äºº / è¢«æª¢èˆ‰äºº</th>
                            <th>è¢«æª¢èˆ‰è©•åƒ¹å…§å®¹</th>
                            <th>è¢«æª¢èˆ‰åŸå› </th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="complaint : ${complaintList}" th:if="${complaint.reportStatus == 0}">
                            <td>
                                <div style="font-weight: bold; color: #2c3e50;">
                                    æª¢èˆ‰äººï¼š<span
                                        th:text="${complaint.reporterName ?: 'æœªçŸ¥ (ID:' + complaint.reportMemId + ')'}"></span>
                                </div>
                                <div style="color: #c62828; margin-top: 5px;">
                                    è¢«æª¢èˆ‰äººï¼š<span
                                        th:text="${complaint.accusedName ?: 'æœªçŸ¥ (ID:' + complaint.toReportedMemId + ')'}"></span>
                                </div>
                            </td>
                            <td style="max-width: 300px;">
                                <div
                                    style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.9rem; color: #555; border-left: 3px solid #ddd;">
                                    <span th:text="${complaint.reportedContent ?: 'æŸ¥ç„¡è©•åƒ¹å…§å®¹'}"></span>
                                </div>
                            </td>
                            <td>
                                <span th:text="${complaint.reportReason}"></span>
                            </td>
                            <td>
                                <span style="color: orange; font-weight: bold;">
                                    <i class="fas fa-clock"></i> è™•ç†ä¸­
                                </span>
                            </td>
                            <td>
                                <button class="btn"
                                    style="background: #3498db; display: flex; align-items: center; gap: 5px;"
                                    th:onclick="'startAudit(' + ${complaint.bookingReportId} + ')'">
                                    <i class="fas fa-edit"></i> å¯©æ ¸ä¸­
                                </button>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(complaintList)}">
                            <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                                <i class="fas fa-inbox fa-2x" style="display: block; margin-bottom: 10px;"></i>
                                ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ç”³è¨´
                            </td>
                        </tr>
                    </tbody>
                </table>
                <!-- ğŸ”¥ å¾…è™•ç†åˆ†é æŒ‰éˆ• -->
                <div id="pending-pagination" class="pagination-container"></div>
            </div>

            <div id="closed-section" class="card content-section">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-archive"></i> å·²çµæ¡ˆç´€éŒ„</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æª¢èˆ‰äºº / è¢«æª¢èˆ‰äºº</th>
                            <th>è¢«æª¢èˆ‰è©•åƒ¹å…§å®¹</th>
                            <th>è¢«æª¢èˆ‰åŸå› </th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="complaint : ${complaintList}" th:if="${complaint.reportStatus != 0}">
                            <td>
                                <div style="font-weight: bold; color: #2c3e50;">
                                    æª¢èˆ‰äººï¼š<span
                                        th:text="${complaint.reporterName ?: 'æœªçŸ¥ (ID:' + complaint.reportMemId + ')'}"></span>
                                </div>
                                <div style="color: #c62828; margin-top: 5px;">
                                    è¢«æª¢èˆ‰äººï¼š<span
                                        th:text="${complaint.accusedName ?: 'æœªçŸ¥ (ID:' + complaint.toReportedMemId + ')'}"></span>
                                </div>
                            </td>
                            <td style="max-width: 300px;">
                                <div
                                    style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.9rem; color: #555; border-left: 3px solid #ddd;">
                                    <span th:text="${complaint.reportedContent ?: 'æŸ¥ç„¡è©•åƒ¹å…§å®¹'}"></span>
                                </div>
                            </td>
                            <td>
                                <span th:text="${complaint.reportReason}"></span>
                            </td>
                            <td>
                                <span th:if="${complaint.reportStatus == 1 or complaint.reportStatus == 3}"
                                    style="color: green; font-weight: bold;">
                                    <i class="fas fa-check-circle"></i> å¯©æ ¸é€šé
                                </span>
                                <span th:if="${complaint.reportStatus == 2 or complaint.reportStatus == 4}"
                                    style="color: red; font-weight: bold;">
                                    <i class="fas fa-times-circle"></i> å¯©æ ¸é§å›
                                </span>
                            </td>
                            <td>
                                <!-- ğŸ”¥ è©•è«–è™•ç†æŒ‰éˆ• -->
                                <button th:if="${complaint.reportStatus == 1 or complaint.reportStatus == 2}"
                                    class="btn-action" th:onclick="|handleClosedReview(${complaint.bookingReportId})|"
                                    style="background: #3498db;">
                                    <i class="fa-solid fa-comment"></i> è©•è«–è™•ç†
                                </button>
                                <!-- ğŸ”¥ å¯©æ ¸å·²å®Œæˆæ¨™ç±¤ -->
                                <button th:if="${complaint.reportStatus == 3 or complaint.reportStatus == 4}"
                                    class="btn-action" disabled
                                    style="background: #95a5a6; cursor: not-allowed; opacity: 0.8;">
                                    <i class="fa-solid fa-check-double"></i> å¯©æ ¸å·²å®Œæˆ
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <!-- ğŸ”¥ å·²çµæ¡ˆåˆ†é æŒ‰éˆ• -->
                <div id="closed-pagination" class="pagination-container"></div>
            </div>
        </section>
    </div>












    <script type="text/javascript">







        function switchTab(btn, sectionId) {
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            // å¢åŠ ç•¶å‰æŒ‰éˆ•çš„ active
            btn.classList.add('active');

            // éš±è—æ‰€æœ‰å€å¡Š
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            // é¡¯ç¤ºç›®æ¨™å€å¡Š
            document.getElementById(sectionId).classList.add('active');
        }

        function startAudit(reportId) {
            // ç¬¬ä¸€æ­¥ï¼šç¢ºèªæ˜¯å¦é€²å…¥è™•ç†æµç¨‹
            Swal.fire({
                title: 'ç¢ºèªè™•ç†',
                text: `æ‚¨æ˜¯å¦è¦é–‹å§‹è™•ç†ç”³è¨´æ¡ˆè™Ÿï¼š#${reportId}ï¼Ÿ`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3498db',
                cancelButtonColor: '#aaa',
                confirmButtonText: 'æ˜¯çš„ï¼Œé–‹å§‹å¯©æ ¸',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ç¬¬äºŒæ­¥ï¼šå½ˆå‡ºå¯©æ ¸é¸é …
                    openAuditModal(reportId);
                }
            });
        }

        function openAuditModal(reportId) {
            Swal.fire({
                title: 'å¯©æ ¸çµæœ',
                text: 'è«‹é¸æ“‡å°æ­¤ç”³è¨´æ¡ˆçš„è™•ç†æ–¹å¼ï¼š',
                icon: 'info',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: '<i class="fa-solid fa-check"></i> å¯©æ ¸é€šé',
                denyButtonText: '<i class="fa-solid fa-xmark"></i> ç”³è¨´é§å›',
                cancelButtonText: 'æš«æ™‚é—œé–‰',
                confirmButtonColor: '#27ae60', // ç¶ è‰² (æ ¸å‡†)
                denyButtonColor: '#e74c3c',    // ç´…è‰² (é§å›)
            }).then((result) => {
                let status = 0;
                let statusText = "";

                if (result.isConfirmed) {
                    status = 1; // å‡è¨­ 1 æ˜¯æ ¸å‡†
                    statusText = "å¯©æ ¸é€šé";
                } else if (result.isDenied) {
                    status = 2; // å‡è¨­ 2 æ˜¯é§å›
                    statusText = "å¯©æ ¸é§å›";
                } else {
                    return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ
                }

                // ç¬¬ä¸‰æ­¥ï¼šç™¼é€ AJAX åˆ°å¾Œç«¯ï¼ˆåªæ›´æ–°æª¢èˆ‰ç‹€æ…‹ï¼Œä¸è™•ç†è©•è«–ï¼‰
                sendAuditResult(reportId, status, statusText);
            });
        }

        function sendAuditResult(reportId, status, statusText, reviewAction) {
            // ğŸš© é€™è£¡çš„åœ°å€å¿…é ˆæ˜¯ /admin (é¡åˆ¥è·¯å¾‘) + /pet/updateReportStatus (æ–¹æ³•è·¯å¾‘)
            fetch('/admin/pet/updateReportStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'reportId': reportId,
                    'status': status,
                    'reviewAction': reviewAction  // ğŸ”¥ æ–°å¢è©•è«–è™•ç†åƒæ•¸
                })
            })
                .then(res => res.json()) // å› ç‚ºä½ çš„ Controller å›å‚³çš„æ˜¯ ResponseEntity.ok(Map)
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'è™•ç†æˆåŠŸ',
                            text: `æ¡ˆè™Ÿ #${reportId} å·²æ¨™è¨˜ç‚ºã€Œ${statusText}ã€`,
                            icon: 'success',
                            confirmButtonText: 'ç¢ºå®š'
                        }).then(() => {
                            location.reload(); // æˆåŠŸå¾Œåˆ·æ–°é é¢ï¼ŒThymeleaf æœƒæ ¹æ“šæ–°çš„ Status è®Šè‰²
                        });
                    } else {
                        Swal.fire('éŒ¯èª¤', 'å¾Œå°æ›´æ–°å¤±æ•—', 'error');
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    Swal.fire('éŒ¯èª¤', 'é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨è·¯å¾‘', 'error');
                });
        }

        // ğŸ”¥ è©•è«–è™•ç†åŠŸèƒ½ï¼ˆå·²çµæ¡ˆç´€éŒ„å°ˆç”¨ï¼‰
        function handleClosedReview(reportId) {
            Swal.fire({
                title: 'è©•è«–è™•ç†',
                text: 'è«‹é¸æ“‡å°è¢«æª¢èˆ‰è©•è«–çš„è™•ç†æ–¹å¼ï¼š',
                icon: 'question',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: '<i class="fa-solid fa-trash"></i> åˆªé™¤è©•è«–',
                denyButtonText: '<i class="fa-solid fa-eye"></i> è§£é™¤éš±è—',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#e74c3c', // ç´…è‰² (åˆªé™¤)
                denyButtonColor: '#27ae60',    // ç¶ è‰² (è§£é™¤éš±è—)
            }).then((result) => {
                let action = null;
                let actionText = "";

                if (result.isConfirmed) {
                    action = 'delete';
                    actionText = "åˆªé™¤è©•è«–";
                } else if (result.isDenied) {
                    action = 'unhide';
                    actionText = "è§£é™¤éš±è—";
                } else {
                    return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ
                }

                // ç™¼é€ AJAX åˆ°å¾Œç«¯
                fetch('/admin/pet/handleReview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'reportId': reportId,
                        'action': action
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'è™•ç†æˆåŠŸ',
                                text: `å·²${actionText}`,
                                icon: 'success',
                                confirmButtonText: 'ç¢ºå®š'
                            }).then(() => {
                                location.reload(); // æˆåŠŸå¾Œåˆ·æ–°é é¢
                            });
                        } else {
                            Swal.fire('éŒ¯èª¤', 'å¾Œå°æ›´æ–°å¤±æ•—', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        Swal.fire('éŒ¯èª¤', 'é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨è·¯å¾‘', 'error');
                    });
            });
        }


        // ğŸ”¥ æ™ºèƒ½è‡ªå‹•åˆ·æ–°åŠŸèƒ½
        let autoRefreshInterval;
        let lastComplaintCount = document.querySelectorAll('#pending-section tbody tr').length;

        function startAutoRefresh() {
            // æ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡
            autoRefreshInterval = setInterval(() => {
                // æª¢æŸ¥æ˜¯å¦æœ‰ SweetAlert2 å½ˆçª—é–‹å•Ÿ
                const isSwalOpen = document.querySelector('.swal2-container') !== null;

                if (!isSwalOpen) {
                    // æ²’æœ‰å½ˆçª—é–‹å•Ÿï¼Œå¯ä»¥æª¢æŸ¥æ˜¯å¦æœ‰æ–°æ¡ˆä»¶
                    fetch('/admin/reviews1')
                        .then(response => response.text())
                        .then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const newCount = doc.querySelectorAll('#pending-section tbody tr').length;

                            // å¦‚æœæ¡ˆä»¶æ•¸é‡æ”¹è®Šï¼Œè‡ªå‹•åˆ·æ–°
                            if (newCount !== lastComplaintCount) {
                                console.log(`æª¢æ¸¬åˆ°æ–°çš„æª¢èˆ‰æ¡ˆä»¶ï¼š${lastComplaintCount} â†’ ${newCount}ï¼Œè‡ªå‹•åˆ·æ–°é é¢`);
                                location.reload();
                            }
                        })
                        .catch(error => {
                            console.error('è‡ªå‹•åˆ·æ–°æª¢æŸ¥å¤±æ•—:', error);
                        });
                } else {
                    console.log('åµæ¸¬åˆ°å¯©æ ¸å½ˆçª—é–‹å•Ÿä¸­ï¼Œè·³éè‡ªå‹•åˆ·æ–°');
                }
            }, 15000); // 15 ç§’
        }

        // é é¢è¼‰å…¥æ™‚å•Ÿå‹•è‡ªå‹•åˆ·æ–°
        document.addEventListener('DOMContentLoaded', () => {
            startAutoRefresh();
            console.log('âœ… å¾Œå°å¯©æ ¸é é¢è‡ªå‹•åˆ·æ–°å·²å•Ÿå‹•ï¼ˆæ¯ 15 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰');

            // ğŸ”¥ åˆå§‹åŒ–åˆ†é åŠŸèƒ½
            initTablePagination('#pending-section table', 'pending-pagination', 10);
            initTablePagination('#closed-section table', 'closed-pagination', 10);
        });

        // é é¢å¸è¼‰æ™‚æ¸…é™¤å®šæ™‚å™¨
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });

        // ğŸ”¥ åˆ†é åŠŸèƒ½ï¼ˆæ¯é  10 ç­†ï¼Œå°‘æ–¼ 10 ç­†ä¸é¡¯ç¤ºåˆ†é ï¼‰
        function initTablePagination(tableSelector, paginationId, pageSize = 10) {
            const table = document.querySelector(tableSelector);
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
                return !row.querySelector('td[colspan]');
            });

            if (rows.length < pageSize) {
                const paginationContainer = document.getElementById(paginationId);
                if (paginationContainer) paginationContainer.style.display = 'none';
                return;
            }

            let currentPage = 1;
            const totalPages = Math.ceil(rows.length / pageSize);

            function renderPage(page) {
                rows.forEach(row => row.style.display = 'none');
                const start = (page - 1) * pageSize;
                const end = start + pageSize;
                rows.slice(start, end).forEach(row => row.style.display = '');
                renderPaginationButtons(page);
            }

            function renderPaginationButtons(page) {
                const pagination = document.getElementById(paginationId);
                if (!pagination) return;
                pagination.innerHTML = '';
                pagination.style.display = 'flex';
                pagination.style.textAlign = 'center';
                pagination.style.marginTop = '1.5rem';
                pagination.style.gap = '8px';
                pagination.style.justifyContent = 'center';
                pagination.style.flexWrap = 'wrap';

                const btnStyle = 'padding:8px 16px;border:1px solid #ddd;background:white;color:#333;border-radius:8px;cursor:pointer;transition:all 0.2s;font-size:0.9rem;';

                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'ä¸Šä¸€é ';
                prevBtn.disabled = page === 1;
                prevBtn.style.cssText = btnStyle + (page === 1 ? 'background:#f5f5f5;color:#ccc;cursor:not-allowed;' : '');
                prevBtn.onclick = () => { currentPage--; renderPage(currentPage); };
                pagination.appendChild(prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.style.cssText = btnStyle + (i === page ? 'background:#ce875b;color:white;border-color:#ce875b;font-weight:bold;' : '');
                    pageBtn.onclick = () => { currentPage = i; renderPage(currentPage); };
                    pagination.appendChild(pageBtn);
                }

                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'ä¸‹ä¸€é ';
                nextBtn.disabled = page === totalPages;
                nextBtn.style.cssText = btnStyle + (page === totalPages ? 'background:#f5f5f5;color:#ccc;cursor:not-allowed;' : '');
                nextBtn.onclick = () => { currentPage++; renderPage(currentPage); };
                pagination.appendChild(nextBtn);
            }

            renderPage(1);
        }

    </script>

</body>

</html>