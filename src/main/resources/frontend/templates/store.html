<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二手商城 | PetGuardian</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../static/css/store.css">
</head>
</head>

<body>

    <header id="main-header" class="header"></header>

    <div id="store-views">

        <!-- STORE FRONT (Buyer View) -->
        <div id="buyer-view">
            <div class="container" style="margin-top: 2rem;">
                <!-- ... header and search ... -->
                <div class="top-filter-bar">
                    <div class="d-flex justify-between align-center mb-2">
                        <div>
                            <h2 class="mb-0">二手商城</h2>
                            <p style="color: #666; font-size: 0.95rem;">找尋最適合寶貝的優質用品</p>
                        </div>
                        <div class="store-search-container">
                            <i class="fas fa-search store-search-icon"></i>
                            <input type="text" class="store-search-input" placeholder="搜尋商品（例如：貓砂盆、寵物推車...）">
                        </div>
                    </div>

                    <div class="category-tabs">
                        <div class="category-pill active">全部商品</div>
                        <div class="category-pill">貓貓用品</div>
                        <div class="category-pill">狗狗用品</div>
                        <div class="category-pill">外出籠/包</div>
                        <div class="category-pill">服飾/配件</div>
                        <div class="category-pill">清潔/護理</div>
                        <div class="category-pill">罐頭/零食</div>
                        <div class="category-pill">保健食品</div>
                    </div>
                </div>

                <div>
                    <div class="d-flex justify-between align-center mb-3">
                        <div style="font-size: 0.95rem; color: #666;">
                            共 <span style="font-weight:700; color:var(--text-color);">120</span> 項商品
                        </div>
                        <div class="d-flex align-center gap-sm">
                            <span style="font-size:0.9rem; color:#888;">排序：</span>
                            <select class="filter-select"
                                style="border:1px solid #eee; padding: 0.3rem 0.8rem; font-size:0.9rem;">
                                <option>最新上架</option>
                                <option>價格: 低到高</option>
                                <option>價格: 高到低</option>
                            </select>
                        </div>
                    </div>
                    <div class="store-grid" id="product-list">
                        <!-- JS Generated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bundle View (Hidden by default) -->
    <div id="bundle-view" style="display: none; padding-bottom: 4rem;">
        <div class="container" style="margin-top: 2rem;">
            <!-- Header Row -->
            <div class="d-flex justify-between align-center mb-4">
                <h2 style="font-size: 1.5rem; color: var(--text-color); font-weight: 700;">您選擇的商品</h2>
                <button class="btn btn-outline btn-sm" onclick="backToStore()">
                    <i class="fas fa-arrow-left"></i> 返回商品列表
                </button>
            </div>

            <div class="d-flex gap-lg" style="flex-wrap: wrap; align-items: flex-start;">
                <!-- Main Content -->
                <div style="flex: 1; min-width: 300px;">
                    <div class="card d-flex gap-md mb-3" style="align-items: center;">
                        <img id="bundle-main-img" src=""
                            style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px;">
                        <div>
                            <div class="badge badge-primary mb-1">主要商品</div>
                            <h2 id="bundle-main-title" style="margin-bottom: 0.5rem;">Title</h2>
                            <h3 class="text-primary" id="bundle-main-price">$0</h3>
                            <div class="d-flex align-center gap-sm">
                                <p style="color: #666; font-size: 0.9rem; margin:0;">賣家：<span
                                        id="bundle-seller-name">陳小美</span></p>
                                <a href="javascript:void(0)"
                                    onclick="document.getElementById('reviews-section').style.display='block'; window.scrollTo(0, document.getElementById('reviews-section').offsetTop - 100);"
                                    style="color: var(--warning); font-size: 0.9rem; text-decoration: none; font-weight: 600;">
                                    4.8 ★ <span
                                        style="text-decoration: underline; color: #999; font-weight: normal; font-size: 0.8rem;">(查看評價)</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Reviews Section (Collapsible) -->
                    <div id="reviews-section"
                        style="display:none; background: #fff; padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; border: 1px solid #eee; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
                        <div class="d-flex justify-between align-center mb-2">
                            <h3 style="font-size: 1.1rem; margin:0;">賣家評價 <span
                                    style="font-size: 0.9rem; color: #999; font-weight: normal;">(12則)</span></h3>
                            <button onclick="document.getElementById('reviews-section').style.display='none'"
                                style="background:none; border:none; color:#999; cursor:pointer; font-size: 1.5rem; line-height: 1;">&times;</button>
                        </div>

                        <div class="reviews-scroll-container">
                            <!-- Review 1 -->
                            <div class="review-item">
                                <div class="d-flex justify-between align-center mb-1">
                                    <div class="d-flex align-center gap-sm">
                                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User1" class="avatar"
                                            style="width:32px; height:32px;">
                                        <div>
                                            <div style="font-size: 0.9rem; font-weight: 600; line-height: 1.2;">林**
                                            </div>
                                            <div style="font-size: 0.75rem; color: #bbb;">2024-01-02</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div style="color: var(--warning); font-size: 0.8rem; margin-bottom: 2px;">★★★★★
                                        </div>
                                        <button class="btn-report" onclick="openReportModal('Review #R-102')"
                                            title="檢舉">檢舉
                                            <i class="fas fa-flag"></i>
                                        </button>
                                    </div>
                                </div>
                                <p style="color: #555; font-size: 0.9rem; line-height: 1.5; margin: 0;">商品包裝很完整，寄件速度快！
                                </p>
                            </div>

                            <!-- Review 2 -->
                            <div class="review-item">
                                <div class="d-flex justify-between align-center mb-1">
                                    <div class="d-flex align-center gap-sm">
                                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User2" class="avatar"
                                            style="width:32px; height:32px;">
                                        <div>
                                            <div style="font-size: 0.9rem; font-weight: 600; line-height: 1.2;">王**
                                            </div>
                                            <div style="font-size: 0.75rem; color: #bbb;">2023-12-28</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div style="color: var(--warning); font-size: 0.8rem; margin-bottom: 2px;">★★★★☆
                                        </div>
                                        <button class="btn-report" onclick="openReportModal('Review #R-103')"
                                            title="檢舉">檢舉
                                            <i class="fas fa-flag"></i>
                                        </button>
                                    </div>
                                </div>
                                <p style="color: #555; font-size: 0.9rem; line-height: 1.5; margin: 0;">東西跟照片一樣，很喜歡。</p>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--secondary-color); padding: 1.5rem; border-radius: 16px;">
                        <h3 class="mb-2">同賣家其他好物 <span style="font-size: 0.9rem; font-weight: normal;">(一起帶省運費！)</span>
                        </h3>
                        <div class="addons-scroll-container">

                            <!-- Mock Add-on 1 -->
                            <div class="card addon-card" onclick="toggleAddon(this, 150)">
                                <img src="https://images.unsplash.com/photo-1576201836106-db1758fd1c97?w=500&q=80"
                                    style="height: 100px; width: 100%; object-fit: cover; border-radius: 8px;">
                                <h4
                                    style="font-size: 0.95rem; margin: 0.5rem 0 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    寵物指甲剪</h4>
                                <p class="text-primary" style="font-weight: 700; font-size: 1rem;">$150</p>
                                <div class="addon-check">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>

                            <!-- Mock Add-on 2 -->
                            <div class="card addon-card" onclick="toggleAddon(this, 300)">
                                <img src="https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=500&q=80"
                                    style="height: 100px; width: 100%; object-fit: cover; border-radius: 8px;">
                                <h4
                                    style="font-size: 0.95rem; margin: 0.5rem 0 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    外出便攜碗</h4>
                                <p class="text-primary" style="font-weight: 700; font-size: 1rem;">$300</p>
                                <div class="addon-check">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>

                            <!-- Mock Add-on 3 -->
                            <div class="card addon-card" onclick="toggleAddon(this, 50)">
                                <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=500&q=80"
                                    style="height: 100px; width: 100%; object-fit: cover; border-radius: 8px;">
                                <h4
                                    style="font-size: 0.95rem; margin: 0.5rem 0 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    逗貓棒</h4>
                                <p class="text-primary" style="font-weight: 700; font-size: 1rem;">$50</p>
                                <div class="addon-check">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

                <!-- Checkout Sidebar (Floating) -->
                <div style="flex: 0 0 300px; min-width: 300px; position: sticky; top: 5rem; margin-left:20px;">
                    <div class="card">
                        <h3 class="mb-2">組合結帳清單</h3>
                        <div id="bundle-items-list" style="margin-bottom: 2rem;">
                            <!-- JS Generated Items -->
                        </div>

                        <div style="border-top: 1px solid #eee; padding-top: 1rem;">
                            <div class="d-flex justify-between mb-1">
                                <span>商品小計</span>
                                <span class="bundle-subtotal">$0</span>
                            </div>
                            <div class="d-flex justify-between mb-1">
                                <span>運費</span>
                                <span>$60</span>
                            </div>
                            <div class="d-flex justify-between mb-2">
                                <span style="font-weight: 700; color: var(--primary-color);">運費優惠</span>
                                <span style="color: var(--success);">- $60</span>
                            </div>
                            <div class="d-flex justify-between mb-2" style="font-size: 1.2rem; font-weight: 800;">
                                <span>總金額</span>
                                <span class="bundle-total">$0</span>
                            </div>
                            <button class="btn btn-primary" onclick="alert('進入結帳流程！')"
                                style="width: 100%; height: 50px; font-size: 1.1rem;">立即結帳</button>
                        </div>
                    </div>
                    <p class="text-center mt-2" style="color: #999; font-size: 0.9rem;">
                        <i class="fas fa-shield-alt"></i> 寵護家保障交易安全
                    </p>
                </div>

            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:white; padding:2rem; border-radius:1rem; width:90%; max-width:400px; position:relative;">
            <button onclick="document.getElementById('reportModal').style.display='none'"
                style="position:absolute; right:1rem; top:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3 class="mb-2">⚠️ 檢舉評價</h3>
            <p class="mb-2" style="color:#666; font-size:0.9rem;">檢舉編號：<span id="reportTargetId"></span></p>
            <form onsubmit="submitReport(event)">
                <div class="form-group">
                    <label class="form-label">檢舉原因</label>
                    <select class="form-control" required>
                        <option value="">請選擇原因...</option>
                        <option>廣告訊息</option>
                        <option>人身攻擊 / 不雅字眼</option>
                        <option>與商品無關</option>
                        <option>其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">詳細說明 (選填)</label>
                    <textarea class="form-control" rows="3"></textarea>
                </div>
                <button class="btn btn-primary" style="width:100%; background: var(--danger);">提交檢舉</button>
            </form>
        </div>
    </div>

    <footer id="main-footer" style="background-color: #f9f9f9; margin-top: 4rem;"></footer>

    <script src="../static/js/main.js"></script>
    <script>
        // --- Data Definitions ---
        let products = [
            { id: 1, title: '全新貓咪自動餵食器', price: 1200, category: '貓貓用品', time: '5分前', img: 'https://images.unsplash.com/photo-1583337130417-3346a1be7dee?auto=format&fit=crop&q=80&w=400', seller: '李小明', condition: '全新' },
            { id: 2, title: '寵物外出摺疊碗', price: 150, category: '外出籠/包', time: '2時前', img: 'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?auto=format&fit=crop&q=80&w=400', seller: '李小明', condition: '九成新' },
            { id: 3, title: '大型犬舒適睡墊', price: 800, category: '貓貓用品', time: '1天前', img: 'https://images.unsplash.com/photo-1520038410233-7141dd782f08?auto=format&fit=crop&q=80&w=400', seller: '李小明', condition: '全新' },
            { id: 4, title: '狗狗雨衣 (M號)', price: 250, category: '服飾/配件', time: '2天前', img: 'https://images.unsplash.com/photo-1545249390-6bdfa2aeb167?auto=format&fit=crop&q=80&w=400', seller: '李小明', condition: '八成新' },
            { id: 5, title: '貓咪耐抓板', price: 300, category: '貓貓用品', time: '3天前', img: 'https://images.unsplash.com/photo-1535295972055-1c762f4483e5?auto=format&fit=crop&q=80&w=400', seller: '李小明', condition: '全新' },
            { id: 6, title: '太空艙寵物背包', price: 850, category: '外出籠/包', time: '1週前', img: 'https://images.unsplash.com/photo-1591871937573-74dbba515c4c?auto=format&fit=crop&q=80&w=400', seller: '李小明', condition: '九成新' }
        ];

        let currentCategory = '全部商品';
        let searchQuery = '';
        let sortMethod = '最新上架';

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts();

            // Sync Search Input
            document.querySelector('.store-search-input').addEventListener('input', (e) => {
                searchQuery = e.target.value;
                renderProducts();
            });

            // Sync Category Tabs
            document.querySelectorAll('.category-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    currentCategory = pill.innerText;
                    renderProducts();
                });
            });

            // Sync Sort Select
            const sortSelect = document.querySelector('.filter-select');
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    sortMethod = e.target.value;
                    renderProducts();
                });
            }
        });

        // --- Buyer Rendering ---
        function renderProducts() {
            const container = document.getElementById('product-list');
            if (!container) return;

            // Filtering
            let filtered = products.filter(p => {
                const matchesCategory = currentCategory === '全部商品' || p.category === currentCategory;
                const matchesSearch = p.title.toLowerCase().includes(searchQuery.toLowerCase());
                return matchesCategory && matchesSearch;
            });

            // Sorting
            if (sortMethod === '價格: 低到高') filtered.sort((a, b) => a.price - b.price);
            if (sortMethod === '價格: 高到低') filtered.sort((a, b) => b.price - a.price);

            container.innerHTML = filtered.map(p => `
                <div class="store-product-card">
                    <div style="position: relative;">
                        <img src="${p.img}" class="store-product-img">
                        <button class="btn-like" onclick="window.toggleFavorite(this)">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                    <div class="store-product-body">
                        <div class="store-product-meta">
                            <span class="badge badge-accent">${p.category}</span>
                            <span>${p.time}</span>
                        </div>
                        <h3 class="store-product-title">${p.title}</h3>
                        <div class="d-flex justify-between align-center mt-auto">
                            <span class="store-product-price">$${p.price.toLocaleString()}</span>
                            <button class="btn btn-primary btn-sm"
                                onclick="openBundleView(this, '${p.title}', '$${p.price}', '${p.img}')">購買</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Update Count
            const countEl = document.querySelector('.mb-3 span[style*="font-weight:700"]');
            if (countEl) countEl.innerText = filtered.length;
        }

        // --- Bundle Logic ---
        let currentBundle = { main: null, addons: [] };

        function openBundleView(btn, title, price, img) {
            document.getElementById('store-views').style.display = 'none';
            document.getElementById('bundle-view').style.display = 'block';
            window.scrollTo(0, 0);

            document.getElementById('bundle-main-title').innerText = title;
            document.getElementById('bundle-main-price').innerText = price;
            document.getElementById('bundle-main-img').src = img;

            currentBundle.main = {
                title: title,
                price: parseInt(price.replace(/[^0-9]/g, ''))
            };
            currentBundle.addons = [];

            document.querySelectorAll('.addon-card').forEach(card => {
                card.style.borderColor = 'transparent';
                card.querySelector('.addon-check').style.display = 'none';
            });

            updateBundleSummary();
        }

        function backToStore() {
            document.getElementById('bundle-view').style.display = 'none';
            document.getElementById('store-views').style.display = 'block';
        }

        function toggleAddon(card, price) {
            const isSelected = card.style.borderColor === 'var(--primary-color)';
            const title = card.querySelector('h4').innerText;

            if (isSelected) {
                card.style.borderColor = 'transparent';
                card.querySelector('.addon-check').style.display = 'none';
                currentBundle.addons = currentBundle.addons.filter(i => i.title !== title);
            } else {
                card.style.borderColor = 'var(--primary-color)';
                card.querySelector('.addon-check').style.display = 'flex';
                currentBundle.addons.push({ title: title, price: price });
            }
            updateBundleSummary();
        }

        function updateBundleSummary() {
            const listEl = document.getElementById('bundle-items-list');
            listEl.innerHTML = '';

            let total = currentBundle.main.price;
            listEl.innerHTML += `
                <div class="d-flex justify-between mb-1" style="font-size:0.9rem;">
                    <span><b>主商品：</b>${currentBundle.main.title}</span>
                    <span>$${currentBundle.main.price.toLocaleString()}</span>
                </div>
            `;

            currentBundle.addons.forEach(addon => {
                total += addon.price;
                listEl.innerHTML += `
                    <div class="d-flex justify-between mb-1" style="font-size:0.9rem;">
                        <span><b style="color:var(--primary-color);">+ 加購：</b>${addon.title}</span>
                        <span>$${addon.price.toLocaleString()}</span>
                    </div>
                `;
            });

            document.querySelector('.bundle-subtotal').innerText = '$' + total.toLocaleString();
            document.querySelector('.bundle-total').innerText = '$' + total.toLocaleString();
        }
    </script>
</body>

</html>